{% extends 'layouts/dashboard.html' %}
{% load static %}

{% block title %}Novo Pedido - Pizzaria{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pedidos-simples.css' %}?v=3.0">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6" x-data="pedidoForm()">
    
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-primary">Novo Pedido</h1>
        <p class="text-secondary mt-1">Adicione produtos e finalize o pedido</p>
    </div>
    
    <!-- Layout Principal -->
    <div class="layout-produtos flex flex-col lg:flex-row gap-6">
        
        <!-- √Årea de Produtos -->
        <div class="flex-1">
            
            <!-- Tipo de Pedido Simplificado -->
            <div class="bg-white rounded-lg shadow-sm p-4 mb-4 border border-gray-200">
                <h3 class="text-sm font-semibold text-gray-700 mb-3">üöö COMO RECEBER?</h3>
                
                <div class="grid grid-cols-3 gap-2">
                    <!-- Delivery -->
                    <label class="cursor-pointer">
                        <input type="radio" name="tipo_pedido" value="delivery" x-model="tipoPedido" class="hidden">
                        <div class="text-center py-3 px-2 rounded-lg border-2 transition-all"
                             :class="tipoPedido === 'delivery' ? 'border-orange-500 bg-orange-50' : 'border-gray-300 hover:border-gray-400'">
                            <span class="text-2xl block mb-1">üöö</span>
                            <span class="text-sm font-medium block">Delivery</span>
                            <span class="text-xs text-orange-600">R$ 5,00</span>
                        </div>
                    </label>
                    
                    <!-- Balc√£o -->
                    <label class="cursor-pointer">
                        <input type="radio" name="tipo_pedido" value="balcao" x-model="tipoPedido" class="hidden">
                        <div class="text-center py-3 px-2 rounded-lg border-2 transition-all"
                             :class="tipoPedido === 'balcao' ? 'border-orange-500 bg-orange-50' : 'border-gray-300 hover:border-gray-400'">
                            <span class="text-2xl block mb-1">üè™</span>
                            <span class="text-sm font-medium block">Balc√£o</span>
                            <span class="text-xs text-green-600">Sem taxa</span>
                        </div>
                    </label>
                    
                    <!-- Mesa -->
                    <label class="cursor-pointer">
                        <input type="radio" name="tipo_pedido" value="mesa" x-model="tipoPedido" class="hidden">
                        <div class="text-center py-3 px-2 rounded-lg border-2 transition-all"
                             :class="tipoPedido === 'mesa' ? 'border-orange-500 bg-orange-50' : 'border-gray-300 hover:border-gray-400'">
                            <span class="text-2xl block mb-1">üçΩÔ∏è</span>
                            <span class="text-sm font-medium block">Mesa</span>
                            <span class="text-xs text-purple-600">No local</span>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Formul√°rio de Cliente Simplificado -->
            {% include 'pedidos/components/form_cliente_simples.html' %}
            
            <!-- Forma de Pagamento Simplificada -->
            <div class="bg-white rounded-lg shadow-sm p-4 mb-4 border border-gray-200">
                <h3 class="text-sm font-semibold text-gray-700 mb-3">üí≥ PAGAMENTO</h3>
                
                <div class="grid grid-cols-4 gap-2">
                    <!-- Dinheiro -->
                    <label class="cursor-pointer">
                        <input type="radio" name="forma_pagamento" value="dinheiro" x-model="formaPagamento" class="hidden">
                        <div class="text-center py-3 px-2 rounded-lg border-2 transition-all"
                             :class="formaPagamento === 'dinheiro' ? 'border-green-500 bg-green-50' : 'border-gray-300 hover:border-gray-400'">
                            <span class="text-2xl block mb-1">üí∞</span>
                            <span class="text-xs font-medium">Dinheiro</span>
                        </div>
                    </label>
                    
                    <!-- PIX -->
                    <label class="cursor-pointer">
                        <input type="radio" name="forma_pagamento" value="pix" x-model="formaPagamento" class="hidden">
                        <div class="text-center py-3 px-2 rounded-lg border-2 transition-all"
                             :class="formaPagamento === 'pix' ? 'border-green-500 bg-green-50' : 'border-gray-300 hover:border-gray-400'">
                            <span class="text-2xl block mb-1">üì±</span>
                            <span class="text-xs font-medium">PIX</span>
                        </div>
                    </label>
                    
                    <!-- Cr√©dito -->
                    <label class="cursor-pointer">
                        <input type="radio" name="forma_pagamento" value="cartao_credito" x-model="formaPagamento" class="hidden">
                        <div class="text-center py-3 px-2 rounded-lg border-2 transition-all"
                             :class="formaPagamento === 'cartao_credito' ? 'border-green-500 bg-green-50' : 'border-gray-300 hover:border-gray-400'">
                            <span class="text-2xl block mb-1">üí≥</span>
                            <span class="text-xs font-medium">Cr√©dito</span>
                        </div>
                    </label>
                    
                    <!-- D√©bito -->
                    <label class="cursor-pointer">
                        <input type="radio" name="forma_pagamento" value="cartao_debito" x-model="formaPagamento" class="hidden">
                        <div class="text-center py-3 px-2 rounded-lg border-2 transition-all"
                             :class="formaPagamento === 'cartao_debito' ? 'border-green-500 bg-green-50' : 'border-gray-300 hover:border-gray-400'">
                            <span class="text-2xl block mb-1">üí≥</span>
                            <span class="text-xs font-medium">D√©bito</span>
                        </div>
                    </label>
                </div>
                
                <!-- Troco simplificado -->
                <div x-show="formaPagamento === 'dinheiro'" x-transition class="mt-3">
                    <input type="number" 
                           id="troco_para" 
                           name="troco_para"
                           x-model="trocoPara"
                           step="0.01"
                           placeholder="Precisa de troco? Digite o valor (ex: 50,00)"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                </div>
            </div>
            
            <!-- Se√ß√£o de Produtos Simplificada -->
            <div class="bg-white rounded-lg shadow-sm p-4 mb-4 border border-gray-200">
                <h3 class="text-sm font-semibold text-gray-700 mb-3">üçï PRODUTOS</h3>
                
                <!-- Abas de Categorias Compactas -->
                <div class="flex gap-1 mb-3 border-b border-gray-200">
                    <template x-for="(produtos, categoria) in produtosPorCategoria" :key="categoria">
                        <button type="button"
                                @click="categoriaAtiva = categoria"
                                class="px-3 py-2 text-sm font-medium transition-all border-b-2"
                                :class="categoriaAtiva === categoria ? 
                                        'text-orange-600 border-orange-600' : 
                                        'text-gray-500 border-transparent hover:text-gray-700'">
                            <span x-text="categoria === 'pizzas' ? 'üçï Pizzas' : (categoria === 'bebidas' ? 'ü•§ Bebidas' : '‚≠ï Bordas')"></span>
                            <span class="text-xs" x-text="'(' + produtos.length + ')'">
                            </span>
                        </button>
                    </template>
                </div>
                
                
                <!-- Lista de Produtos Compacta -->
                <div class="produtos-container max-h-96 overflow-y-auto border border-gray-200 rounded-lg">
                    <template x-if="produtosFiltrados.length > 0">
                        <div>
                            <template x-for="produto in produtosFiltrados" :key="produto.id">
                                <div>
                                    <!-- Pizza Lista -->
                                    <template x-if="categoriaAtiva === 'pizzas'">
                                        {% include 'pedidos/components/pizza_lista.html' %}
                                    </template>
                                    
                                    <!-- Produto Simples Lista -->
                                    <template x-if="categoriaAtiva !== 'pizzas'">
                                        {% include 'pedidos/components/produto_lista.html' %}
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                    
                    <!-- Estado vazio -->
                    <template x-if="produtosFiltrados.length === 0">
                        <div class="text-center py-8">
                            <p class="text-gray-500 text-sm">Nenhum produto nesta categoria</p>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Observa√ß√µes Simplificadas -->
            <div class="bg-white rounded-lg shadow-sm p-4 mb-4 border border-gray-200">
                <textarea id="observacoes" 
                          name="observacoes"
                          rows="2"
                          x-model="observacoes"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                          placeholder="Observa√ß√µes do pedido (opcional)..."></textarea>
            </div>
            
        </div>
        
        <!-- Carrinho Lateral Simplificado -->
        <div class="lg:w-96">
            {% include 'pedidos/components/carrinho_simples.html' %}
        </div>
        
    </div>
    
    <!-- Modal Meio a Meio -->
<div x-show="modalMeioAMeioMostrar" 
     x-cloak
     class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50"
     @click.self="fecharModalMeioAMeio()">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        
        <!-- Header -->
        <div class="bg-gradient-to-r from-orange-500 to-red-600 text-white p-4">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold">üçï Monte sua Pizza Meio a Meio</h3>
                <button @click="fecharModalMeioAMeio()" class="text-white hover:bg-white hover:bg-opacity-20 rounded p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="p-6">
            <!-- Sele√ß√£o de Sabores -->
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                
                <!-- Sabor 1 -->
                <div class="border-2 border-gray-200 rounded-lg p-4">
                    <h4 class="text-lg font-semibold mb-3 text-orange-600">1¬∫ Sabor</h4>
                    <div class="space-y-2 max-h-64 overflow-y-auto">
                        <template x-for="pizza in produtosPorCategoria.pizzas" :key="'sabor1_' + pizza.id">
                            <div class="cursor-pointer border rounded-lg p-3 transition-all"
                                 :class="modalMeioAMeioSabor1?.id === pizza.id ? 'border-orange-500 bg-orange-50' : 'border-gray-200 hover:border-gray-300'"
                                 @click="selecionarSabor1(pizza)">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üçï</span>
                                    <div class="flex-1">
                                        <h5 class="font-medium" x-text="pizza.nome"></h5>
                                        <p class="text-sm text-gray-600" x-text="pizza.descricao"></p>
                                    </div>
                                    <div x-show="modalMeioAMeioSabor1?.id === pizza.id" class="text-orange-500">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Sabor 2 -->
                <div class="border-2 border-gray-200 rounded-lg p-4">
                    <h4 class="text-lg font-semibold mb-3 text-red-600">2¬∫ Sabor</h4>
                    <div class="space-y-2 max-h-64 overflow-y-auto">
                        <template x-for="pizza in produtosPorCategoria.pizzas" :key="'sabor2_' + pizza.id">
                            <div class="cursor-pointer border rounded-lg p-3 transition-all"
                                 :class="modalMeioAMeioSabor2?.id === pizza.id ? 'border-red-500 bg-red-50' : 'border-gray-200 hover:border-gray-300'"
                                 @click="selecionarSabor2(pizza)"
                                 x-show="pizza.id !== modalMeioAMeioSabor1?.id">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üçï</span>
                                    <div class="flex-1">
                                        <h5 class="font-medium" x-text="pizza.nome"></h5>
                                        <p class="text-sm text-gray-600" x-text="pizza.descricao"></p>
                                    </div>
                                    <div x-show="modalMeioAMeioSabor2?.id === pizza.id" class="text-red-500">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            
            <!-- Sele√ß√£o de Tamanho -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold mb-3">Tamanho</h4>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <template x-for="tamanho in modalMeioAMeioSabor1?.tamanhos || []" :key="'tamanho_' + tamanho.id">
                        <div class="cursor-pointer border-2 rounded-lg p-3 text-center transition-all"
                             :class="modalMeioAMeioTamanho?.id === tamanho.id ? 'border-green-500 bg-green-50' : 'border-gray-200 hover:border-gray-300'"
                             @click="selecionarTamanhoMeioAMeio(tamanho)">
                            <div class="text-sm font-medium" x-text="tamanho.nome"></div>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Regra de Pre√ßo -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold mb-3">Regra de Pre√ßo</h4>
                <div class="space-y-2">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="radio" x-model="modalMeioAMeioRegra" value="mais_caro" @change="calcularPrecoMeioAMeio()" class="text-orange-500">
                        <span class="font-medium">Pre√ßo do sabor mais caro</span>
                        <span class="text-sm text-gray-600">(Recomendado)</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="radio" x-model="modalMeioAMeioRegra" value="media" @change="calcularPrecoMeioAMeio()" class="text-orange-500">
                        <span class="font-medium">M√©dia dos dois pre√ßos</span>
                        <span class="text-sm text-green-600" x-show="modalMeioAMeioEconomia > 0">
                            (Economia de R$ <span x-text="modalMeioAMeioEconomia.toFixed(2)"></span>)
                        </span>
                    </label>
                </div>
            </div>
            
            <!-- Resumo -->
            <div x-show="modalMeioAMeioSabor1 && modalMeioAMeioSabor2 && modalMeioAMeioTamanho" 
                 class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg p-4 mb-6">
                <h4 class="text-lg font-semibold mb-3">Resumo da Pizza</h4>
                <div class="space-y-2">
                    <p><strong>Sabores:</strong> 
                        <span x-text="modalMeioAMeioSabor1?.nome"></span> + 
                        <span x-text="modalMeioAMeioSabor2?.nome"></span>
                    </p>
                    <p><strong>Tamanho:</strong> <span x-text="modalMeioAMeioTamanho?.nome"></span></p>
                    <p class="text-xl font-bold text-green-600">
                        <strong>Total: R$ <span x-text="modalMeioAMeioPreco.toFixed(2)"></span></strong>
                    </p>
                </div>
            </div>
            
            <!-- Bot√µes -->
            <div class="flex gap-3">
                <button @click="fecharModalMeioAMeio()" 
                        class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium">
                    Cancelar
                </button>
                <button @click="adicionarMeioAMeioAoCarrinho()" 
                        :disabled="!modalMeioAMeioSabor1 || !modalMeioAMeioSabor2 || !modalMeioAMeioTamanho"
                        :class="{
                            'bg-gradient-to-r from-orange-500 to-red-600 text-white hover:from-orange-600 hover:to-red-700': modalMeioAMeioSabor1 && modalMeioAMeioSabor2 && modalMeioAMeioTamanho,
                            'bg-gray-300 text-gray-500 cursor-not-allowed': !modalMeioAMeioSabor1 || !modalMeioAMeioSabor2 || !modalMeioAMeioTamanho
                        }"
                        class="flex-1 py-3 rounded-lg font-medium transition-all">
                    üçï Adicionar ao Carrinho
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o Simplificado -->
<div x-show="mostrarModalConfirmacao" 
     x-cloak
     class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50"
     @click.self="mostrarModalConfirmacao = false">
    <div class="bg-white rounded-lg p-4 max-w-sm w-full">
        <h3 class="text-base font-semibold mb-3">Confirmar Pedido?</h3>
        
        <div class="bg-gray-50 rounded p-3 mb-4 text-sm space-y-1">
            <p><strong>Total:</strong> R$ <span x-text="total.toFixed(2).replace('.', ',')"></span></p>
            <p><strong>Pagamento:</strong> <span x-text="formaPagamento"></span></p>
            <p x-show="tipoPedido === 'delivery'"><strong>Entrega:</strong> <span x-text="cliente.endereco_simples"></span></p>
        </div>
        
        <div class="flex gap-2">
            <button @click="mostrarModalConfirmacao = false"
                    class="flex-1 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                Cancelar
            </button>
            <button @click="finalizarPedido()"
                    class="flex-1 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">
                Confirmar
            </button>
        </div>
    </div>
</div>

</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/pedidos-simples.js' %}"></script>
{% endblock %}