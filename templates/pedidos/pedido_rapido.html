{% extends 'layouts/dashboard.html' %}
{% load static %}

{% block title %}Novo Pedido R√°pido - Pizzaria{% endblock %}

{% block extra_css %}
<style>
    /* Layout principal */
    .pedido-rapido {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 1.5rem;
        height: calc(100vh - 200px);
    }
    
    /* √Årea de busca e produtos */
    .produtos-area {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    /* Busca instant√¢nea */
    .busca-rapida {
        position: relative;
    }
    
    .busca-input {
        width: 100%;
        padding: 1rem 3rem 1rem 1rem;
        font-size: 1.125rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        transition: all 0.2s;
    }
    
    .busca-input:focus {
        outline: none;
        border-color: #DC2626;
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }
    
    .busca-icon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
    }
    
    /* Filtros r√°pidos */
    .filtros-rapidos {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .filtro-chip {
        padding: 0.5rem 1rem;
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 9999px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
    }
    
    .filtro-chip:hover {
        background: #e5e7eb;
    }
    
    .filtro-chip.ativo {
        background: #DC2626;
        color: white;
        border-color: #DC2626;
    }
    
    /* Lista de produtos */
    .produtos-lista {
        flex: 1;
        overflow-y: auto;
        padding-right: 0.5rem;
    }
    
    .produto-card {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        margin-bottom: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .produto-card:hover {
        border-color: #DC2626;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .produto-imagem {
        width: 80px;
        height: 80px;
        background: #f3f4f6;
        border-radius: 0.375rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
    }
    
    .produto-info {
        flex: 1;
    }
    
    .produto-nome {
        font-weight: 600;
        color: #111827;
        margin-bottom: 0.25rem;
    }
    
    .produto-descricao {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
    }
    
    .produto-precos {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .preco-opcao {
        padding: 0.25rem 0.75rem;
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .preco-opcao:hover {
        background: #DC2626;
        color: white;
        border-color: #DC2626;
    }
    
    /* Bot√£o Meio a Meio - Estados */
    .meio-a-meio-btn {
        background: #FEF3C7 !important;
        border-color: #F59E0B !important;
        color: #92400E !important;
        font-weight: 600;
        position: relative;
    }
    
    .meio-a-meio-btn:hover {
        background: #FDE68A !important;
        border-color: #F59E0B !important;
        color: #78350F !important;
    }
    
    .meio-a-meio-btn.primeiro-sabor {
        background: #DBEAFE !important;
        border-color: #3B82F6 !important;
        color: #1E40AF !important;
    }
    
    .meio-a-meio-btn.primeiro-sabor:hover {
        background: #BFDBFE !important;
        border-color: #2563EB !important;
        color: #1D4ED8 !important;
    }
    
    .meio-a-meio-btn.opcao-segundo {
        background: #FEE2E2 !important;
        border-color: #EF4444 !important;
        color: #DC2626 !important;
        animation: pulse-meio-a-meio 1.5s infinite;
    }
    
    .meio-a-meio-btn.opcao-segundo:hover {
        background: #FECACA !important;
        border-color: #DC2626 !important;
        color: #B91C1C !important;
    }
    
    /* Anima√ß√£o para op√ß√µes de segundo sabor */
    @keyframes pulse-meio-a-meio {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
        }
        50% {
            transform: scale(1.02);
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2);
        }
    }
    
    /* Estados para bot√µes de pre√ßo com tamanho */
    .preco-opcao.primeiro-sabor-tamanho {
        background: #DBEAFE !important;
        border-color: #3B82F6 !important;
        color: #1E40AF !important;
        font-weight: 600;
        position: relative;
    }
    
    .preco-opcao.primeiro-sabor-tamanho:hover {
        background: #BFDBFE !important;
        border-color: #2563EB !important;
        color: #1D4ED8 !important;
    }
    
    .preco-opcao.opcao-segundo-tamanho {
        background: #FEE2E2 !important;
        border-color: #EF4444 !important;
        color: #DC2626 !important;
        font-weight: 600;
        animation: pulse-meio-a-meio 1.5s infinite;
    }
    
    .preco-opcao.opcao-segundo-tamanho:hover {
        background: #FECACA !important;
        border-color: #DC2626 !important;
        color: #B91C1C !important;
    }
    
    /* Bot√£o meio a meio opcional (menos proeminente) */
    .meio-a-meio-btn-opcional {
        background: #F3F4F6 !important;
        border-color: #D1D5DB !important;
        color: #6B7280 !important;
        font-size: 0.75rem;
        opacity: 0.7;
        transition: all 0.2s;
    }
    
    .meio-a-meio-btn-opcional:hover {
        background: #FEF3C7 !important;
        border-color: #F59E0B !important;
        color: #92400E !important;
        opacity: 1;
    }
    
    /* Carrinho lateral compacto */
    .carrinho-area {
        display: flex;
        flex-direction: column;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        overflow: hidden;
        height: calc(100vh - 200px);
    }
    
    /* Header novo com total */
    .carrinho-header-novo {
        padding: 0.75rem 1rem;
        background: #DC2626;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    /* Dados do pedido fixos no topo */
    .dados-pedido-compacto {
        padding: 0.75rem;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .campo-compacto {
        margin-bottom: 0.75rem;
    }
    
    .campo-compacto:last-child {
        margin-bottom: 0;
    }
    
    /* Bot√µes compactos */
    .opcao-btn-compacto {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.125rem;
        padding: 0.375rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .opcao-btn-compacto:hover {
        background: #f3f4f6;
    }
    
    .opcao-btn-compacto.selecionado {
        background: #DC2626;
        color: white;
        border-color: #DC2626;
    }
    
    /* Input compacto */
    .input-compacto {
        padding: 0.375rem 0.5rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.25rem;
        font-size: 0.75rem;
    }
    
    .input-compacto:focus {
        outline: none;
        border-color: #DC2626;
        box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.1);
    }
    
    /* Lista de itens scroll√°vel */
    .carrinho-itens-scroll {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
        min-height: 150px;
    }
    
    /* Item compacto */
    .item-compacto {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 0.5rem;
        background: #f9fafb;
        border-radius: 0.375rem;
        margin-bottom: 0.375rem;
    }
    
    .item-info-compacto {
        flex: 1;
        min-width: 0;
        margin-right: 0.5rem;
    }
    
    .item-acoes-compacto {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .btn-qty-compacto {
        width: 20px;
        height: 20px;
        border: 1px solid #e5e7eb;
        background: white;
        border-radius: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.75rem;
    }
    
    .btn-qty-compacto:hover {
        background: #f3f4f6;
    }
    
    .qty-compacto {
        font-weight: 500;
        min-width: 16px;
        text-align: center;
        font-size: 0.75rem;
    }
    
    .btn-remove-compacto {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.25rem;
        line-height: 1;
        color: #ef4444;
    }
    
    /* Footer compacto */
    .carrinho-footer-compacto {
        padding: 0.75rem;
        background: #f9fafb;
        border-top: 1px solid #e5e7eb;
    }
    
    .resumo-compacto {
        margin-bottom: 0.75rem;
        font-size: 0.875rem;
    }
    
    .btn-finalizar-compacto {
        width: 100%;
        padding: 0.75rem;
        background: #DC2626;
        color: white;
        border: none;
        border-radius: 0.375rem;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-finalizar-compacto:hover:not(:disabled) {
        background: #b91c1c;
    }
    
    .btn-finalizar-compacto:disabled {
        background: #e5e7eb;
        color: #9ca3af;
        cursor: not-allowed;
    }
    
    /* Modal r√°pido de pizza meio a meio */
    .modal-rapido {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
    }
    
    .modal-content {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    /* Responsivo */
    @media (max-width: 1024px) {
        .pedido-rapido {
            grid-template-columns: 1fr;
            height: auto;
        }
        
        .carrinho-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60vh;
            z-index: 30;
            border-radius: 1rem 1rem 0 0;
            box-shadow: 0 -4px 6px rgba(0,0,0,0.1);
        }
    }
</style>
{% endblock %}

{% block content %}
<div x-data="pedidoRapido()">
    {% csrf_token %}
    
    <!-- Header -->
    <div class="mb-4">
        <h1 class="text-2xl font-bold text-gray-800">Novo Pedido R√°pido</h1>
        <p class="text-gray-600">Busque e adicione produtos instantaneamente</p>
    </div>
    
    <!-- Layout Principal -->
    <div class="pedido-rapido">
        
        <!-- √Årea de Produtos -->
        <div class="produtos-area">
            
            <!-- Busca Instant√¢nea -->
            <div class="busca-rapida">
                <input type="text" 
                       x-model="busca"
                       @input="buscarProdutos()"
                       placeholder="üîç Buscar pizza, bebida ou produto..."
                       class="busca-input"
                       autofocus>
                <svg class="busca-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            
            <!-- Filtros R√°pidos -->
            <div class="filtros-rapidos">
                <button @click="filtroCategoria = ''; buscarProdutos()" 
                        class="filtro-chip" 
                        :class="{'ativo': filtroCategoria === ''}">
                    Todos
                </button>
                <button @click="filtroCategoria = 'pizzas'; buscarProdutos()" 
                        class="filtro-chip" 
                        :class="{'ativo': filtroCategoria === 'pizzas'}">
                    üçï Pizzas
                </button>
                <button @click="filtroCategoria = 'bebidas'; buscarProdutos()" 
                        class="filtro-chip" 
                        :class="{'ativo': filtroCategoria === 'bebidas'}">
                    ü•§ Bebidas
                </button>
                <button @click="filtroCategoria = 'bordas'; buscarProdutos()" 
                        class="filtro-chip" 
                        :class="{'ativo': filtroCategoria === 'bordas'}">
                    üßÄ Bordas
                </button>
                <button @click="filtroCategoria = 'outros'; buscarProdutos()" 
                        class="filtro-chip" 
                        :class="{'ativo': filtroCategoria === 'outros'}">
                    üçü Outros
                </button>
                <button @click="abrirModalMeioAMeio()" 
                        class="filtro-chip" 
                        style="background: #fef3c7; border-color: #f59e0b;">
                    ‚ö° Pizza Meio a Meio (Modal)
                </button>
            </div>
            
            <!-- Indicador de modo meio a meio ativo -->
            <div x-show="aguardandoSegundoSabor" 
                 class="bg-gradient-to-r from-blue-100 to-red-100 border-2 border-dashed border-blue-300 rounded-lg p-3 mt-2">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">üçï</span>
                        <div>
                            <div class="font-semibold text-blue-800">Modo Meio a Meio Ativo</div>
                            <div class="text-sm text-gray-600">
                                1¬∫ sabor: <span class="font-medium text-blue-600" x-text="primeiroSabor?.nome"></span>
                                <span x-show="primeiroSaborTamanho" class="font-medium text-blue-600">
                                    (<span x-text="primeiroSaborTamanho?.tamanho"></span>)
                                </span>
                                <span x-show="primeiroSaborTamanho" class="text-green-600"> ‚Ä¢ Clique no mesmo tamanho em outra pizza</span>
                                <span x-show="!primeiroSaborTamanho" class="text-red-600"> ‚Ä¢ Escolha o 2¬∫ sabor clicando em ¬Ω + ¬Ω</span>
                            </div>
                        </div>
                    </div>
                    <button @click="cancelarMeioAMeio()" 
                            class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded-md text-sm transition-colors">
                        Cancelar
                    </button>
                </div>
            </div>
            
            <!-- Lista de Produtos -->
            <div class="produtos-lista">
                <template x-for="produto in produtosFiltrados" :key="produto.id">
                    <div class="produto-card">
                        <div class="produto-imagem">
                            <span x-text="produto.categoria === 'pizzas' ? 'üçï' : 
                                         (produto.categoria === 'bebidas' ? 'ü•§' : 
                                         (produto.categoria === 'bordas' ? 'üßÄ' : 'üçü'))"></span>
                        </div>
                        <div class="produto-info">
                            <h3 class="produto-nome" x-text="produto.nome"></h3>
                            <p class="produto-descricao" x-text="produto.descricao || 'Delicioso produto artesanal'"></p>
                            <div class="produto-precos">
                                <!-- Pre√ßos normais -->
                                <template x-for="preco in produto.precos" :key="preco.id">
                                    <button @click="produto.categoria === 'pizzas' ? selecionarPizzaComTamanho(produto, preco) : adicionarAoCarrinho(produto, preco)"
                                            class="preco-opcao"
                                            :class="{
                                                'primeiro-sabor-tamanho': primeiroSabor?.id === produto.id && primeiroSaborTamanho?.id === preco.id,
                                                'opcao-segundo-tamanho': aguardandoSegundoSabor && primeiroSabor?.id !== produto.id && primeiroSaborTamanho?.tamanho === preco.tamanho
                                            }">
                                        <span x-text="preco.tamanho"></span> - 
                                        R$ <span x-text="preco.preco.toFixed(2).replace('.', ',')"></span>
                                        
                                        <!-- Indicadores visuais -->
                                        <span x-show="primeiroSabor?.id === produto.id && primeiroSaborTamanho?.id === preco.id" 
                                              class="ml-1 text-xs">1¬∫ ‚úì</span>
                                        <span x-show="aguardandoSegundoSabor && primeiroSabor?.id !== produto.id && primeiroSaborTamanho?.tamanho === preco.tamanho" 
                                              class="ml-1 text-xs">2¬∫ ‚Üí</span>
                                    </button>
                                </template>
                                
                                <!-- Bot√£o Meio a Meio Opcional (apenas para pizzas sem tamanho selecionado) -->
                                <button x-show="produto.categoria === 'pizzas' && !aguardandoSegundoSabor"
                                        @click="selecionarParaMeioAMeio(produto)"
                                        class="preco-opcao meio-a-meio-btn-opcional"
                                        title="Modo meio a meio sem tamanho espec√≠fico">
                                    <span class="text-xs">‚ö° Meio a Meio</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
                
                <!-- Estado vazio -->
                <div x-show="produtosFiltrados.length === 0" class="text-center py-8">
                    <p class="text-gray-500">Nenhum produto encontrado</p>
                </div>
            </div>
            
        </div>
        
        <!-- Carrinho Lateral Compacto -->
        <div class="carrinho-area">
            <!-- Header com Total -->
            <div class="carrinho-header-novo">
                <div>
                    <span class="text-white font-semibold">üõí Carrinho</span>
                    <span class="text-white text-sm opacity-90" x-text="'(' + carrinho.length + ' itens)'"></span>
                </div>
                <div class="text-white text-right">
                    <div class="text-xs opacity-90">Total</div>
                    <div class="text-lg font-bold">R$ <span x-text="total.toFixed(2).replace('.', ',')"></span></div>
                </div>
            </div>
            
            <!-- Dados do Pedido (Fixo no topo) -->
            <div class="dados-pedido-compacto">
                <!-- Tipo de pedido -->
                <div class="campo-compacto">
                    <label class="text-xs font-semibold text-gray-700 mb-1 block">Como receber?</label>
                    <div class="grid grid-cols-3 gap-1">
                        <button @click="tipoPedido = 'balcao'" 
                                class="opcao-btn-compacto" 
                                :class="{'selecionado': tipoPedido === 'balcao'}">
                            <span class="text-base">üè™</span>
                            <span class="text-xs">Balc√£o</span>
                        </button>
                        <button @click="tipoPedido = 'delivery'" 
                                class="opcao-btn-compacto" 
                                :class="{'selecionado': tipoPedido === 'delivery'}">
                            <span class="text-base">üöö</span>
                            <span class="text-xs">Delivery</span>
                        </button>
                        <button @click="tipoPedido = 'mesa'" 
                                class="opcao-btn-compacto" 
                                :class="{'selecionado': tipoPedido === 'mesa'}">
                            <span class="text-base">üçΩÔ∏è</span>
                            <span class="text-xs">Mesa</span>
                        </button>
                    </div>
                </div>
                
                <!-- Cliente -->
                <div class="campo-compacto">
                    <label class="text-xs font-semibold text-gray-700 mb-1 block">Cliente</label>
                    <input type="text" 
                           x-model="cliente.nome"
                           placeholder="Nome do cliente"
                           class="input-compacto w-full">
                    <div class="grid grid-cols-2 gap-1 mt-1" x-show="tipoPedido === 'delivery'">
                        <input type="text" 
                               x-model="cliente.telefone"
                               placeholder="Telefone"
                               class="input-compacto">
                        <input type="text" 
                               x-model="cliente.endereco"
                               placeholder="Endere√ßo"
                               class="input-compacto">
                    </div>
                    <!-- Campo Mesa -->
                    <div x-show="tipoPedido === 'mesa'" class="mt-1">
                        <input type="number" 
                               x-model="numeroMesa"
                               placeholder="N√∫mero da mesa"
                               min="1"
                               class="input-compacto w-full">
                    </div>
                </div>
                
                <!-- Forma de pagamento -->
                <div class="campo-compacto">
                    <label class="text-xs font-semibold text-gray-700 mb-1 block">Pagamento</label>
                    <div class="grid grid-cols-2 gap-1 mb-1">
                        <button @click="formaPagamento = 'dinheiro'; formasPagamento = []" 
                                class="opcao-btn-compacto" 
                                :class="{'selecionado': formaPagamento === 'dinheiro' && formasPagamento.length === 0}">
                            <span class="text-base">üí∞</span>
                            <span class="text-xs">Dinheiro</span>
                        </button>
                        <button @click="formaPagamento = 'pix'; formasPagamento = []" 
                                class="opcao-btn-compacto" 
                                :class="{'selecionado': formaPagamento === 'pix' && formasPagamento.length === 0}">
                            <span class="text-base">üì±</span>
                            <span class="text-xs">PIX</span>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-1">
                        <button @click="formaPagamento = 'cartao'; formasPagamento = []" 
                                class="opcao-btn-compacto" 
                                :class="{'selecionado': formaPagamento === 'cartao' && formasPagamento.length === 0}">
                            <span class="text-base">üí≥</span>
                            <span class="text-xs">Cart√£o</span>
                        </button>
                        <button @click="abrirModalMultiplasPagamento()" 
                                class="opcao-btn-compacto" 
                                :class="{'selecionado': formasPagamento.length > 0}"
                                style="background: #fef3c7; border-color: #f59e0b;">
                            <span class="text-base">üí∞üí≥</span>
                            <span class="text-xs">M√∫ltiplas</span>
                        </button>
                    </div>
                    <div x-show="formasPagamento.length > 0" class="mt-1 text-xs text-gray-600">
                        <span x-text="formasPagamento.length + ' formas selecionadas'"></span>
                    </div>
                </div>
            </div>
            
            <!-- Lista de Itens (Scroll√°vel) -->
            <div class="carrinho-itens-scroll">
                <template x-if="carrinho.length > 0">
                    <div>
                        <template x-for="(item, index) in carrinho" :key="index">
                            <div class="item-compacto">
                                <div class="item-info-compacto">
                                    <div class="text-sm font-medium" x-text="item.nome"></div>
                                    <div class="text-xs text-gray-500">
                                        <span x-text="item.tamanho"></span> ‚Ä¢ 
                                        R$ <span x-text="item.preco.toFixed(2).replace('.', ',')"></span>
                                    </div>
                                    <!-- Campo de observa√ß√µes -->
                                    <div class="mt-1">
                                        <input type="text" 
                                               x-model="item.observacoes"
                                               placeholder="Observa√ß√µes (ex: sem cebola)"
                                               class="w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:border-orange-400"
                                               @input="$nextTick(() => { item.observacoes = $event.target.value })">
                                    </div>
                                </div>
                                <div class="item-acoes-compacto">
                                    <button @click="diminuirQuantidade(index)" class="btn-qty-compacto">-</button>
                                    <span class="qty-compacto" x-text="item.quantidade"></span>
                                    <button @click="aumentarQuantidade(index)" class="btn-qty-compacto">+</button>
                                    <button @click="removerDoCarrinho(index)" class="btn-remove-compacto">√ó</button>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
                
                <!-- Carrinho vazio -->
                <template x-if="carrinho.length === 0">
                    <div class="text-center py-8 text-gray-400">
                        <p class="text-sm">Carrinho vazio</p>
                        <p class="text-xs mt-1">Adicione produtos</p>
                    </div>
                </template>
            </div>
            
            <!-- Footer com Resumo e Bot√£o -->
            <div class="carrinho-footer-compacto">
                <div class="resumo-compacto">
                    <div class="flex justify-between text-sm">
                        <span>Subtotal</span>
                        <span>R$ <span x-text="subtotal.toFixed(2).replace('.', ',')"></span></span>
                    </div>
                    <div class="flex justify-between items-center text-sm" x-show="tipoPedido === 'delivery'">
                        <span>Entrega</span>
                        <div class="flex items-center gap-1">
                            <span class="text-xs">R$</span>
                            <input type="number" 
                                   x-model.number="taxaEntrega"
                                   min="0"
                                   step="0.50"
                                   class="w-16 px-1 py-0.5 text-xs border border-gray-300 rounded text-right"
                                   @input="atualizarTotal()">
                        </div>
                    </div>
                    <div class="flex justify-between font-bold pt-2 border-t">
                        <span>Total</span>
                        <span>R$ <span x-text="total.toFixed(2).replace('.', ',')"></span></span>
                    </div>
                </div>
                
                <button @click="finalizarPedido()" 
                        :disabled="!podeFinalizarPedido()"
                        class="btn-finalizar-compacto">
                    <span x-text="carrinho.length === 0 ? 'Adicione produtos' : 'Finalizar Pedido'"></span>
                </button>
            </div>
        </div>
        
    </div>
    
    <!-- Modal Meio a Meio Melhorada -->
    <div x-show="modalMeioAMeio" 
         x-cloak 
         class="modal-rapido" 
         @click.self="modalMeioAMeio = false"
         x-data="{
             busca1: '',
             busca2: '',
             pizzasFiltradas1() {
                 if (!this.busca1) return pizzas;
                 return pizzas.filter(p => p.nome.toLowerCase().includes(this.busca1.toLowerCase()));
             },
             pizzasFiltradas2() {
                 if (!this.busca2) return pizzas;
                 return pizzas.filter(p => p.nome.toLowerCase().includes(this.busca2.toLowerCase()));
             }
         }">
        <div class="modal-content" style="max-width: 800px; width: 95%;">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">üçï Monte sua Pizza Meio a Meio</h3>
                <button @click="modalMeioAMeio = false" 
                        class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Sele√ß√£o dos sabores -->
            <div class="grid grid-cols-2 gap-6 mb-6">
                <!-- Primeiro Sabor -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">
                        <span class="text-orange-600">üçï</span> 1¬∫ Sabor
                    </label>
                    
                    <!-- Campo de busca -->
                    <div class="relative mb-3">
                        <input type="text" 
                               x-model="busca1"
                               placeholder="Buscar sabor..."
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        <svg class="absolute right-3 top-2.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    
                    <!-- Lista de pizzas -->
                    <div class="border border-gray-200 rounded-lg overflow-hidden" style="max-height: 250px; overflow-y: auto;">
                        <template x-for="pizza in pizzasFiltradas1()" :key="'sabor1_' + pizza.id">
                            <div @click="meioAMeio.sabor1 = pizza.id; meioAMeio.sabor1Nome = pizza.nome"
                                 class="px-3 py-2 cursor-pointer hover:bg-gray-50 border-b border-gray-100"
                                 :class="{'bg-orange-50 border-orange-300': meioAMeio.sabor1 === pizza.id}">
                                <div class="font-medium text-sm" x-text="pizza.nome"></div>
                                <div class="text-xs text-gray-500" x-show="meioAMeio.sabor1 === pizza.id">‚úì Selecionado</div>
                            </div>
                        </template>
                        <div x-show="pizzasFiltradas1().length === 0" class="px-3 py-4 text-center text-gray-500 text-sm">
                            Nenhuma pizza encontrada
                        </div>
                    </div>
                </div>
                
                <!-- Segundo Sabor -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">
                        <span class="text-red-600">üçï</span> 2¬∫ Sabor
                    </label>
                    
                    <!-- Campo de busca -->
                    <div class="relative mb-3">
                        <input type="text" 
                               x-model="busca2"
                               placeholder="Buscar sabor..."
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        <svg class="absolute right-3 top-2.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    
                    <!-- Lista de pizzas -->
                    <div class="border border-gray-200 rounded-lg overflow-hidden" style="max-height: 250px; overflow-y: auto;">
                        <template x-for="pizza in pizzasFiltradas2()" :key="'sabor2_' + pizza.id">
                            <div @click="meioAMeio.sabor2 = pizza.id; meioAMeio.sabor2Nome = pizza.nome"
                                 class="px-3 py-2 cursor-pointer hover:bg-gray-50 border-b border-gray-100"
                                 :class="{'bg-red-50 border-red-300': meioAMeio.sabor2 === pizza.id}">
                                <div class="font-medium text-sm" x-text="pizza.nome"></div>
                                <div class="text-xs text-gray-500" x-show="meioAMeio.sabor2 === pizza.id">‚úì Selecionado</div>
                            </div>
                        </template>
                        <div x-show="pizzasFiltradas2().length === 0" class="px-3 py-4 text-center text-gray-500 text-sm">
                            Nenhuma pizza encontrada
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Resumo da sele√ß√£o -->
            <div x-show="meioAMeio.sabor1 && meioAMeio.sabor2" 
                 class="bg-gray-50 rounded-lg p-3 mb-4">
                <div class="text-sm text-gray-600">Sua pizza:</div>
                <div class="font-semibold">
                    <span x-text="meioAMeio.sabor1Nome"></span> + <span x-text="meioAMeio.sabor2Nome"></span>
                </div>
            </div>
            
            <!-- Tamanho -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-3">Escolha o Tamanho</label>
                <div class="grid grid-cols-4 gap-2">
                    <button @click="meioAMeio.tamanho = 'P'" 
                            class="p-3 border rounded-lg text-center transition-all"
                            :class="meioAMeio.tamanho === 'P' ? 'bg-red-600 text-white border-red-600' : 'border-gray-300 hover:border-gray-400'">
                        <div class="text-lg">üçï</div>
                        <div class="text-sm font-medium">Pequena</div>
                        <div class="text-xs opacity-75">4 fatias</div>
                    </button>
                    <button @click="meioAMeio.tamanho = 'M'" 
                            class="p-3 border rounded-lg text-center transition-all"
                            :class="meioAMeio.tamanho === 'M' ? 'bg-red-600 text-white border-red-600' : 'border-gray-300 hover:border-gray-400'">
                        <div class="text-lg">üçïüçï</div>
                        <div class="text-sm font-medium">M√©dia</div>
                        <div class="text-xs opacity-75">8 fatias</div>
                    </button>
                    <button @click="meioAMeio.tamanho = 'G'" 
                            class="p-3 border rounded-lg text-center transition-all"
                            :class="meioAMeio.tamanho === 'G' ? 'bg-red-600 text-white border-red-600' : 'border-gray-300 hover:border-gray-400'">
                        <div class="text-lg">üçïüçïüçï</div>
                        <div class="text-sm font-medium">Grande</div>
                        <div class="text-xs opacity-75">12 fatias</div>
                    </button>
                    <button @click="meioAMeio.tamanho = 'F'" 
                            class="p-3 border rounded-lg text-center transition-all"
                            :class="meioAMeio.tamanho === 'F' ? 'bg-red-600 text-white border-red-600' : 'border-gray-300 hover:border-gray-400'">
                        <div class="text-lg">üçïüçïüçïüçï</div>
                        <div class="text-sm font-medium">Fam√≠lia</div>
                        <div class="text-xs opacity-75">16 fatias</div>
                    </button>
                </div>
            </div>
            
            <!-- A√ß√µes -->
            <div class="flex gap-3">
                <button @click="modalMeioAMeio = false; busca1 = ''; busca2 = ''" 
                        class="flex-1 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button @click="adicionarMeioAMeio(); busca1 = ''; busca2 = ''" 
                        :disabled="!meioAMeio.sabor1 || !meioAMeio.sabor2 || !meioAMeio.tamanho"
                        class="flex-1 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed">
                    üçï Adicionar ao Carrinho
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de M√∫ltiplas Formas de Pagamento -->
    <div x-show="modalMultiplasPagamento" 
         x-cloak 
         class="modal-rapido" 
         @click.self="modalMultiplasPagamento = false">
        <div class="modal-content" style="max-width: 600px;">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">üí∞üí≥ M√∫ltiplas Formas de Pagamento</h3>
                <button @click="modalMultiplasPagamento = false" 
                        class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Total do Pedido -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Total do Pedido:</span>
                    <span class="text-xl font-bold text-red-600">R$ <span x-text="total.toFixed(2).replace('.', ',')"></span></span>
                </div>
            </div>
            
            <!-- Formas de Pagamento -->
            <div class="space-y-4 mb-6">
                <!-- Dinheiro -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="flex items-center">
                            <input type="checkbox" 
                                   x-model="pagamentosSelecionados.dinheiro.ativo"
                                   @change="calcularTotalPagamentos()"
                                   class="mr-2">
                            <span class="font-medium">üí∞ Dinheiro</span>
                        </label>
                        <input type="number" 
                               x-show="pagamentosSelecionados.dinheiro.ativo"
                               x-model.number="pagamentosSelecionados.dinheiro.valor"
                               @input="calcularTotalPagamentos()"
                               min="0"
                               :max="total"
                               step="0.01"
                               placeholder="0,00"
                               class="w-32 px-3 py-1 border border-gray-300 rounded-md text-right">
                    </div>
                </div>
                
                <!-- PIX -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="flex items-center">
                            <input type="checkbox" 
                                   x-model="pagamentosSelecionados.pix.ativo"
                                   @change="calcularTotalPagamentos()"
                                   class="mr-2">
                            <span class="font-medium">üì± PIX</span>
                        </label>
                        <input type="number" 
                               x-show="pagamentosSelecionados.pix.ativo"
                               x-model.number="pagamentosSelecionados.pix.valor"
                               @input="calcularTotalPagamentos()"
                               min="0"
                               :max="total"
                               step="0.01"
                               placeholder="0,00"
                               class="w-32 px-3 py-1 border border-gray-300 rounded-md text-right">
                    </div>
                </div>
                
                <!-- Cart√£o D√©bito -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="flex items-center">
                            <input type="checkbox" 
                                   x-model="pagamentosSelecionados.cartao_debito.ativo"
                                   @change="calcularTotalPagamentos()"
                                   class="mr-2">
                            <span class="font-medium">üí≥ Cart√£o D√©bito</span>
                        </label>
                        <input type="number" 
                               x-show="pagamentosSelecionados.cartao_debito.ativo"
                               x-model.number="pagamentosSelecionados.cartao_debito.valor"
                               @input="calcularTotalPagamentos()"
                               min="0"
                               :max="total"
                               step="0.01"
                               placeholder="0,00"
                               class="w-32 px-3 py-1 border border-gray-300 rounded-md text-right">
                    </div>
                </div>
                
                <!-- Cart√£o Cr√©dito -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="flex items-center">
                            <input type="checkbox" 
                                   x-model="pagamentosSelecionados.cartao_credito.ativo"
                                   @change="calcularTotalPagamentos()"
                                   class="mr-2">
                            <span class="font-medium">üí≥ Cart√£o Cr√©dito</span>
                        </label>
                        <input type="number" 
                               x-show="pagamentosSelecionados.cartao_credito.ativo"
                               x-model.number="pagamentosSelecionados.cartao_credito.valor"
                               @input="calcularTotalPagamentos()"
                               min="0"
                               :max="total"
                               step="0.01"
                               placeholder="0,00"
                               class="w-32 px-3 py-1 border border-gray-300 rounded-md text-right">
                    </div>
                </div>
            </div>
            
            <!-- Resumo -->
            <div class="bg-blue-50 rounded-lg p-4 mb-6">
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span>Total Selecionado:</span>
                        <span class="font-medium">R$ <span x-text="totalPagamentosSelecionados.toFixed(2).replace('.', ',')"></span></span>
                    </div>
                    <div class="flex justify-between text-sm" 
                         :class="{'text-red-600': totalRestante > 0, 'text-green-600': totalRestante === 0}">
                        <span x-text="totalRestante > 0 ? 'Falta:' : 'Completo!'"></span>
                        <span class="font-medium" x-show="totalRestante > 0">R$ <span x-text="Math.abs(totalRestante).toFixed(2).replace('.', ',')"></span></span>
                        <span class="font-medium" x-show="totalRestante === 0">‚úì</span>
                    </div>
                    <div x-show="totalRestante < 0" class="text-orange-600 text-sm">
                        ‚ö†Ô∏è Valor excede o total do pedido
                    </div>
                </div>
            </div>
            
            <!-- A√ß√µes -->
            <div class="flex gap-3">
                <button @click="modalMultiplasPagamento = false; limparPagamentosSelecionados()" 
                        class="flex-1 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button @click="confirmarMultiplasPagamento()" 
                        :disabled="totalRestante !== 0 || totalPagamentosSelecionados === 0"
                        class="flex-1 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed">
                    Confirmar Pagamento
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal Seletor de Tamanho (Meio a Meio Integrado) -->
    <div x-show="modalSeletorTamanho" 
         x-cloak 
         class="modal-rapido" 
         @click.self="cancelarMeioAMeio()">
        <div class="modal-content" style="max-width: 500px;">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">üçï Escolha o Tamanho</h3>
                <button @click="cancelarMeioAMeio()" 
                        class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Resumo dos sabores selecionados -->
            <div class="bg-gradient-to-r from-blue-50 to-red-50 rounded-lg p-4 mb-6">
                <div class="text-sm text-gray-600 mb-1">Sua pizza meio a meio:</div>
                <div class="font-bold text-lg flex items-center justify-center">
                    <span class="text-blue-600" x-text="primeiroSabor?.nome"></span>
                    <span class="mx-2 text-gray-400">+</span>
                    <span class="text-red-600" x-text="segundoSabor?.nome"></span>
                </div>
            </div>
            
            <!-- Sele√ß√£o de tamanho -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <!-- Pequena -->
                <button @click="adicionarMeioAMeioInline('P', 'Pequena')" 
                        class="p-4 border-2 border-gray-300 rounded-lg hover:border-red-500 hover:bg-red-50 transition-all text-center">
                    <div class="text-2xl mb-2">üçï</div>
                    <div class="font-semibold">Pequena</div>
                    <div class="text-sm text-gray-500">4 fatias</div>
                    <div class="text-sm font-medium text-red-600 mt-1">
                        R$ <span x-text="Math.max(
                            primeiroSabor?.precos?.find(p => p.tamanho === 'Pequena')?.preco || 0,
                            segundoSabor?.precos?.find(p => p.tamanho === 'Pequena')?.preco || 0
                        ).toFixed(2).replace('.', ',')"></span>
                    </div>
                </button>
                
                <!-- M√©dia -->
                <button @click="adicionarMeioAMeioInline('M', 'M√©dia')" 
                        class="p-4 border-2 border-gray-300 rounded-lg hover:border-red-500 hover:bg-red-50 transition-all text-center">
                    <div class="text-2xl mb-2">üçïüçï</div>
                    <div class="font-semibold">M√©dia</div>
                    <div class="text-sm text-gray-500">8 fatias</div>
                    <div class="text-sm font-medium text-red-600 mt-1">
                        R$ <span x-text="Math.max(
                            primeiroSabor?.precos?.find(p => p.tamanho === 'M√©dia')?.preco || 0,
                            segundoSabor?.precos?.find(p => p.tamanho === 'M√©dia')?.preco || 0
                        ).toFixed(2).replace('.', ',')"></span>
                    </div>
                </button>
                
                <!-- Grande -->
                <button @click="adicionarMeioAMeioInline('G', 'Grande')" 
                        class="p-4 border-2 border-gray-300 rounded-lg hover:border-red-500 hover:bg-red-50 transition-all text-center">
                    <div class="text-2xl mb-2">üçïüçïüçï</div>
                    <div class="font-semibold">Grande</div>
                    <div class="text-sm text-gray-500">12 fatias</div>
                    <div class="text-sm font-medium text-red-600 mt-1">
                        R$ <span x-text="Math.max(
                            primeiroSabor?.precos?.find(p => p.tamanho === 'Grande')?.preco || 0,
                            segundoSabor?.precos?.find(p => p.tamanho === 'Grande')?.preco || 0
                        ).toFixed(2).replace('.', ',')"></span>
                    </div>
                </button>
                
                <!-- Fam√≠lia -->
                <button @click="adicionarMeioAMeioInline('F', 'Fam√≠lia')" 
                        class="p-4 border-2 border-gray-300 rounded-lg hover:border-red-500 hover:bg-red-50 transition-all text-center">
                    <div class="text-2xl mb-2">üçïüçïüçïüçï</div>
                    <div class="font-semibold">Fam√≠lia</div>
                    <div class="text-sm text-gray-500">16 fatias</div>
                    <div class="text-sm font-medium text-red-600 mt-1">
                        R$ <span x-text="Math.max(
                            primeiroSabor?.precos?.find(p => p.tamanho === 'Fam√≠lia')?.preco || 0,
                            segundoSabor?.precos?.find(p => p.tamanho === 'Fam√≠lia')?.preco || 0
                        ).toFixed(2).replace('.', ',')"></span>
                    </div>
                </button>
            </div>
            
            <!-- Informa√ß√£o sobre pre√ßo -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-sm text-yellow-800">
                        <strong>Pre√ßo:</strong> Cobramos o valor do sabor mais caro
                    </span>
                </div>
            </div>
            
            <!-- Bot√£o cancelar -->
            <button @click="cancelarMeioAMeio()" 
                    class="w-full py-3 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors text-center">
                Cancelar
            </button>
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<script>
function pedidoRapido() {
    return {
        // Estado
        busca: '',
        filtroCategoria: '',
        produtos: [],
        produtosFiltrados: [],
        pizzas: [],
        carrinho: [],
        tipoPedido: 'balcao',
        formaPagamento: 'dinheiro',
        formasPagamento: [], // Array para m√∫ltiplas formas
        taxaEntrega: 5.00, // Taxa de entrega edit√°vel
        numeroMesa: '', // N√∫mero da mesa
        cliente: {
            nome: '',
            telefone: '',
            endereco: ''
        },
        modalMeioAMeio: false,
        modalMultiplasPagamento: false,
        modalSeletorTamanho: false,
        
        // Estado para meio a meio integrado
        primeiroSabor: null,
        primeiroSaborTamanho: null, // Novo: armazena o tamanho escolhido
        segundoSabor: null,
        aguardandoSegundoSabor: false,
        meioAMeio: {
            sabor1: '',
            sabor1Nome: '',
            sabor2: '',
            sabor2Nome: '',
            tamanho: ''
        },
        pagamentosSelecionados: {
            dinheiro: { ativo: false, valor: 0 },
            pix: { ativo: false, valor: 0 },
            cartao_debito: { ativo: false, valor: 0 },
            cartao_credito: { ativo: false, valor: 0 }
        },
        totalPagamentosSelecionados: 0,
        totalRestante: 0,
        
        // Inicializa√ß√£o
        init() {
            this.carregarProdutos();
        },
        
        // Carregar produtos
        async carregarProdutos() {
            try {
                const response = await fetch('/api/produtos/produtos/para_pedido_rapido/');
                const data = await response.json();
                
                this.produtos = data.produtos.map(p => ({
                    ...p,
                    precos: p.precos.map(preco => ({
                        ...preco,
                        preco: parseFloat(preco.preco)
                    }))
                }));
                
                this.pizzas = this.produtos.filter(p => p.categoria === 'pizzas');
                
                // Debug
                console.log('Produtos carregados:', this.produtos.length);
                console.log('Por categoria:', {
                    pizzas: this.produtos.filter(p => p.categoria === 'pizzas').length,
                    bebidas: this.produtos.filter(p => p.categoria === 'bebidas').length,
                    bordas: this.produtos.filter(p => p.categoria === 'bordas').length,
                    outros: this.produtos.filter(p => p.categoria === 'outros').length
                });
                
                this.buscarProdutos();
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
            }
        },
        
        // Buscar e filtrar produtos
        buscarProdutos() {
            let filtrados = this.produtos;
            
            // Filtro por categoria
            if (this.filtroCategoria) {
                filtrados = filtrados.filter(p => p.categoria === this.filtroCategoria);
            }
            
            // Filtro por busca
            if (this.busca) {
                const termo = this.busca.toLowerCase();
                filtrados = filtrados.filter(p => 
                    p.nome.toLowerCase().includes(termo) ||
                    (p.descricao && p.descricao.toLowerCase().includes(termo))
                );
            }
            
            this.produtosFiltrados = filtrados;
            console.log('Produtos filtrados:', this.produtosFiltrados.length, 'Categoria:', this.filtroCategoria || 'Todos');
        },
        
        // Adicionar ao carrinho
        adicionarAoCarrinho(produto, preco) {
            const itemExistente = this.carrinho.find(item => 
                item.produto_id === produto.id && 
                item.preco_id === preco.id
            );
            
            if (itemExistente) {
                itemExistente.quantidade++;
            } else {
                this.carrinho.push({
                    produto_id: produto.id,
                    preco_id: preco.id,
                    nome: produto.nome,
                    tamanho: preco.tamanho,
                    preco: preco.preco,
                    quantidade: 1,
                    observacoes: '' // Campo de observa√ß√µes vazio
                });
            }
            
            // Feedback visual
            this.mostrarNotificacao('Produto adicionado!', 'success');
        },
        
        // Quantidade no carrinho
        aumentarQuantidade(index) {
            this.carrinho[index].quantidade++;
        },
        
        diminuirQuantidade(index) {
            if (this.carrinho[index].quantidade > 1) {
                this.carrinho[index].quantidade--;
            }
        },
        
        removerDoCarrinho(index) {
            this.carrinho.splice(index, 1);
        },
        
        // Nova l√≥gica: sele√ß√£o com tamanho direto
        selecionarPizzaComTamanho(produto, preco) {
            if (!this.primeiroSabor) {
                // Primeira sele√ß√£o: pizza + tamanho
                this.primeiroSabor = produto;
                this.primeiroSaborTamanho = preco;
                this.aguardandoSegundoSabor = true;
                this.mostrarNotificacao(`1¬∫ sabor: ${produto.nome} (${preco.tamanho}). Escolha o 2¬∫ sabor no mesmo tamanho.`, 'info');
            } else if (this.primeiroSabor.id === produto.id && this.primeiroSaborTamanho.id === preco.id) {
                // Cancelar sele√ß√£o (clicou no mesmo sabor e tamanho)
                this.cancelarMeioAMeio();
            } else if (this.primeiroSabor.id === produto.id) {
                // Mesmo produto, tamanho diferente - cancelar e selecionar novo
                this.primeiroSabor = produto;
                this.primeiroSaborTamanho = preco;
                this.mostrarNotificacao(`1¬∫ sabor alterado: ${produto.nome} (${preco.tamanho})`, 'info');
            } else if (this.primeiroSaborTamanho.tamanho === preco.tamanho) {
                // Tamanho igual - criar meio a meio automaticamente!
                this.segundoSabor = produto;
                this.criarMeioAMeioAutomatico(preco);
            } else {
                // Tamanho diferente - mostrar op√ß√µes
                this.segundoSabor = produto;
                this.mostrarModalEscolhaTamanho();
            }
        },
        
        // Cria meio a meio automaticamente quando tamanhos s√£o iguais
        criarMeioAMeioAutomatico(segundoPreco) {
            const precoFinal = Math.max(this.primeiroSaborTamanho.preco, segundoPreco.preco);
            
            // Guardar nomes antes de limpar
            const nome1 = this.primeiroSabor.nome;
            const nome2 = this.segundoSabor.nome;
            const tamanho = this.primeiroSaborTamanho.tamanho;
            const sabor1Id = this.primeiroSabor.id;
            const sabor2Id = this.segundoSabor.id;
            
            // Adicionar ao carrinho
            this.carrinho.push({
                nome: `${nome1} + ${nome2}`,
                tamanho: tamanho,
                preco: precoFinal,
                quantidade: 1,
                meio_a_meio: true,
                sabor1_id: sabor1Id,
                sabor2_id: sabor2Id,
                observacoes: ''
            });
            
            // Limpar sele√ß√£o
            this.cancelarMeioAMeio();
            
            this.mostrarNotificacao(`üçï Pizza meio a meio criada! ${nome1} + ${nome2} (${tamanho})`, 'success');
        },
        
        // Modal quando tamanhos s√£o diferentes
        mostrarModalEscolhaTamanho() {
            this.modalSeletorTamanho = true;
            this.mostrarNotificacao('Tamanhos diferentes. Escolha o tamanho para a pizza meio a meio.', 'info');
        },

        // Fun√ß√£o original (mantida para compatibilidade com bot√£o ¬Ω + ¬Ω)
        selecionarParaMeioAMeio(produto) {
            if (!this.primeiroSabor) {
                // Primeira sele√ß√£o sem tamanho espec√≠fico
                this.primeiroSabor = produto;
                this.primeiroSaborTamanho = null; // Sem tamanho espec√≠fico
                this.aguardandoSegundoSabor = true;
                this.mostrarNotificacao(`1¬∫ sabor: ${produto.nome}. Agora escolha o 2¬∫ sabor.`, 'info');
            } else if (this.primeiroSabor.id === produto.id) {
                // Cancelar sele√ß√£o (clicou no mesmo sabor)
                this.cancelarMeioAMeio();
            } else {
                // Segunda sele√ß√£o - abrir seletor de tamanho
                this.segundoSabor = produto;
                this.abrirSeletorTamanhoInline();
            }
        },
        
        cancelarMeioAMeio() {
            this.primeiroSabor = null;
            this.primeiroSaborTamanho = null; // Limpar tamanho tamb√©m
            this.segundoSabor = null;
            this.aguardandoSegundoSabor = false;
            this.modalSeletorTamanho = false;
            this.mostrarNotificacao('Sele√ß√£o de meio a meio cancelada', 'info');
        },
        
        abrirSeletorTamanhoInline() {
            this.modalSeletorTamanho = true;
            this.mostrarNotificacao(`Sabores: ${this.primeiroSabor.nome} + ${this.segundoSabor.nome}. Escolha o tamanho.`, 'success');
        },
        
        adicionarMeioAMeioInline(tamanho, tamanhoLabel) {
            if (!this.primeiroSabor || !this.segundoSabor) return;
            
            // Calcular pre√ßo (usar o maior valor)
            const preco1 = this.primeiroSabor.precos.find(p => p.tamanho === tamanhoLabel);
            const preco2 = this.segundoSabor.precos.find(p => p.tamanho === tamanhoLabel);
            
            if (!preco1 || !preco2) {
                this.mostrarNotificacao('Erro: tamanho n√£o encontrado para um dos sabores', 'error');
                return;
            }
            
            const precoFinal = Math.max(preco1.preco, preco2.preco);
            
            // Adicionar ao carrinho
            this.carrinho.push({
                nome: `${this.primeiroSabor.nome} + ${this.segundoSabor.nome}`,
                tamanho: tamanhoLabel,
                preco: precoFinal,
                quantidade: 1,
                meio_a_meio: true,
                sabor1_id: this.primeiroSabor.id,
                sabor2_id: this.segundoSabor.id,
                observacoes: ''
            });
            
            // Limpar sele√ß√£o
            this.primeiroSabor = null;
            this.segundoSabor = null;
            this.aguardandoSegundoSabor = false;
            this.modalSeletorTamanho = false;
            
            this.mostrarNotificacao('Pizza meio a meio adicionada ao carrinho!', 'success');
        },

        // Modal meio a meio (manter para compatibilidade)
        abrirModalMeioAMeio() {
            this.modalMeioAMeio = true;
            this.meioAMeio = { 
                sabor1: '', 
                sabor1Nome: '',
                sabor2: '', 
                sabor2Nome: '',
                tamanho: '' 
            };
        },
        
        adicionarMeioAMeio() {
            const sabor1 = this.pizzas.find(p => p.id == this.meioAMeio.sabor1);
            const sabor2 = this.pizzas.find(p => p.id == this.meioAMeio.sabor2);
            
            if (!sabor1 || !sabor2) return;
            
            // Mapear tamanho para buscar pre√ßo correto
            const tamanhoMap = {
                'P': 'Pequena',
                'M': 'M√©dia', 
                'G': 'Grande',
                'F': 'Fam√≠lia'
            };
            
            // Calcular pre√ßo (maior valor)
            const preco1 = sabor1.precos.find(p => p.tamanho === tamanhoMap[this.meioAMeio.tamanho]);
            const preco2 = sabor2.precos.find(p => p.tamanho === tamanhoMap[this.meioAMeio.tamanho]);
            
            const precoFinal = Math.max(preco1?.preco || 0, preco2?.preco || 0);
            
            this.carrinho.push({
                nome: `${this.meioAMeio.sabor1Nome} + ${this.meioAMeio.sabor2Nome}`,
                tamanho: tamanhoMap[this.meioAMeio.tamanho],
                preco: precoFinal,
                quantidade: 1,
                meio_a_meio: true,
                sabor1_id: sabor1.id,
                sabor2_id: sabor2.id,
                observacoes: '' // Campo de observa√ß√µes vazio
            });
            
            this.modalMeioAMeio = false;
            
            // Mostrar notifica√ß√£o
            this.mostrarNotificacao('Pizza meio a meio adicionada!', 'success');
        },
        
        // C√°lculos
        get subtotal() {
            return this.carrinho.reduce((total, item) => 
                total + (item.preco * item.quantidade), 0
            );
        },
        
        get total() {
            let total = this.subtotal;
            if (this.tipoPedido === 'delivery') {
                total += this.taxaEntrega;
            }
            return total;
        },
        
        // Atualizar total quando taxa de entrega mudar
        atualizarTotal() {
            // For√ßa rec√°lculo do total
            this.$nextTick(() => {
                if (this.modalMultiplasPagamento) {
                    this.calcularTotalPagamentos();
                }
            });
        },
        
        // Valida√ß√£o
        podeFinalizarPedido() {
            if (this.carrinho.length === 0) return false;
            if (!this.cliente.nome) return false;
            if (this.tipoPedido === 'delivery' && (!this.cliente.telefone || !this.cliente.endereco)) return false;
            if (this.tipoPedido === 'mesa' && !this.numeroMesa) return false;
            return true;
        },
        
        // Modal de m√∫ltiplas formas de pagamento
        abrirModalMultiplasPagamento() {
            this.modalMultiplasPagamento = true;
            this.limparPagamentosSelecionados();
            this.calcularTotalPagamentos();
        },
        
        limparPagamentosSelecionados() {
            this.pagamentosSelecionados = {
                dinheiro: { ativo: false, valor: 0 },
                pix: { ativo: false, valor: 0 },
                cartao_debito: { ativo: false, valor: 0 },
                cartao_credito: { ativo: false, valor: 0 }
            };
            this.totalPagamentosSelecionados = 0;
            this.totalRestante = this.total;
        },
        
        calcularTotalPagamentos() {
            let total = 0;
            
            for (let forma in this.pagamentosSelecionados) {
                if (this.pagamentosSelecionados[forma].ativo) {
                    total += this.pagamentosSelecionados[forma].valor || 0;
                }
            }
            
            this.totalPagamentosSelecionados = total;
            this.totalRestante = this.total - total;
        },
        
        confirmarMultiplasPagamento() {
            if (this.totalRestante !== 0 || this.totalPagamentosSelecionados === 0) {
                return;
            }
            
            // Limpar array de formas de pagamento
            this.formasPagamento = [];
            
            // Adicionar formas selecionadas
            for (let forma in this.pagamentosSelecionados) {
                if (this.pagamentosSelecionados[forma].ativo && this.pagamentosSelecionados[forma].valor > 0) {
                    this.formasPagamento.push({
                        tipo: forma,
                        valor: this.pagamentosSelecionados[forma].valor,
                        nome: this.getNomeFormaPagamento(forma)
                    });
                }
            }
            
            // Limpar forma de pagamento √∫nica
            this.formaPagamento = '';
            
            // Fechar modal
            this.modalMultiplasPagamento = false;
            
            // Mostrar notifica√ß√£o
            this.mostrarNotificacao(`${this.formasPagamento.length} formas de pagamento selecionadas`, 'success');
        },
        
        getNomeFormaPagamento(tipo) {
            const nomes = {
                'dinheiro': 'Dinheiro',
                'pix': 'PIX',
                'cartao_debito': 'Cart√£o D√©bito',
                'cartao_credito': 'Cart√£o Cr√©dito'
            };
            return nomes[tipo] || tipo;
        },
        
        // Mostrar notifica√ß√£o
        mostrarNotificacao(mensagem, tipo = 'info') {
            // Criar elemento de notifica√ß√£o
            const notificacao = document.createElement('div');
            notificacao.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all ${
                tipo === 'success' ? 'bg-green-500 text-white' : 
                tipo === 'error' ? 'bg-red-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            notificacao.textContent = mensagem;
            
            // Adicionar ao body
            document.body.appendChild(notificacao);
            
            // Remover ap√≥s 3 segundos
            setTimeout(() => {
                notificacao.remove();
            }, 3000);
        },
        
        // Finalizar pedido
        async finalizarPedido() {
            if (!this.podeFinalizarPedido()) return;
            
            const pedido = {
                tipo: this.tipoPedido,
                mesa: this.tipoPedido === 'mesa' ? this.numeroMesa : null,
                forma_pagamento: this.formasPagamento.length > 0 ? 'multiplas' : this.formaPagamento,
                formas_pagamento: this.formasPagamento.length > 0 ? this.formasPagamento : null,
                cliente_nome: this.cliente.nome,
                cliente_telefone: this.cliente.telefone,
                endereco_entrega: this.cliente.endereco,
                itens: this.carrinho.map(item => {
                    // Preparar dados do item
                    const itemData = {
                        produto_preco_id: item.preco_id || null,
                        quantidade: item.quantidade,
                        observacoes: item.observacoes || ''
                    };
                    
                    // Se for meio a meio, adicionar dados especiais
                    if (item.meio_a_meio) {
                        itemData.meio_a_meio = true;
                        itemData.meio_a_meio_data = {
                            is_meio_a_meio: true,
                            sabor1: item.sabor1_id ? this.pizzas.find(p => p.id === item.sabor1_id)?.nome : item.nome.split(' + ')[0],
                            sabor2: item.sabor2_id ? this.pizzas.find(p => p.id === item.sabor2_id)?.nome : item.nome.split(' + ')[1],
                            tamanho: item.tamanho,
                            preco: item.preco
                        };
                        // Usar o ID de pre√ßo do primeiro sabor como base
                        const sabor1 = this.pizzas.find(p => p.id === item.sabor1_id);
                        if (sabor1) {
                            const precoBase = sabor1.precos.find(p => p.tamanho === item.tamanho);
                            if (precoBase) {
                                itemData.produto_preco_id = precoBase.id;
                            }
                        }
                    }
                    
                    return itemData;
                }),
                taxa_entrega: this.tipoPedido === 'delivery' ? this.taxaEntrega : 0,
                total: this.total
            };
            
            console.log('DEBUG: Dados do pedido:', pedido);
            
            try {
                const response = await fetch('/pedidos/api/criar-rapido/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(pedido)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.mostrarNotificacao('Pedido criado com sucesso!', 'success');
                    
                    // Limpar carrinho
                    this.carrinho = [];
                    this.cliente = { nome: '', telefone: '', endereco: '' };
                    this.numeroMesa = '';
                } else {
                    const errorData = await response.json();
                    console.error('DEBUG: Erro do servidor:', errorData);
                    throw new Error(errorData.error || 'Erro ao criar pedido');
                }
            } catch (error) {
                this.mostrarNotificacao('Erro ao criar pedido', 'error');
                console.error(error);
            }
        }
    }
}
</script>
{% endblock %}