{% extends 'layouts/dashboard.html' %}
{% load static %}

{% block title %}{% if object %}Editar{% else %}Novo{% endif %} Pedido - Pizzaria{% endblock %}

{% block extra_css %}
<style>
    /* Estilos para campos inv√°lidos */
    .campo-invalido {
        border-color: #DC2626 !important;
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }
    
    /* Estilos para mensagens de erro */
    .mensagem-erro {
        color: #DC2626;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    /* Estilos para campos obrigat√≥rios */
    .campo-obrigatorio::after {
        content: ' *';
        color: #DC2626;
    }
    
    /* Estilos para se√ß√µes */
    .secao-formulario {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        overflow: hidden;
    }
    
    .secao-header {
        padding: 1rem 1.5rem;
        background: #F9FAFB;
        border-bottom: 1px solid #E5E7EB;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .secao-header:hover {
        background: #F3F4F6;
    }
    
    .secao-content {
        padding: 1.5rem;
    }
    
    /* Estilos para abas de produtos */
    .aba-produto {
        @apply px-4 py-2 text-sm font-medium rounded-lg cursor-pointer transition-all;
    }
    
    .aba-produto.active {
        @apply bg-pizza-600 text-white;
    }
    
    .aba-produto:not(.active) {
        @apply bg-gray-100 text-gray-700 hover:bg-gray-200;
    }
    
    /* Cards de produtos */
    .produto-card {
        @apply bg-white border border-gray-200 rounded-lg p-4 transition-all hover:shadow-md;
    }
    
    .produto-card.pizza {
        @apply relative;
    }
    
    /* Seletor de tamanho para pizzas */
    .tamanho-selector {
        @apply grid grid-cols-2 sm:grid-cols-4 gap-2 mt-3;
    }
    
    .tamanho-option {
        @apply relative;
    }
    
    .tamanho-option input[type="radio"] {
        @apply sr-only peer;
    }
    
    .tamanho-option label {
        @apply block w-full px-3 py-2 text-center text-sm border rounded-md cursor-pointer transition-all;
        @apply peer-checked:bg-pizza-600 peer-checked:text-white peer-checked:border-pizza-600;
        @apply hover:bg-gray-50 peer-checked:hover:bg-pizza-700;
    }
    
    /* Carrinho lateral */
    .carrinho-lateral {
        @apply sticky top-4 bg-white border border-gray-200 rounded-lg shadow-lg h-fit;
    }
    
    .carrinho-item {
        @apply flex justify-between items-start py-3 border-b border-gray-100 last:border-b-0;
    }
    
    .carrinho-item-info {
        @apply flex-1 mr-3;
    }
    
    .carrinho-item-controls {
        @apply flex items-center space-x-2;
    }
    
    .quantidade-control {
        @apply w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center cursor-pointer hover:bg-gray-50 transition-colors;
    }
    
    .quantidade-control:hover {
        @apply border-pizza-500 text-pizza-600;
    }
    
    .quantidade-control.disabled {
        @apply opacity-50 cursor-not-allowed;
    }
    
    /* Bot√£o adicionar produto */
    .btn-adicionar {
        @apply w-full mt-3 px-4 py-2 bg-pizza-600 text-white rounded-lg hover:bg-pizza-700 transition-colors;
        @apply disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-pizza-600;
    }
    
    /* Totais do carrinho */
    .carrinho-totais {
        @apply space-y-2 pt-4 border-t border-gray-200;
    }
    
    .total-linha {
        @apply flex justify-between text-sm;
    }
    
    .total-linha.final {
        @apply text-lg font-bold text-pizza-600 pt-2 border-t border-gray-200;
    }
    
    /* Responsividade */
    @media (max-width: 1024px) {
        .layout-produtos {
            @apply flex-col;
        }
        
        .carrinho-lateral {
            @apply static order-first mb-6;
        }
    }
    
    @media (max-width: 640px) {
        .secao-content {
            padding: 1rem;
        }
        
        .tamanho-selector {
            @apply grid-cols-2;
        }
        
        .carrinho-lateral {
            @apply mx-4;
        }
    }
</style>
{% endblock %}

{% block content %}
<div x-data="pedidoForm()" x-init="init()">
    <form method="post" @submit.prevent="submitForm" novalidate>
        {% csrf_token %}
        
        <!-- Cabe√ßalho -->
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-900">
                {% if object %}Editar Pedido #{{ object.numero }}{% else %}Novo Pedido{% endif %}
            </h1>
            <p class="mt-1 text-sm text-gray-600">Preencha os dados do cliente e selecione os produtos desejados</p>
        </div>
        
        <!-- Mensagens de erro global -->
        <div x-show="errosGlobais.length > 0" 
             class="mb-4 p-4 bg-red-50 border border-red-200 rounded-md"
             role="alert"
             aria-live="polite">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">Corrija os seguintes erros:</h3>
                    <ul class="mt-2 text-sm text-red-700 list-disc list-inside">
                        <template x-for="erro in errosGlobais">
                            <li x-text="erro"></li>
                        </template>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Se√ß√£o: Dados do Cliente -->
        <section class="secao-formulario">
            <div class="secao-header" 
                 @click="secaoClienteAberta = !secaoClienteAberta"
                 role="button"
                 :aria-expanded="secaoClienteAberta ? 'true' : 'false'"
                 aria-controls="dados-cliente"
                 tabindex="0"
                 @keydown.enter="secaoClienteAberta = !secaoClienteAberta"
                 @keydown.space.prevent="secaoClienteAberta = !secaoClienteAberta">
                <h2 class="text-lg font-medium text-gray-900">Dados do Cliente</h2>
                <svg class="w-5 h-5 text-gray-500 transition-transform"
                     :class="{ 'transform rotate-180': secaoClienteAberta }"
                     fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            
            <div x-show="secaoClienteAberta" 
                 x-transition
                 id="dados-cliente"
                 class="secao-content">
                
                <!-- Grid responsivo para campos -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- Nome do Cliente -->
                    <div>
                        <label for="cliente-nome" class="block text-sm font-medium text-gray-700 campo-obrigatorio">
                            Nome do Cliente
                        </label>
                        <input type="text"
                               id="cliente-nome"
                               name="cliente_nome"
                               x-model="cliente.nome"
                               @blur="validarCampo('nome')"
                               :class="{ 'campo-invalido': erros.nome }"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pizza-500 focus:ring-pizza-500 sm:text-sm"
                               aria-required="true"
                               aria-invalid="erros.nome ? 'true' : 'false'"
                               aria-describedby="erro-nome"
                               autofocus
                               required>
                        <p x-show="erros.nome" 
                           x-text="erros.nome"
                           id="erro-nome"
                           class="mensagem-erro"
                           role="alert"></p>
                    </div>
                    
                    <!-- Telefone -->
                    <div>
                        <label for="cliente-telefone" class="block text-sm font-medium text-gray-700 campo-obrigatorio">
                            Telefone
                        </label>
                        <input type="tel"
                               id="cliente-telefone"
                               name="cliente_telefone"
                               x-model="cliente.telefone"
                               @blur="validarCampo('telefone')"
                               @input="formatarTelefone"
                               :class="{ 'campo-invalido': erros.telefone }"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pizza-500 focus:ring-pizza-500 sm:text-sm"
                               placeholder="(00) 00000-0000"
                               aria-required="true"
                               aria-invalid="erros.telefone ? 'true' : 'false'"
                               aria-describedby="erro-telefone"
                               required>
                        <p x-show="erros.telefone" 
                           x-text="erros.telefone"
                           id="erro-telefone"
                           class="mensagem-erro"
                           role="alert"></p>
                    </div>
                </div>
                
                <!-- Tipo de Pedido -->
                <div class="mb-4">
                    <fieldset>
                        <legend class="block text-sm font-medium text-gray-700 campo-obrigatorio mb-2">
                            Tipo de Pedido
                        </legend>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <input type="radio"
                                       id="tipo-delivery"
                                       name="tipo_pedido"
                                       value="delivery"
                                       x-model="tipoPedido"
                                       @change="calcularTotais"
                                       class="sr-only peer"
                                       aria-required="true">
                                <label for="tipo-delivery"
                                       class="block w-full px-3 py-2 text-center border rounded-md cursor-pointer peer-checked:bg-pizza-600 peer-checked:text-white peer-checked:border-pizza-600 hover:bg-gray-50"
                                       tabindex="0"
                                       @keydown.enter="tipoPedido = 'delivery'; calcularTotais()"
                                       @keydown.space.prevent="tipoPedido = 'delivery'; calcularTotais()">
                                    üöö Delivery
                                </label>
                            </div>
                            
                            <div>
                                <input type="radio"
                                       id="tipo-balcao"
                                       name="tipo_pedido"
                                       value="balcao"
                                       x-model="tipoPedido"
                                       @change="calcularTotais"
                                       class="sr-only peer"
                                       aria-required="true">
                                <label for="tipo-balcao"
                                       class="block w-full px-3 py-2 text-center border rounded-md cursor-pointer peer-checked:bg-pizza-600 peer-checked:text-white peer-checked:border-pizza-600 hover:bg-gray-50"
                                       tabindex="0"
                                       @keydown.enter="tipoPedido = 'balcao'; calcularTotais()"
                                       @keydown.space.prevent="tipoPedido = 'balcao'; calcularTotais()">
                                    üè™ Balc√£o
                                </label>
                            </div>
                            
                            <div>
                                <input type="radio"
                                       id="tipo-mesa"
                                       name="tipo_pedido"
                                       value="mesa"
                                       x-model="tipoPedido"
                                       @change="calcularTotais"
                                       class="sr-only peer"
                                       aria-required="true">
                                <label for="tipo-mesa"
                                       class="block w-full px-3 py-2 text-center border rounded-md cursor-pointer peer-checked:bg-pizza-600 peer-checked:text-white peer-checked:border-pizza-600 hover:bg-gray-50"
                                       tabindex="0"
                                       @keydown.enter="tipoPedido = 'mesa'; calcularTotais()"
                                       @keydown.space.prevent="tipoPedido = 'mesa'; calcularTotais()">
                                    üçΩÔ∏è Mesa
                                </label>
                            </div>
                        </div>
                    </fieldset>
                </div>
                
                <!-- Endere√ßo (apenas para Delivery) -->
                <div x-show="tipoPedido === 'delivery'" 
                     x-transition
                     class="mb-4">
                    <label for="endereco" class="block text-sm font-medium text-gray-700 campo-obrigatorio">
                        Endere√ßo de Entrega
                    </label>
                    <textarea id="endereco"
                              name="endereco"
                              x-model="endereco"
                              @blur="validarCampo('endereco')"
                              :class="{ 'campo-invalido': erros.endereco }"
                              rows="3"
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pizza-500 focus:ring-pizza-500 sm:text-sm"
                              placeholder="Rua, n√∫mero, bairro, refer√™ncia..."
                              :aria-required="tipoPedido === 'delivery' ? 'true' : 'false'"
                              :aria-invalid="erros.endereco ? 'true' : 'false'"
                              aria-describedby="erro-endereco"
                              :required="tipoPedido === 'delivery'"></textarea>
                    <p x-show="erros.endereco" 
                       x-text="erros.endereco"
                       id="erro-endereco"
                       class="mensagem-erro"
                       role="alert"></p>
                </div>
                
                <!-- N√∫mero da Mesa (apenas para Mesa) -->
                <div x-show="tipoPedido === 'mesa'" 
                     x-transition
                     class="mb-4">
                    <label for="numero-mesa" class="block text-sm font-medium text-gray-700 campo-obrigatorio">
                        N√∫mero da Mesa
                    </label>
                    <input type="text"
                           id="numero-mesa"
                           name="numero_mesa"
                           x-model="numeroMesa"
                           @blur="validarCampo('numeroMesa')"
                           :class="{ 'campo-invalido': erros.numeroMesa }"
                           class="mt-1 block w-32 rounded-md border-gray-300 shadow-sm focus:border-pizza-500 focus:ring-pizza-500 sm:text-sm"
                           placeholder="Ex: 12"
                           :aria-required="tipoPedido === 'mesa' ? 'true' : 'false'"
                           :aria-invalid="erros.numeroMesa ? 'true' : 'false'"
                           aria-describedby="erro-mesa"
                           :required="tipoPedido === 'mesa'">
                    <p x-show="erros.numeroMesa" 
                       x-text="erros.numeroMesa"
                       id="erro-mesa"
                       class="mensagem-erro"
                       role="alert"></p>
                </div>
            </div>
        </section>
        
        <!-- Se√ß√£o: Produtos e Carrinho -->
        <section class="secao-formulario">
            <div class="secao-header" 
                 @click="secaoProdutosAberta = !secaoProdutosAberta"
                 role="button"
                 :aria-expanded="secaoProdutosAberta ? 'true' : 'false'"
                 aria-controls="produtos"
                 tabindex="0"
                 @keydown.enter="secaoProdutosAberta = !secaoProdutosAberta"
                 @keydown.space.prevent="secaoProdutosAberta = !secaoProdutosAberta">
                <h2 class="text-lg font-medium text-gray-900">
                    Produtos
                    <span x-show="carrinho.length > 0" 
                          class="ml-2 px-2 py-1 text-xs bg-pizza-600 text-white rounded-full">
                        <span x-text="carrinho.length"></span>
                    </span>
                </h2>
                <svg class="w-5 h-5 text-gray-500 transition-transform"
                     :class="{ 'transform rotate-180': secaoProdutosAberta }"
                     fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            
            <div x-show="secaoProdutosAberta" 
                 x-transition
                 id="produtos"
                 class="secao-content">
                
                <!-- Layout com produtos e carrinho -->
                <div class="layout-produtos flex flex-col lg:flex-row gap-6">
                    
                    <!-- √Årea de Produtos -->
                    <div class="flex-1">
                        <!-- Abas de Categorias -->
                        <div class="flex flex-wrap gap-2 mb-6">
                            <button type="button"
                                    @click="abaAtiva = 'pizzas'"
                                    :class="abaAtiva === 'pizzas' ? 'aba-produto active' : 'aba-produto'"
                                    class="aba-produto">
                                üçï Pizzas
                            </button>
                            <button type="button"
                                    @click="abaAtiva = 'bebidas'"
                                    :class="abaAtiva === 'bebidas' ? 'aba-produto active' : 'aba-produto'"
                                    class="aba-produto">
                                ü•§ Bebidas
                            </button>
                            <button type="button"
                                    @click="abaAtiva = 'sobremesas'"
                                    :class="abaAtiva === 'sobremesas' ? 'aba-produto active' : 'aba-produto'"
                                    class="aba-produto">
                                üç∞ Sobremesas
                            </button>
                            <button type="button"
                                    @click="abaAtiva = 'acompanhamentos'"
                                    :class="abaAtiva === 'acompanhamentos' ? 'aba-produto active' : 'aba-produto'"
                                    class="aba-produto">
                                üçü Acompanhamentos
                            </button>
                        </div>
                        
                        <!-- Conte√∫do das Abas -->
                        
                        <!-- Aba Pizzas -->
                        <div x-show="abaAtiva === 'pizzas'" class="space-y-4">
                            <!-- Loading state -->
                            <div x-show="carregandoProdutos" class="text-center py-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pizza-600 mx-auto mb-4"></div>
                                <p class="text-gray-600">Carregando pizzas...</p>
                            </div>
                            
                            <!-- Erro ao carregar -->
                            <div x-show="erroProdutos && !carregandoProdutos" class="bg-red-50 border border-red-200 rounded-md p-4 text-center">
                                <p class="text-red-600" x-text="erroProdutos"></p>
                                <button @click="carregarProdutos()" class="mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                                    Tentar Novamente
                                </button>
                            </div>
                            
                            <!-- Produtos carregados -->
                            <template x-for="pizza in produtos.pizzas" :key="pizza.id">
                                <div class="produto-card pizza">
                                    <div class="flex items-start">
                                        <div class="w-16 h-16 bg-pizza-100 rounded-lg flex items-center justify-center text-2xl mr-4">
                                            üçï
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="text-lg font-semibold text-gray-900" x-text="pizza.nome"></h3>
                                            <p class="text-sm text-gray-600 mb-3" x-text="pizza.ingredientes"></p>
                                            
                                            <!-- Seletor de Tamanho -->
                                            <div class="tamanho-selector">
                                                <template x-for="tamanho in pizza.tamanhos" :key="tamanho.size">
                                                    <div class="tamanho-option">
                                                        <input type="radio"
                                                               :id="`pizza-${pizza.id}-${tamanho.size}`"
                                                               :name="`pizza-${pizza.id}`"
                                                               :value="tamanho.size"
                                                               x-model="pizzaSelecionada[pizza.id]">
                                                        <label :for="`pizza-${pizza.id}-${tamanho.size}`">
                                                            <div class="font-medium" x-text="tamanho.size"></div>
                                                            <div class="text-xs" x-text="`R$ ${tamanho.preco.toFixed(2)}`"></div>
                                                        </label>
                                                    </div>
                                                </template>
                                            </div>
                                            
                                            <button type="button"
                                                    @click="adicionarPizza(pizza)"
                                                    :disabled="!pizzaSelecionada[pizza.id]"
                                                    :class="{ 
                                                        'btn-adicionar': true,
                                                        'bg-green-600 hover:bg-green-700': pizzaAdicionada[pizza.id],
                                                        'bg-pizza-600 hover:bg-pizza-700': !pizzaAdicionada[pizza.id]
                                                    }">
                                                <span x-show="!pizzaAdicionada[pizza.id] && !pizzaSelecionada[pizza.id]">
                                                    Selecione um tamanho
                                                </span>
                                                <span x-show="!pizzaAdicionada[pizza.id] && pizzaSelecionada[pizza.id]">
                                                    üõí Adicionar 
                                                    <span x-text="pizzaSelecionada[pizza.id]"></span> - 
                                                    R$ <span x-text="obterPrecoTamanho(pizza, pizzaSelecionada[pizza.id])"></span>
                                                </span>
                                                <span x-show="pizzaAdicionada[pizza.id]">
                                                    ‚úÖ Adicionado!
                                                </span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Aba Bebidas -->
                        <div x-show="abaAtiva === 'bebidas'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <template x-for="bebida in produtos.bebidas" :key="bebida.id">
                                <div class="produto-card">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-xl mr-3">
                                            ü•§
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold text-gray-900" x-text="bebida.nome"></h3>
                                            <p class="text-pizza-600 font-medium" x-text="`R$ ${bebida.preco.toFixed(2)}`"></p>
                                        </div>
                                        <button type="button"
                                                @click="adicionarItem(bebida, 'bebida')"
                                                class="w-8 h-8 bg-pizza-600 text-white rounded-full hover:bg-pizza-700 transition-colors">
                                            +
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Aba Sobremesas -->
                        <div x-show="abaAtiva === 'sobremesas'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <template x-for="sobremesa in produtos.sobremesas" :key="sobremesa.id">
                                <div class="produto-card">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center text-xl mr-3">
                                            üç∞
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold text-gray-900" x-text="sobremesa.nome"></h3>
                                            <p class="text-pizza-600 font-medium" x-text="`R$ ${sobremesa.preco.toFixed(2)}`"></p>
                                        </div>
                                        <button type="button"
                                                @click="adicionarItem(sobremesa, 'sobremesa')"
                                                class="w-8 h-8 bg-pizza-600 text-white rounded-full hover:bg-pizza-700 transition-colors">
                                            +
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Aba Acompanhamentos -->
                        <div x-show="abaAtiva === 'acompanhamentos'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <template x-for="acompanhamento in produtos.acompanhamentos" :key="acompanhamento.id">
                                <div class="produto-card">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center text-xl mr-3">
                                            üçü
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold text-gray-900" x-text="acompanhamento.nome"></h3>
                                            <p class="text-pizza-600 font-medium" x-text="`R$ ${acompanhamento.preco.toFixed(2)}`"></p>
                                        </div>
                                        <button type="button"
                                                @click="adicionarItem(acompanhamento, 'acompanhamento')"
                                                class="w-8 h-8 bg-pizza-600 text-white rounded-full hover:bg-pizza-700 transition-colors">
                                            +
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Carrinho Lateral -->
                    <div class="w-full lg:w-80">
                        <div class="carrinho-lateral">
                            <div class="p-4 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                    üõí Carrinho
                                    <span x-show="carrinho.length > 0" 
                                          class="ml-2 px-2 py-1 text-xs bg-pizza-600 text-white rounded-full">
                                        <span x-text="carrinho.length"></span>
                                    </span>
                                </h3>
                            </div>
                            
                            <div class="p-4">
                                <!-- Itens do Carrinho -->
                                <div x-show="carrinho.length > 0" class="space-y-3 mb-4">
                                    <template x-for="(item, index) in carrinho" :key="index">
                                        <div class="carrinho-item">
                                            <div class="carrinho-item-info">
                                                <h4 class="font-medium text-gray-900" x-text="item.nome"></h4>
                                                <p x-show="item.tamanho" class="text-xs text-gray-500">
                                                    Tamanho: <span x-text="item.tamanho"></span>
                                                </p>
                                                <p class="text-sm text-pizza-600 font-medium">
                                                    R$ <span x-text="(item.preco * item.quantidade).toFixed(2)"></span>
                                                </p>
                                            </div>
                                            <div class="carrinho-item-controls">
                                                <button type="button"
                                                        @click="diminuirQuantidade(index)"
                                                        :class="{ 'disabled': item.quantidade <= 1 }"
                                                        class="quantidade-control">
                                                    ‚àí
                                                </button>
                                                <span class="w-8 text-center text-sm font-medium" x-text="item.quantidade"></span>
                                                <button type="button"
                                                        @click="aumentarQuantidade(index)"
                                                        class="quantidade-control">
                                                    +
                                                </button>
                                                <button type="button"
                                                        @click="removerItem(index)"
                                                        class="ml-2 text-red-500 hover:text-red-700">
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Carrinho Vazio -->
                                <div x-show="carrinho.length === 0" class="text-center py-8 text-gray-500">
                                    <div class="text-4xl mb-2">üõí</div>
                                    <p>Carrinho vazio</p>
                                    <p class="text-sm">Adicione produtos para continuar</p>
                                </div>
                                
                                <!-- Totais -->
                                <div x-show="carrinho.length > 0" class="carrinho-totais">
                                    <div class="total-linha">
                                        <span>Subtotal:</span>
                                        <span>R$ <span x-text="subtotal.toFixed(2)"></span></span>
                                    </div>
                                    <div x-show="tipoPedido === 'delivery'" class="total-linha">
                                        <span>Taxa de Entrega:</span>
                                        <span>R$ <span x-text="taxaEntrega.toFixed(2)"></span></span>
                                    </div>
                                    <div x-show="subtotal < pedidoMinimo && tipoPedido === 'delivery'" class="total-linha text-amber-600">
                                        <span class="text-xs">Pedido m√≠nimo: R$ <span x-text="pedidoMinimo.toFixed(2)"></span></span>
                                    </div>
                                    <div class="total-linha final">
                                        <span>Total:</span>
                                        <span>R$ <span x-text="total.toFixed(2)"></span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Bot√µes de A√ß√£o -->
        <div class="flex justify-between mt-6">
            <button type="button"
                    @click="cancelar"
                    class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                Cancelar
            </button>
            
            <button type="submit"
                    :disabled="!formularioValido"
                    :class="{ 'opacity-50 cursor-not-allowed': !formularioValido }"
                    class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-pizza-600 hover:bg-pizza-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pizza-500 disabled:hover:bg-pizza-600"
                    aria-label="Confirmar pedido. Certifique-se de preencher todos os campos obrigat√≥rios.">
                <span x-show="!formularioValido">Preencha os dados</span>
                <span x-show="formularioValido">Confirmar Pedido - R$ <span x-text="total.toFixed(2)"></span></span>
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
function pedidoForm() {
    return {
        // Estado do formul√°rio
        secaoClienteAberta: true,
        secaoProdutosAberta: true,
        abaAtiva: 'pizzas',
        
        // Dados do formul√°rio
        cliente: {
            nome: '',
            telefone: ''
        },
        tipoPedido: 'delivery',
        endereco: '',
        numeroMesa: '',
        
        // Carrinho e produtos
        carrinho: [],
        pizzaSelecionada: {},
        pizzaAdicionada: {},
        pedidoMinimo: 25.00,
        taxaEntrega: 5.00,
        
        // Valida√ß√£o
        erros: {},
        errosGlobais: [],
        
        // Produtos carregados da API
        produtos: {
            pizzas: [],
            bebidas: [],
            sobremesas: [],
            acompanhamentos: []
        },
        produtosCarregados: false,
        carregandoProdutos: false,
        erroProdutos: '',
        
        // Carregar produtos da API
        async carregarProdutos() {
            if (this.produtosCarregados || this.carregandoProdutos) {
                return;
            }
            
            this.carregandoProdutos = true;
            this.erroProdutos = '';
            
            try {
                console.log('üîÑ Carregando produtos da API...');
                
                const response = await fetch('/api/produtos/produtos/para_pedido/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Produtos carregados:', data);
                
                // Atualizar dados
                this.produtos = data;
                this.produtosCarregados = true;
                
                // Log para debug
                console.log(`üìä Produtos por categoria:
  üçï Pizzas: ${data.pizzas?.length || 0}
  ü•§ Bebidas: ${data.bebidas?.length || 0} 
  üç∞ Sobremesas: ${data.sobremesas?.length || 0}
  üçü Acompanhamentos: ${data.acompanhamentos?.length || 0}`);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar produtos:', error);
                this.erroProdutos = `Erro ao carregar produtos: ${error.message}`;
                
                // Fallback com dados vazios em caso de erro
                this.produtos = {
                    pizzas: [],
                    bebidas: [],
                    sobremesas: [],
                    acompanhamentos: []
                };
            } finally {
                this.carregandoProdutos = false;
            }
        },
        
        // Computed properties
        get subtotal() {
            return this.carrinho.reduce((total, item) => total + (item.preco * item.quantidade), 0);
        },
        
        get total() {
            let total = this.subtotal;
            if (this.tipoPedido === 'delivery') {
                total += this.taxaEntrega;
            }
            return total;
        },
        
        get formularioValido() {
            const nomeValido = this.cliente.nome.trim().length >= 3;
            const telefoneValido = this.cliente.telefone.replace(/\D/g, '').length >= 10;
            const carrinhoValido = this.carrinho.length > 0;
            
            let tipoValido = true;
            if (this.tipoPedido === 'delivery') {
                tipoValido = this.endereco.trim().length > 0;
                // Verificar pedido m√≠nimo para delivery
                if (this.subtotal < this.pedidoMinimo) {
                    tipoValido = false;
                }
            } else if (this.tipoPedido === 'mesa') {
                tipoValido = this.numeroMesa.trim().length > 0;
            }
            
            return nomeValido && telefoneValido && tipoValido && carrinhoValido;
        },
        
        async init() {
            this.$nextTick(() => {
                document.getElementById('cliente-nome')?.focus();
            });
            
            // Carregar produtos da API
            await this.carregarProdutos();
        },
        
        // Valida√ß√£o individual de campos
        validarCampo(campo) {
            this.erros[campo] = '';
            
            switch(campo) {
                case 'nome':
                    if (!this.cliente.nome.trim()) {
                        this.erros.nome = 'Nome √© obrigat√≥rio';
                    } else if (this.cliente.nome.trim().length < 3) {
                        this.erros.nome = 'Nome deve ter pelo menos 3 caracteres';
                    }
                    break;
                    
                case 'telefone':
                    const telefoneNumeros = this.cliente.telefone.replace(/\D/g, '');
                    if (!telefoneNumeros) {
                        this.erros.telefone = 'Telefone √© obrigat√≥rio';
                    } else if (telefoneNumeros.length < 10) {
                        this.erros.telefone = 'Telefone deve ter pelo menos 10 d√≠gitos';
                    }
                    break;
                    
                case 'endereco':
                    if (this.tipoPedido === 'delivery' && !this.endereco.trim()) {
                        this.erros.endereco = 'Endere√ßo √© obrigat√≥rio para delivery';
                    }
                    break;
                    
                case 'numeroMesa':
                    if (this.tipoPedido === 'mesa' && !this.numeroMesa.trim()) {
                        this.erros.numeroMesa = 'N√∫mero da mesa √© obrigat√≥rio';
                    }
                    break;
            }
        },
        
        // Formata√ß√£o de telefone
        formatarTelefone() {
            let value = this.cliente.telefone.replace(/\D/g, '');
            if (value.length > 0) {
                if (value.length <= 10) {
                    value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                } else {
                    value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                }
            }
            this.cliente.telefone = value;
        },
        
        // Gerenciamento do carrinho
        adicionarPizza(pizza) {
            const tamanhoSelecionado = this.pizzaSelecionada[pizza.id];
            if (!tamanhoSelecionado) return;
            
            const tamanho = pizza.tamanhos.find(t => t.size === tamanhoSelecionado);
            const item = {
                id: `pizza-${pizza.id}-${tamanho.size}`, // ID √∫nico para pizza + tamanho
                produto_id: pizza.id,
                nome: `Pizza ${pizza.nome}`,
                tipo: 'pizza',
                tamanho: tamanho.size,
                preco: tamanho.preco,
                ingredientes: pizza.ingredientes,
                quantidade: 1
            };
            
            // Verificar se j√° existe no carrinho (mesma pizza e tamanho)
            const itemExistente = this.carrinho.find(i => i.id === item.id);
            
            if (itemExistente) {
                itemExistente.quantidade++;
            } else {
                this.carrinho.push(item);
            }
            
            // Feedback visual
            this.pizzaAdicionada[pizza.id] = true;
            
            // Limpar sele√ß√£o ap√≥s 2 segundos
            setTimeout(() => {
                this.pizzaSelecionada[pizza.id] = '';
                this.pizzaAdicionada[pizza.id] = false;
            }, 2000);
            
            this.calcularTotais();
        },
        
        // Fun√ß√£o auxiliar para obter pre√ßo do tamanho
        obterPrecoTamanho(pizza, tamanho) {
            if (!tamanho) return '0.00';
            const tamanhoObj = pizza.tamanhos.find(t => t.size === tamanho);
            return tamanhoObj ? tamanhoObj.preco.toFixed(2) : '0.00';
        },
        
        adicionarItem(produto, tipo) {
            const item = {
                id: `${tipo}-${produto.id}`, // ID √∫nico para n√£o-pizzas
                produto_id: produto.id,
                nome: produto.nome,
                tipo: tipo,
                preco: produto.preco,
                quantidade: 1
            };
            
            // Verificar se j√° existe no carrinho
            const itemExistente = this.carrinho.find(i => i.id === item.id);
            
            if (itemExistente) {
                itemExistente.quantidade++;
            } else {
                this.carrinho.push(item);
            }
            
            this.calcularTotais();
        },
        
        aumentarQuantidade(index) {
            this.carrinho[index].quantidade++;
            this.calcularTotais();
        },
        
        diminuirQuantidade(index) {
            if (this.carrinho[index].quantidade > 1) {
                this.carrinho[index].quantidade--;
                this.calcularTotais();
            }
        },
        
        removerItem(index) {
            this.carrinho.splice(index, 1);
            this.calcularTotais();
        },
        
        calcularTotais() {
            // For√ßar reatividade
            this.$nextTick(() => {
                // Os computed properties j√° fazem o c√°lculo
            });
        },
        
        // Valida√ß√£o completa do formul√°rio
        validarFormulario() {
            this.errosGlobais = [];
            
            // Validar todos os campos
            this.validarCampo('nome');
            this.validarCampo('telefone');
            
            if (this.tipoPedido === 'delivery') {
                this.validarCampo('endereco');
                if (this.subtotal < this.pedidoMinimo) {
                    this.errosGlobais.push(`Pedido m√≠nimo para delivery: R$ ${this.pedidoMinimo.toFixed(2)}`);
                }
            } else if (this.tipoPedido === 'mesa') {
                this.validarCampo('numeroMesa');
            }
            
            // Verificar carrinho
            if (this.carrinho.length === 0) {
                this.errosGlobais.push('Adicione pelo menos um produto ao carrinho');
            }
            
            // Coletar erros
            Object.values(this.erros).forEach(erro => {
                if (erro) this.errosGlobais.push(erro);
            });
            
            return this.errosGlobais.length === 0;
        },
        
        // Cancelar pedido
        cancelar() {
            if (confirm('Tem certeza que deseja cancelar o pedido?')) {
                window.location.reload();
            }
        },
        
        // Submeter formul√°rio
        submitForm() {
            if (this.validarFormulario()) {
                // Preparar dados para envio
                const dados = {
                    cliente_nome: this.cliente.nome,
                    cliente_telefone: this.cliente.telefone,
                    tipo_pedido: this.tipoPedido,
                    endereco: this.tipoPedido === 'delivery' ? this.endereco : '',
                    numero_mesa: this.tipoPedido === 'mesa' ? this.numeroMesa : '',
                    itens: this.carrinho,
                    subtotal: this.subtotal,
                    taxa_entrega: this.tipoPedido === 'delivery' ? this.taxaEntrega : 0,
                    total: this.total
                };
                
                console.log('Pedido confirmado:', dados);
                
                alert(`Pedido confirmado!\nTotal: R$ ${this.total.toFixed(2)}\nItens: ${this.carrinho.length}`);
                
                // Redirecionar para lista de pedidos
                window.location.href = "{% url 'pedido_list' %}";
            } else {
                // Focar no primeiro erro
                const primeiroErro = document.querySelector('.campo-invalido');
                if (primeiroErro) {
                    primeiroErro.focus();
                    primeiroErro.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
    }
}
</script>
{% endblock %}