{% extends 'layouts/dashboard.html' %}
{% load static %}

{% block title %}{% if object %}Editar{% else %}Novo{% endif %} Pedido - Pizzaria{% endblock %}

{% block extra_css %}
<style>
    /* Estilos para campos inv√°lidos */
    .campo-invalido {
        border-color: #DC2626 !important;
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }
    
    /* Estilos para mensagens de erro */
    .mensagem-erro {
        color: #DC2626;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    /* Estilos para campos obrigat√≥rios */
    .campo-obrigatorio::after {
        content: ' *';
        color: #DC2626;
    }
    
    /* Estilos para se√ß√µes */
    .secao-formulario {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        overflow: hidden;
    }
    
    .secao-header {
        padding: 1rem 1.5rem;
        background: #F9FAFB;
        border-bottom: 1px solid #E5E7EB;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .secao-header:hover {
        background: #F3F4F6;
    }
    
    .secao-content {
        padding: 1.5rem;
    }
    
    /* Estilos para abas de produtos */
    .aba-produto {
        @apply px-4 py-2 text-sm font-medium rounded-lg cursor-pointer transition-all;
    }
    
    .aba-produto.active {
        @apply bg-pizza-600 text-white;
    }
    
    .aba-produto:not(.active) {
        @apply bg-gray-100 text-gray-700 hover:bg-gray-200;
    }
    
    /* Cards de produtos */
    .produto-card {
        @apply bg-white border border-gray-200 rounded-lg p-4 transition-all hover:shadow-md;
    }
    
    .produto-card.pizza {
        @apply relative;
    }
    
    /* Seletor de tamanho para pizzas */
    .tamanho-selector {
        @apply grid grid-cols-2 sm:grid-cols-4 gap-2 mt-3;
    }
    
    .tamanho-option {
        @apply relative;
    }
    
    .tamanho-option input[type="radio"] {
        @apply sr-only peer;
    }
    
    .tamanho-option label {
        @apply block w-full px-3 py-2 text-center text-sm border rounded-md cursor-pointer transition-all;
        @apply peer-checked:bg-pizza-600 peer-checked:text-white peer-checked:border-pizza-600;
        @apply hover:bg-gray-50 peer-checked:hover:bg-pizza-700;
    }
    
    /* Carrinho lateral */
    .carrinho-lateral {
        @apply sticky top-4 bg-white border border-gray-200 rounded-lg shadow-lg h-fit;
    }
    
    .carrinho-item {
        @apply flex justify-between items-start py-3 border-b border-gray-100 last:border-b-0;
    }
    
    .carrinho-item-info {
        @apply flex-1 mr-3;
    }
    
    .carrinho-item-controls {
        @apply flex items-center space-x-2;
    }
    
    .quantidade-control {
        @apply w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center cursor-pointer hover:bg-gray-50 transition-colors;
    }
    
    .quantidade-control:hover {
        @apply border-pizza-500 text-pizza-600;
    }
    
    .quantidade-control.disabled {
        @apply opacity-50 cursor-not-allowed;
    }
    
    /* Bot√£o adicionar produto */
    .btn-adicionar {
        @apply w-full mt-3 px-4 py-2 bg-pizza-600 text-white rounded-lg hover:bg-pizza-700 transition-colors;
        @apply disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-pizza-600;
    }
    
    /* Totais do carrinho */
    .carrinho-totais {
        @apply space-y-2 pt-4 border-t border-gray-200;
    }
    
    .total-linha {
        @apply flex justify-between text-sm;
    }
    
    .total-linha.final {
        @apply text-lg font-bold text-pizza-600 pt-2 border-t border-gray-200;
    }
    
    /* Estilos da Tabela de Pizzas (copiado do card√°pio) */
    .pizza-table {
        font-family: 'Inter', sans-serif;
    }
    
    .pizza-table th {
        background-color: #F8FAFC;
        color: #64748B;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        border-bottom: 2px solid #E2E8F0;
        padding: 1rem;
    }
    
    .pizza-table th:first-child {
        text-align: left;
        padding-left: 1.5rem;
    }
    
    .pizza-row {
        border-bottom: 1px solid #F1F5F9;
        transition: all 0.15s ease-in-out;
    }
    
    .pizza-row:hover {
        background-color: #FEF2F2;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .pizza-name {
        font-weight: 700;
        color: #1E293B;
        font-size: 1rem;
        letter-spacing: -0.025em;
    }
    
    .pizza-ingredients {
        color: #64748B;
        font-size: 0.875rem;
        line-height: 1.4;
        margin-top: 0.25rem;
    }
    
    .price-cell {
        font-weight: 700;
        color: #10B981;
        font-size: 1rem;
        font-variant-numeric: tabular-nums;
    }
    
    .price-cell.promo {
        color: #DC2626;
    }
    
    .original-price {
        text-decoration: line-through;
        color: #94A3B8;
        font-size: 0.75rem;
        font-weight: 400;
    }
    
    .category-header {
        background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
        color: white;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-size: 0.875rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    /* Melhorias visuais para pizzas */
    .search-highlight {
        background-color: #FEF3C7;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
    }
    
    .add-button-hover:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
    }
    
    /* Responsividade */
    @media (max-width: 1024px) {
        .layout-produtos {
            @apply flex-col;
        }
        
        .carrinho-lateral {
            @apply static order-first mb-6;
        }
    }
    
    @media (max-width: 640px) {
        .secao-content {
            padding: 1rem;
        }
        
        .tamanho-selector {
            @apply grid-cols-2;
        }
        
        .carrinho-lateral {
            @apply mx-4;
        }
        
        .pizza-card {
            border: 1px solid #E5E7EB;
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            background: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: all 0.15s;
        }
        
        .pizza-card:active {
            transform: scale(0.98);
            box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.1);
        }
        
        .price-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        
        .price-item {
            background: #F8FAFC;
            border: 1px solid #E2E8F0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            text-align: center;
            transition: all 0.15s;
        }
        
        .price-item:hover {
            background: #F1F5F9;
            border-color: #CBD5E1;
        }
        
        .price-label {
            font-size: 0.75rem;
            color: #64748B;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        .price-value {
            font-size: 1.125rem;
            font-weight: 700;
            color: #10B981;
            margin-top: 0.125rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div x-data="pedidoForm()" x-init="init()">
    <form method="post" @submit.prevent="submitForm" novalidate>
        {% csrf_token %}
        
        <!-- Cabe√ßalho -->
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-900">
                {% if object %}Editar Pedido #{{ object.numero }}{% else %}Novo Pedido{% endif %}
            </h1>
            <p class="mt-1 text-sm text-gray-600">Preencha os dados do cliente e selecione os produtos desejados</p>
        </div>
        
        <!-- Mensagens de erro global -->
        <div x-show="errosGlobais.length > 0" 
             class="mb-4 p-4 bg-red-50 border border-red-200 rounded-md"
             role="alert"
             aria-live="polite">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">Corrija os seguintes erros:</h3>
                    <ul class="mt-2 text-sm text-red-700 list-disc list-inside">
                        <template x-for="erro in errosGlobais">
                            <li x-text="erro"></li>
                        </template>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Se√ß√£o: Dados do Cliente -->
        <section class="secao-formulario">
            <div class="secao-header" 
                 @click="secaoClienteAberta = !secaoClienteAberta"
                 role="button"
                 :aria-expanded="secaoClienteAberta ? 'true' : 'false'"
                 aria-controls="dados-cliente"
                 tabindex="0"
                 @keydown.enter="secaoClienteAberta = !secaoClienteAberta"
                 @keydown.space.prevent="secaoClienteAberta = !secaoClienteAberta">
                <h2 class="text-lg font-medium text-gray-900">Dados do Cliente</h2>
                <svg class="w-5 h-5 text-gray-500 transition-transform"
                     :class="{ 'transform rotate-180': secaoClienteAberta }"
                     fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            
            <div x-show="secaoClienteAberta" 
                 x-transition
                 id="dados-cliente"
                 class="secao-content">
                
                <!-- Grid responsivo para campos -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- Nome do Cliente -->
                    <div>
                        <label for="cliente-nome" class="block text-sm font-medium text-gray-700 campo-obrigatorio">
                            Nome do Cliente
                        </label>
                        <input type="text"
                               id="cliente-nome"
                               name="cliente_nome"
                               x-model="cliente.nome"
                               @blur="validarCampo('nome')"
                               :class="{ 'campo-invalido': erros.nome }"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pizza-500 focus:ring-pizza-500 sm:text-sm"
                               aria-required="true"
                               aria-invalid="erros.nome ? 'true' : 'false'"
                               aria-describedby="erro-nome"
                               autofocus
                               required>
                        <p x-show="erros.nome" 
                           x-text="erros.nome"
                           id="erro-nome"
                           class="mensagem-erro"
                           role="alert"></p>
                    </div>
                    
                    <!-- Telefone -->
                    <div>
                        <label for="cliente-telefone" class="block text-sm font-medium text-gray-700 campo-obrigatorio">
                            Telefone
                        </label>
                        <input type="tel"
                               id="cliente-telefone"
                               name="cliente_telefone"
                               x-model="cliente.telefone"
                               @blur="validarCampo('telefone')"
                               @input="formatarTelefone"
                               :class="{ 'campo-invalido': erros.telefone }"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pizza-500 focus:ring-pizza-500 sm:text-sm"
                               placeholder="(00) 00000-0000"
                               aria-required="true"
                               aria-invalid="erros.telefone ? 'true' : 'false'"
                               aria-describedby="erro-telefone"
                               required>
                        <p x-show="erros.telefone" 
                           x-text="erros.telefone"
                           id="erro-telefone"
                           class="mensagem-erro"
                           role="alert"></p>
                    </div>
                </div>
                
                <!-- Tipo de Pedido -->
                <div class="mb-4">
                    <fieldset>
                        <legend class="block text-sm font-medium text-gray-700 campo-obrigatorio mb-2">
                            Tipo de Pedido
                        </legend>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <input type="radio"
                                       id="tipo-delivery"
                                       name="tipo_pedido"
                                       value="delivery"
                                       x-model="tipoPedido"
                                       @change="calcularTotais"
                                       class="sr-only peer"
                                       aria-required="true">
                                <label for="tipo-delivery"
                                       class="block w-full px-3 py-2 text-center border rounded-md cursor-pointer peer-checked:bg-pizza-600 peer-checked:text-white peer-checked:border-pizza-600 hover:bg-gray-50"
                                       tabindex="0"
                                       @keydown.enter="tipoPedido = 'delivery'; calcularTotais()"
                                       @keydown.space.prevent="tipoPedido = 'delivery'; calcularTotais()">
                                    üöö Delivery
                                </label>
                            </div>
                            
                            <div>
                                <input type="radio"
                                       id="tipo-balcao"
                                       name="tipo_pedido"
                                       value="balcao"
                                       x-model="tipoPedido"
                                       @change="calcularTotais"
                                       class="sr-only peer"
                                       aria-required="true">
                                <label for="tipo-balcao"
                                       class="block w-full px-3 py-2 text-center border rounded-md cursor-pointer peer-checked:bg-pizza-600 peer-checked:text-white peer-checked:border-pizza-600 hover:bg-gray-50"
                                       tabindex="0"
                                       @keydown.enter="tipoPedido = 'balcao'; calcularTotais()"
                                       @keydown.space.prevent="tipoPedido = 'balcao'; calcularTotais()">
                                    üè™ Balc√£o
                                </label>
                            </div>
                            
                            <div>
                                <input type="radio"
                                       id="tipo-mesa"
                                       name="tipo_pedido"
                                       value="mesa"
                                       x-model="tipoPedido"
                                       @change="calcularTotais"
                                       class="sr-only peer"
                                       aria-required="true">
                                <label for="tipo-mesa"
                                       class="block w-full px-3 py-2 text-center border rounded-md cursor-pointer peer-checked:bg-pizza-600 peer-checked:text-white peer-checked:border-pizza-600 hover:bg-gray-50"
                                       tabindex="0"
                                       @keydown.enter="tipoPedido = 'mesa'; calcularTotais()"
                                       @keydown.space.prevent="tipoPedido = 'mesa'; calcularTotais()">
                                    üçΩÔ∏è Mesa
                                </label>
                            </div>
                        </div>
                    </fieldset>
                </div>
                
                <!-- Endere√ßo (apenas para Delivery) -->
                <div x-show="tipoPedido === 'delivery'" 
                     x-transition
                     class="mb-4">
                    <label for="endereco" class="block text-sm font-medium text-gray-700 campo-obrigatorio">
                        Endere√ßo de Entrega
                    </label>
                    <textarea id="endereco"
                              name="endereco"
                              x-model="endereco"
                              @blur="validarCampo('endereco')"
                              :class="{ 'campo-invalido': erros.endereco }"
                              rows="3"
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pizza-500 focus:ring-pizza-500 sm:text-sm"
                              placeholder="Rua, n√∫mero, bairro, refer√™ncia..."
                              :aria-required="tipoPedido === 'delivery' ? 'true' : 'false'"
                              :aria-invalid="erros.endereco ? 'true' : 'false'"
                              aria-describedby="erro-endereco"
                              :required="tipoPedido === 'delivery'"></textarea>
                    <p x-show="erros.endereco" 
                       x-text="erros.endereco"
                       id="erro-endereco"
                       class="mensagem-erro"
                       role="alert"></p>
                </div>
                
                <!-- N√∫mero da Mesa (apenas para Mesa) -->
                <div x-show="tipoPedido === 'mesa'" 
                     x-transition
                     class="mb-4">
                    <label for="numero-mesa" class="block text-sm font-medium text-gray-700 campo-obrigatorio">
                        N√∫mero da Mesa
                    </label>
                    <input type="text"
                           id="numero-mesa"
                           name="numero_mesa"
                           x-model="numeroMesa"
                           @blur="validarCampo('numeroMesa')"
                           :class="{ 'campo-invalido': erros.numeroMesa }"
                           class="mt-1 block w-32 rounded-md border-gray-300 shadow-sm focus:border-pizza-500 focus:ring-pizza-500 sm:text-sm"
                           placeholder="Ex: 12"
                           :aria-required="tipoPedido === 'mesa' ? 'true' : 'false'"
                           :aria-invalid="erros.numeroMesa ? 'true' : 'false'"
                           aria-describedby="erro-mesa"
                           :required="tipoPedido === 'mesa'">
                    <p x-show="erros.numeroMesa" 
                       x-text="erros.numeroMesa"
                       id="erro-mesa"
                       class="mensagem-erro"
                       role="alert"></p>
                </div>
            </div>
        </section>
        
        <!-- Se√ß√£o: Produtos e Carrinho -->
        <section class="secao-formulario">
            <div class="secao-header" 
                 @click="secaoProdutosAberta = !secaoProdutosAberta"
                 role="button"
                 :aria-expanded="secaoProdutosAberta ? 'true' : 'false'"
                 aria-controls="produtos"
                 tabindex="0"
                 @keydown.enter="secaoProdutosAberta = !secaoProdutosAberta"
                 @keydown.space.prevent="secaoProdutosAberta = !secaoProdutosAberta">
                <h2 class="text-lg font-medium text-gray-900">
                    Produtos
                    <span x-show="carrinho.length > 0" 
                          class="ml-2 px-2 py-1 text-xs bg-pizza-600 text-white rounded-full">
                        <span x-text="carrinho.length"></span>
                    </span>
                </h2>
                <svg class="w-5 h-5 text-gray-500 transition-transform"
                     :class="{ 'transform rotate-180': secaoProdutosAberta }"
                     fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            
            <div x-show="secaoProdutosAberta" 
                 x-transition
                 id="produtos"
                 class="secao-content">
                
                <!-- Layout com produtos e carrinho -->
                <div class="layout-produtos flex flex-col lg:flex-row gap-6">
                    
                    <!-- √Årea de Produtos -->
                    <div class="flex-1">
                        <!-- Abas de Categorias -->
                        <div class="flex flex-wrap gap-2 mb-6">
                            <button type="button"
                                    @click="abaAtiva = 'pizzas'"
                                    :class="abaAtiva === 'pizzas' ? 'aba-produto active' : 'aba-produto'"
                                    class="aba-produto">
                                üçï Pizzas
                            </button>
                            <button type="button"
                                    @click="abaAtiva = 'bebidas'"
                                    :class="abaAtiva === 'bebidas' ? 'aba-produto active' : 'aba-produto'"
                                    class="aba-produto">
                                ü•§ Bebidas
                            </button>
                            <button type="button"
                                    @click="abaAtiva = 'sobremesas'"
                                    :class="abaAtiva === 'sobremesas' ? 'aba-produto active' : 'aba-produto'"
                                    class="aba-produto">
                                üç∞ Sobremesas
                            </button>
                            <button type="button"
                                    @click="abaAtiva = 'acompanhamentos'"
                                    :class="abaAtiva === 'acompanhamentos' ? 'aba-produto active' : 'aba-produto'"
                                    class="aba-produto">
                                üçü Acompanhamentos
                            </button>
                        </div>
                        
                        <!-- Conte√∫do das Abas -->
                        
                        <!-- Aba Pizzas -->
                        <div x-show="abaAtiva === 'pizzas'" class="space-y-4">

                            <!-- Busca de Pizzas -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                                <div class="relative">
                                    <input type="text" 
                                           x-model="buscaPizza"
                                           @input="filtrarPizzas"
                                           placeholder="üîç Buscar pizza por nome ou ingredientes..."
                                           class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-pizza-500 focus:border-pizza-500 text-lg">
                                    <svg class="absolute left-3 top-3.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                    <div x-show="buscaPizza" 
                                         @click="buscaPizza = ''; filtrarPizzas()"
                                         class="absolute right-3 top-3.5 w-5 h-5 text-gray-400 cursor-pointer hover:text-gray-600">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <!-- Interface Simples e Robusta de Pizzas -->
                            <div x-show="!carregandoProdutos && !erroProdutos" class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                                <!-- Header sempre vis√≠vel -->
                                <div class="px-6 py-3 bg-gradient-to-r from-pizza-600 to-pizza-700 text-white font-bold">
                                    <span class="text-xl">üçï Pizzas Dispon√≠veis</span>
                                    <span x-show="pizzasFiltradas && pizzasFiltradas.length > 0">
                                        (<span x-text="pizzasFiltradas.length"></span>)
                                    </span>
                                </div>
                                
                                <!-- Conte√∫do das pizzas -->
                                <div class="p-4">
                                    <!-- Se h√° pizzas -->
                                    <div x-show="pizzasFiltradas && pizzasFiltradas.length > 0" class="space-y-4">
                                        <template x-for="pizza in pizzasFiltradas" :key="pizza.id">
                                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                                                <div class="flex items-start gap-3 mb-3">
                                                    <span class="text-2xl">üçï</span>
                                                    <div class="flex-1">
                                                        <h3 class="font-bold text-gray-900 uppercase" x-text="pizza.nome"></h3>
                                                        <p class="text-sm text-gray-600 mt-1" x-text="pizza.ingredientes"></p>
                                                    </div>
                                                </div>
                                                
                                                <!-- Grid de Pre√ßos -->
                                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                                    <template x-for="tamanho in ['Pequena', 'M√©dia', 'Grande', 'Fam√≠lia']" :key="tamanho">
                                                        <div x-show="obterPrecoTamanho(pizza, tamanho)" 
                                                             class="text-center p-3 bg-gray-100 rounded-lg">
                                                            <div class="text-xs text-gray-600 font-medium uppercase" x-text="tamanho"></div>
                                                            <div class="text-lg font-bold text-green-600 mt-1">
                                                                R$ <span x-text="obterPrecoTamanho(pizza, tamanho)"></span>
                                                            </div>
                                                            <button type="button"
                                                                    @click="abrirModalPizza(pizza, tamanho)"
                                                                    class="w-full mt-2 px-2 py-1 bg-pizza-600 text-white text-xs rounded hover:bg-pizza-700 transition-colors">
                                                                + Adicionar
                                                            </button>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                    
                                    <!-- Se n√£o h√° pizzas -->
                                    <div x-show="!pizzasFiltradas || pizzasFiltradas.length === 0" class="text-center py-8">
                                        <span class="text-6xl mb-4 block">üçï</span>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2">Aguardando pizzas...</h3>
                                        <p class="text-sm text-gray-600">Os dados est√£o sendo carregados</p>
                                    </div>
                                    
                                </div>
                            </div>

                            <!-- Loading state -->
                            <div x-show="carregandoProdutos" class="text-center py-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pizza-600 mx-auto mb-4"></div>
                                <p class="text-gray-600">Carregando pizzas...</p>
                            </div>
                            
                            <!-- Erro ao carregar -->
                            <div x-show="erroProdutos && !carregandoProdutos" class="bg-red-50 border border-red-200 rounded-md p-4 text-center">
                                <p class="text-red-600" x-text="erroProdutos"></p>
                                <button @click="carregarProdutos()" class="mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                                    Tentar Novamente
                                </button>
                            </div>
                            
                            <!-- Tabela de Pizzas (Desktop) -->
                            <div x-show="!carregandoProdutos && !erroProdutos" class="hidden md:block bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                                <div class="overflow-x-auto">
                                    <table class="w-full pizza-table">
                                        <thead>
                                            <tr>
                                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    üçï Pizza
                                                </th>
                                                <th class="px-4 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Pequena
                                                </th>
                                                <th class="px-4 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    M√©dia
                                                </th>
                                                <th class="px-4 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Grande
                                                </th>
                                                <th class="px-4 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Fam√≠lia
                                                </th>
                                                <th class="px-4 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    A√ß√µes
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <!-- Pizzas por categoria -->
                                            <template x-for="categoria in categoriasOrdenadas" :key="categoria">
                                                <template x-if="obterPizzasPorCategoria(categoria).length > 0">
                                                    <template>
                                                        <!-- Header da Categoria -->
                                                        <tr>
                                                            <td colspan="6" class="px-6 py-3 bg-gradient-to-r from-pizza-600 to-pizza-700 text-white font-bold text-sm uppercase tracking-wider">
                                                                <span x-text="categoria"></span>
                                                            </td>
                                                        </tr>
                                                        
                                                        <!-- Pizzas da Categoria -->
                                                        <template x-for="pizza in obterPizzasPorCategoria(categoria)" :key="pizza.id">
                                                            <tr class="pizza-row hover:bg-red-50 transition-all duration-150">
                                                                <td class="px-6 py-4">
                                                                    <div class="flex items-start gap-3">
                                                                        <span class="text-2xl flex-shrink-0">üçï</span>
                                                                        <div class="flex-1">
                                                                            <div class="pizza-name font-bold text-gray-900 uppercase" x-text="pizza.nome"></div>
                                                                            <div class="pizza-ingredients text-sm text-gray-600 mt-1" x-text="pizza.ingredientes"></div>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                
                                                                <!-- Colunas de Pre√ßos -->
                                                                <template x-for="(tamanho, index) in ['Pequena', 'M√©dia', 'Grande', 'Fam√≠lia']" :key="tamanho">
                                                                    <td class="px-4 py-4 text-center">
                                                                        <template x-if="obterPrecoTamanho(pizza, tamanho)">
                                                                            <div class="space-y-2">
                                                                                <div class="price-cell font-bold text-green-600">
                                                                                    R$ <span x-text="obterPrecoTamanho(pizza, tamanho)"></span>
                                                                                </div>
                                                                                <button type="button"
                                                                                        @click="abrirModalPizza(pizza, tamanho)"
                                                                                        class="px-3 py-1 bg-pizza-600 text-white text-xs rounded-full hover:bg-pizza-700 transition-colors">
                                                                                    + Adicionar
                                                                                </button>
                                                                            </div>
                                                                        </template>
                                                                        <template x-if="!obterPrecoTamanho(pizza, tamanho)">
                                                                            <span class="text-gray-400">-</span>
                                                                        </template>
                                                                    </td>
                                                                </template>
                                                            </tr>
                                                        </template>
                                                    </template>
                                                </template>
                                            </template>
                                            
                                            <!-- Fallback: Mostrar todas as pizzas se categorias n√£o funcionarem -->
                                            <template x-if="categoriasOrdenadas.length === 0 && pizzasFiltradas.length > 0">
                                                <template>
                                                    <!-- Header padr√£o -->
                                                    <tr>
                                                        <td colspan="6" class="px-6 py-3 bg-gradient-to-r from-pizza-600 to-pizza-700 text-white font-bold text-sm uppercase tracking-wider">
                                                            üçï Todas as Pizzas
                                                        </td>
                                                    </tr>
                                                    
                                                    <!-- Todas as pizzas -->
                                                    <template x-for="pizza in pizzasFiltradas" :key="pizza.id">
                                                        <tr class="pizza-row hover:bg-red-50 transition-all duration-150">
                                                            <td class="px-6 py-4">
                                                                <div class="flex items-start gap-3">
                                                                    <span class="text-2xl flex-shrink-0">üçï</span>
                                                                    <div class="flex-1">
                                                                        <div class="pizza-name font-bold text-gray-900 uppercase" x-text="pizza.nome"></div>
                                                                        <div class="pizza-ingredients text-sm text-gray-600 mt-1" x-text="pizza.ingredientes"></div>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            
                                                            <!-- Colunas de Pre√ßos -->
                                                            <template x-for="(tamanho, index) in ['Pequena', 'M√©dia', 'Grande', 'Fam√≠lia']" :key="tamanho">
                                                                <td class="px-4 py-4 text-center">
                                                                    <template x-if="obterPrecoTamanho(pizza, tamanho)">
                                                                        <div class="space-y-2">
                                                                            <div class="price-cell font-bold text-green-600">
                                                                                R$ <span x-text="obterPrecoTamanho(pizza, tamanho)"></span>
                                                                            </div>
                                                                            <button type="button"
                                                                                    @click="abrirModalPizza(pizza, tamanho)"
                                                                                    class="px-3 py-1 bg-pizza-600 text-white text-xs rounded-full hover:bg-pizza-700 transition-colors add-button-hover">
                                                                                + Adicionar
                                                                            </button>
                                                                        </div>
                                                                    </template>
                                                                    <template x-if="!obterPrecoTamanho(pizza, tamanho)">
                                                                        <span class="text-gray-400">-</span>
                                                                    </template>
                                                                </td>
                                                            </template>
                                                        </tr>
                                                    </template>
                                                </template>
                                            </template>
                                            
                                            <!-- Nenhuma pizza encontrada -->
                                            <template x-if="pizzasFiltradas.length === 0 && !carregandoProdutos">
                                                <tr>
                                                    <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                                        <div class="flex flex-col items-center">
                                                            <span class="text-6xl mb-4">üçï</span>
                                                            <p class="text-lg">Nenhuma pizza encontrada</p>
                                                            <p class="text-sm mt-2">Tente buscar por outro nome ou ingrediente</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Cards Mobile -->
                            <div x-show="!carregandoProdutos && !erroProdutos" class="md:hidden space-y-4">
                                <template x-for="categoria in categoriasOrdenadas" :key="categoria">
                                    <template x-if="obterPizzasPorCategoria(categoria).length > 0">
                                        <div>
                                            <!-- Header da Categoria -->
                                            <div class="bg-pizza-600 text-white px-4 py-2 rounded-lg font-bold text-sm uppercase tracking-wider mb-3">
                                                <span x-text="categoria"></span>
                                            </div>
                                            
                                            <!-- Pizzas da Categoria -->
                                            <template x-for="pizza in obterPizzasPorCategoria(categoria)" :key="pizza.id">
                                                <div class="pizza-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                                                    <div class="flex items-start gap-3 mb-4">
                                                        <span class="text-2xl">üçï</span>
                                                        <div class="flex-1">
                                                            <h3 class="font-bold text-gray-900 uppercase" x-text="pizza.nome"></h3>
                                                            <p class="text-sm text-gray-600 mt-1" x-text="pizza.ingredientes"></p>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Grid de Pre√ßos -->
                                                    <div class="grid grid-cols-2 gap-3">
                                                        <template x-for="tamanho in ['Pequena', 'M√©dia', 'Grande', 'Fam√≠lia']" :key="tamanho">
                                                            <template x-if="obterPrecoTamanho(pizza, tamanho)">
                                                                <div class="price-item bg-gray-50 border border-gray-200 rounded-lg p-3 text-center transition-all hover:bg-gray-100">
                                                                    <div class="text-xs text-gray-600 font-medium uppercase" x-text="tamanho"></div>
                                                                    <div class="text-lg font-bold text-green-600 mt-1">
                                                                        R$ <span x-text="obterPrecoTamanho(pizza, tamanho)"></span>
                                                                    </div>
                                                                    <button type="button"
                                                                            @click="abrirModalPizza(pizza, tamanho)"
                                                                            class="w-full mt-2 px-2 py-1 bg-pizza-600 text-white text-xs rounded hover:bg-pizza-700 transition-colors">
                                                                        + Adicionar
                                                                    </button>
                                                                </div>
                                                            </template>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </template>
                                
                                <!-- Fallback: Mostrar todas as pizzas se categorias n√£o funcionarem (Mobile) -->
                                <template x-if="categoriasOrdenadas.length === 0 && pizzasFiltradas.length > 0">
                                    <div>
                                        <!-- Header padr√£o -->
                                        <div class="bg-pizza-600 text-white px-4 py-2 rounded-lg font-bold text-sm uppercase tracking-wider mb-3">
                                            üçï Todas as Pizzas
                                        </div>
                                        
                                        <!-- Todas as pizzas -->
                                        <template x-for="pizza in pizzasFiltradas" :key="pizza.id">
                                            <div class="pizza-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm mb-4">
                                                <div class="flex items-start gap-3 mb-4">
                                                    <span class="text-2xl">üçï</span>
                                                    <div class="flex-1">
                                                        <h3 class="font-bold text-gray-900 uppercase" x-text="pizza.nome"></h3>
                                                        <p class="text-sm text-gray-600 mt-1" x-text="pizza.ingredientes"></p>
                                                    </div>
                                                </div>
                                                
                                                <!-- Grid de Pre√ßos -->
                                                <div class="grid grid-cols-2 gap-3">
                                                    <template x-for="tamanho in ['Pequena', 'M√©dia', 'Grande', 'Fam√≠lia']" :key="tamanho">
                                                        <template x-if="obterPrecoTamanho(pizza, tamanho)">
                                                            <div class="price-item bg-gray-50 border border-gray-200 rounded-lg p-3 text-center transition-all hover:bg-gray-100">
                                                                <div class="text-xs text-gray-600 font-medium uppercase" x-text="tamanho"></div>
                                                                <div class="text-lg font-bold text-green-600 mt-1">
                                                                    R$ <span x-text="obterPrecoTamanho(pizza, tamanho)"></span>
                                                                </div>
                                                                <button type="button"
                                                                        @click="abrirModalPizza(pizza, tamanho)"
                                                                        class="w-full mt-2 px-2 py-1 bg-pizza-600 text-white text-xs rounded hover:bg-pizza-700 transition-colors">
                                                                    + Adicionar
                                                                </button>
                                                            </div>
                                                        </template>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                                
                                <!-- Nenhuma pizza encontrada -->
                                <template x-if="pizzasFiltradas.length === 0 && !carregandoProdutos">
                                    <div class="text-center py-12">
                                        <span class="text-6xl">üçï</span>
                                        <p class="text-gray-500 mt-4">Nenhuma pizza encontrada</p>
                                        <p class="text-sm text-gray-400 mt-2">Tente buscar por outro nome ou ingrediente</p>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Aba Bebidas -->
                        <div x-show="abaAtiva === 'bebidas'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <template x-for="bebida in produtos.bebidas" :key="bebida.id">
                                <div class="produto-card">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-xl mr-3">
                                            ü•§
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold text-gray-900" x-text="bebida.nome"></h3>
                                            <p class="text-pizza-600 font-medium" x-text="`R$ ${bebida.preco.toFixed(2)}`"></p>
                                        </div>
                                        <button type="button"
                                                @click="adicionarItem(bebida, 'bebida')"
                                                class="w-8 h-8 bg-pizza-600 text-white rounded-full hover:bg-pizza-700 transition-colors">
                                            +
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Aba Sobremesas -->
                        <div x-show="abaAtiva === 'sobremesas'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <template x-for="sobremesa in produtos.sobremesas" :key="sobremesa.id">
                                <div class="produto-card">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center text-xl mr-3">
                                            üç∞
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold text-gray-900" x-text="sobremesa.nome"></h3>
                                            <p class="text-pizza-600 font-medium" x-text="`R$ ${sobremesa.preco.toFixed(2)}`"></p>
                                        </div>
                                        <button type="button"
                                                @click="adicionarItem(sobremesa, 'sobremesa')"
                                                class="w-8 h-8 bg-pizza-600 text-white rounded-full hover:bg-pizza-700 transition-colors">
                                            +
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Aba Acompanhamentos -->
                        <div x-show="abaAtiva === 'acompanhamentos'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <template x-for="acompanhamento in produtos.acompanhamentos" :key="acompanhamento.id">
                                <div class="produto-card">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center text-xl mr-3">
                                            üçü
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold text-gray-900" x-text="acompanhamento.nome"></h3>
                                            <p class="text-pizza-600 font-medium" x-text="`R$ ${acompanhamento.preco.toFixed(2)}`"></p>
                                        </div>
                                        <button type="button"
                                                @click="adicionarItem(acompanhamento, 'acompanhamento')"
                                                class="w-8 h-8 bg-pizza-600 text-white rounded-full hover:bg-pizza-700 transition-colors">
                                            +
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Carrinho Lateral -->
                    <div class="w-full lg:w-80">
                        <div class="carrinho-lateral">
                            <div class="p-4 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                    üõí Carrinho
                                    <span x-show="carrinho.length > 0" 
                                          class="ml-2 px-2 py-1 text-xs bg-pizza-600 text-white rounded-full">
                                        <span x-text="carrinho.length"></span>
                                    </span>
                                </h3>
                            </div>
                            
                            <div class="p-4">
                                <!-- Itens do Carrinho -->
                                <div x-show="carrinho.length > 0" class="space-y-3 mb-4">
                                    <template x-for="(item, index) in carrinho" :key="index">
                                        <div class="carrinho-item">
                                            <div class="carrinho-item-info">
                                                <h4 class="font-medium text-gray-900" x-text="item.nome"></h4>
                                                <p x-show="item.tamanho" class="text-xs text-gray-500">
                                                    Tamanho: <span x-text="item.tamanho"></span>
                                                </p>
                                                <p class="text-sm text-pizza-600 font-medium">
                                                    R$ <span x-text="(item.preco * item.quantidade).toFixed(2)"></span>
                                                </p>
                                            </div>
                                            <div class="carrinho-item-controls">
                                                <button type="button"
                                                        @click="diminuirQuantidade(index)"
                                                        :class="{ 'disabled': item.quantidade <= 1 }"
                                                        class="quantidade-control">
                                                    ‚àí
                                                </button>
                                                <span class="w-8 text-center text-sm font-medium" x-text="item.quantidade"></span>
                                                <button type="button"
                                                        @click="aumentarQuantidade(index)"
                                                        class="quantidade-control">
                                                    +
                                                </button>
                                                <button type="button"
                                                        @click="removerItem(index)"
                                                        class="ml-2 text-red-500 hover:text-red-700">
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Carrinho Vazio -->
                                <div x-show="carrinho.length === 0" class="text-center py-8 text-gray-500">
                                    <div class="text-4xl mb-2">üõí</div>
                                    <p>Carrinho vazio</p>
                                    <p class="text-sm">Adicione produtos para continuar</p>
                                </div>
                                
                                <!-- Totais -->
                                <div x-show="carrinho.length > 0" class="carrinho-totais">
                                    <div class="total-linha">
                                        <span>Subtotal:</span>
                                        <span>R$ <span x-text="subtotal.toFixed(2)"></span></span>
                                    </div>
                                    <div x-show="tipoPedido === 'delivery'" class="total-linha">
                                        <span>Taxa de Entrega:</span>
                                        <span>R$ <span x-text="taxaEntrega.toFixed(2)"></span></span>
                                    </div>
                                    <div x-show="subtotal < pedidoMinimo && tipoPedido === 'delivery'" class="total-linha text-amber-600">
                                        <span class="text-xs">Pedido m√≠nimo: R$ <span x-text="pedidoMinimo.toFixed(2)"></span></span>
                                    </div>
                                    <div class="total-linha final">
                                        <span>Total:</span>
                                        <span>R$ <span x-text="total.toFixed(2)"></span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Bot√µes de A√ß√£o -->
        <div class="flex justify-between mt-6">
            <button type="button"
                    @click="cancelar"
                    class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                Cancelar
            </button>
            
            <button type="submit"
                    :disabled="!formularioValido"
                    :class="{ 'opacity-50 cursor-not-allowed': !formularioValido }"
                    class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-pizza-600 hover:bg-pizza-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pizza-500 disabled:hover:bg-pizza-600"
                    aria-label="Confirmar pedido. Certifique-se de preencher todos os campos obrigat√≥rios.">
                <span x-show="!formularioValido">Preencha os dados</span>
                <span x-show="formularioValido">Confirmar Pedido - R$ <span x-text="total.toFixed(2)"></span></span>
            </button>
        </div>
    </form>

    <!-- Modal de Sele√ß√£o de Pizza -->
    <div x-show="modalPizza.aberto" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto"
         @click="fecharModalPizza"
         role="dialog"
         aria-modal="true"
         aria-labelledby="modal-title">
        
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            
            <!-- Conte√∫do do Modal -->
            <div @click.stop 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-pizza-100 sm:mx-0 sm:h-10 sm:w-10">
                        <span class="text-2xl">üçï</span>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left flex-1">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Adicionar <span x-text="modalPizza.pizza?.nome"></span>
                        </h3>
                        <div class="mt-1">
                            <p class="text-sm text-gray-500">
                                Tamanho: <span x-text="modalPizza.tamanho"></span> - 
                                R$ <span x-text="modalPizza.preco?.toFixed(2)"></span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-5">
                    <!-- Tipo de Pizza -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Pizza</label>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="radio" 
                                       x-model="modalPizza.tipo" 
                                       value="inteira"
                                       class="focus:ring-pizza-500 h-4 w-4 text-pizza-600 border-gray-300">
                                <span class="ml-2 text-sm text-gray-900">
                                    Pizza Inteira - R$ <span x-text="modalPizza.preco?.toFixed(2)"></span>
                                </span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" 
                                       x-model="modalPizza.tipo" 
                                       value="meio_a_meio"
                                       class="focus:ring-pizza-500 h-4 w-4 text-pizza-600 border-gray-300">
                                <span class="ml-2 text-sm text-gray-900">
                                    Meio a Meio - R$ <span x-text="modalPizza.preco?.toFixed(2)"></span> + R$ <span x-text="modalPizza.precoSegundoSabor?.toFixed(2) || 'XX,XX'"></span>
                                </span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Segundo Sabor (apenas para meio a meio) -->
                    <div x-show="modalPizza.tipo === 'meio_a_meio'" 
                         x-transition
                         class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Segundo Sabor</label>
                        <select x-model="modalPizza.segundoSabor" 
                                @change="calcularPrecoMeioAMeio"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pizza-500 focus:ring-pizza-500 sm:text-sm">
                            <option value="">Selecionar outro sabor</option>
                            <template x-for="pizza in pizzasFiltradas" :key="pizza.id">
                                <template x-if="pizza.id !== modalPizza.pizza?.id && obterPrecoTamanho(pizza, modalPizza.tamanho)">
                                    <option :value="pizza.id" x-text="`${pizza.nome} - R$ ${obterPrecoTamanho(pizza, modalPizza.tamanho)}`"></option>
                                </template>
                            </template>
                        </select>
                        
                        <div x-show="modalPizza.segundoSabor" class="mt-2 p-3 bg-gray-50 rounded-md">
                            <p class="text-sm text-gray-600">
                                <strong>Pre√ßo Total:</strong> R$ <span x-text="modalPizza.precoTotal?.toFixed(2)"></span>
                            </p>
                            <p class="text-xs text-gray-500 mt-1">
                                O pre√ßo da pizza meio a meio √© baseado no sabor mais caro
                            </p>
                        </div>
                    </div>
                    
                    <!-- Observa√ß√µes -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes (opcional)</label>
                        <textarea x-model="modalPizza.observacoes"
                                  rows="3"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pizza-500 focus:ring-pizza-500 sm:text-sm"
                                  placeholder="Ex: sem cebola, borda recheada..."></textarea>
                    </div>
                </div>
                
                <!-- Bot√µes -->
                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse gap-3">
                    <button type="button"
                            @click="adicionarPizzaAoCarrinho"
                            :disabled="modalPizza.tipo === 'meio_a_meio' && !modalPizza.segundoSabor"
                            :class="{ 'opacity-50 cursor-not-allowed': modalPizza.tipo === 'meio_a_meio' && !modalPizza.segundoSabor }"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-pizza-600 text-base font-medium text-white hover:bg-pizza-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pizza-500 sm:ml-3 sm:w-auto sm:text-sm">
                        ‚úÖ Adicionar ao Carrinho
                    </button>
                    <button type="button"
                            @click="fecharModalPizza"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 sm:mt-0 sm:w-auto sm:text-sm">
                        ‚ùå Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function pedidoForm() {
    return {
        // Estado do formul√°rio
        secaoClienteAberta: true,
        secaoProdutosAberta: true,
        abaAtiva: 'pizzas',
        
        // Dados do formul√°rio
        cliente: {
            nome: '',
            telefone: ''
        },
        tipoPedido: 'delivery',
        endereco: '',
        numeroMesa: '',
        
        // Carrinho e produtos
        carrinho: [],
        pizzaSelecionada: {},
        pizzaAdicionada: {},
        pedidoMinimo: 25.00,
        taxaEntrega: 5.00,
        
        // Valida√ß√£o
        erros: {},
        errosGlobais: [],
        
        // Produtos carregados da API
        produtos: {
            pizzas: [],
            bebidas: [],
            sobremesas: [],
            acompanhamentos: []
        },
        produtosCarregados: false,
        carregandoProdutos: false,
        erroProdutos: '',
        
        // Busca e filtros de pizzas
        buscaPizza: '',
        pizzasFiltradas: [],
        
        // Modal de sele√ß√£o de pizza
        modalPizza: {
            aberto: false,
            pizza: null,
            tamanho: '',
            preco: 0,
            tipo: 'inteira',
            segundoSabor: '',
            precoSegundoSabor: 0,
            precoTotal: 0,
            observacoes: ''
        },
        
        // Carregar produtos da API
        async carregarProdutos() {
            if (this.produtosCarregados || this.carregandoProdutos) {
                return;
            }
            
            this.carregandoProdutos = true;
            this.erroProdutos = '';
            
            try {
                console.log('üîÑ Carregando produtos da API...');
                
                const response = await fetch('/api/produtos/produtos/para_pedido/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Produtos carregados:', data);
                
                // Atualizar dados
                this.produtos = data;
                this.produtosCarregados = true;
                
                // Inicializar pizzas filtradas
                this.pizzasFiltradas = data.pizzas || [];
                
                
            } catch (error) {
                this.erroProdutos = `Erro ao carregar produtos: ${error.message}`;
                
                // Fallback com dados vazios em caso de erro
                this.produtos = {
                    pizzas: [],
                    bebidas: [],
                    sobremesas: [],
                    acompanhamentos: []
                };
            } finally {
                this.carregandoProdutos = false;
            }
        },
        
        // Computed properties
        get subtotal() {
            return this.carrinho.reduce((total, item) => total + (item.preco * item.quantidade), 0);
        },
        
        get total() {
            let total = this.subtotal;
            if (this.tipoPedido === 'delivery') {
                total += this.taxaEntrega;
            }
            return total;
        },
        
        get formularioValido() {
            const nomeValido = this.cliente.nome.trim().length >= 3;
            const telefoneValido = this.cliente.telefone.replace(/\D/g, '').length >= 10;
            const carrinhoValido = this.carrinho.length > 0;
            
            let tipoValido = true;
            if (this.tipoPedido === 'delivery') {
                tipoValido = this.endereco.trim().length > 0;
                // Verificar pedido m√≠nimo para delivery
                if (this.subtotal < this.pedidoMinimo) {
                    tipoValido = false;
                }
            } else if (this.tipoPedido === 'mesa') {
                tipoValido = this.numeroMesa.trim().length > 0;
            }
            
            return nomeValido && telefoneValido && tipoValido && carrinhoValido;
        },
        
        // Computed properties para organiza√ß√£o de pizzas
        get categoriasOrdenadas() {
            // Como a API j√° organiza por tipo, criar categorias baseadas no tipo de pizza
            if (!this.pizzasFiltradas || this.pizzasFiltradas.length === 0) {
                return [];
            }
            
            // Identificar categorias dinamicamente baseado nos nomes das pizzas
            const categorias = new Set();
            this.pizzasFiltradas.forEach(pizza => {
                const categoria = this.identificarCategoriaPizza(pizza);
                categorias.add(categoria);
            });
            
            const lista = Array.from(categorias);
            return lista.sort((a, b) => {
                const ordem = ['Especiais', 'Tradicionais', 'Vegetarianas', 'Doces'];
                const indexA = ordem.indexOf(a);
                const indexB = ordem.indexOf(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
        },
        
        // M√©todo para identificar categoria da pizza baseado no nome/ingredientes
        identificarCategoriaPizza(pizza) {
            const nome = pizza.nome.toLowerCase();
            const ingredientes = (pizza.ingredientes || '').toLowerCase();
            
            // Pizzas especiais/gourmet
            if (nome.includes('chef') || nome.includes('premium') || nome.includes('camar√£o') || 
                ingredientes.includes('trufado') || ingredientes.includes('b√∫fala') || 
                ingredientes.includes('salm√£o') || nome.includes('especial')) {
                return 'Especiais';
            }
            
            // Pizzas doces
            if (nome.includes('chocolate') || nome.includes('doce') || nome.includes('nutella') ||
                ingredientes.includes('chocolate') || ingredientes.includes('doce')) {
                return 'Doces';
            }
            
            // Pizzas vegetarianas
            if (nome.includes('margherita') || nome.includes('vegetariana') || nome.includes('r√∫cula') ||
                ingredientes.includes('r√∫cula') || ingredientes.includes('vegetais')) {
                return 'Vegetarianas';
            }
            
            // Pizzas tradicionais (padr√£o)
            return 'Tradicionais';
        },
        
        async init() {
            this.$nextTick(() => {
                document.getElementById('cliente-nome')?.focus();
            });
            
            // Carregar produtos da API
            await this.carregarProdutos();
        },
        
        // M√©todos para busca e filtros
        filtrarPizzas() {
            if (!this.buscaPizza.trim()) {
                this.pizzasFiltradas = this.produtos.pizzas || [];
                return;
            }
            
            const termo = this.buscaPizza.toLowerCase().trim();
            this.pizzasFiltradas = (this.produtos.pizzas || []).filter(pizza => {
                return pizza.nome.toLowerCase().includes(termo) ||
                       (pizza.ingredientes && pizza.ingredientes.toLowerCase().includes(termo));
            });
        },
        
        // M√©todos auxiliares para organiza√ß√£o
        obterPizzasPorCategoria(categoria) {
            return this.pizzasFiltradas.filter(pizza => {
                return this.identificarCategoriaPizza(pizza) === categoria;
            });
        },
        
        // M√©todos do modal de pizza
        abrirModalPizza(pizza, tamanho) {
            const preco = this.obterPrecoTamanhoNumerico(pizza, tamanho);
            if (!preco) return;
            
            this.modalPizza = {
                aberto: true,
                pizza: pizza,
                tamanho: tamanho,
                preco: preco,
                tipo: 'inteira',
                segundoSabor: '',
                precoSegundoSabor: 0,
                precoTotal: preco,
                observacoes: ''
            };
        },
        
        fecharModalPizza() {
            this.modalPizza = {
                aberto: false,
                pizza: null,
                tamanho: '',
                preco: 0,
                tipo: 'inteira',
                segundoSabor: '',
                precoSegundoSabor: 0,
                precoTotal: 0,
                observacoes: ''
            };
        },
        
        calcularPrecoMeioAMeio() {
            if (!this.modalPizza.segundoSabor || !this.modalPizza.pizza) {
                this.modalPizza.precoSegundoSabor = 0;
                this.modalPizza.precoTotal = this.modalPizza.preco;
                return;
            }
            
            const segundaPizza = this.pizzasFiltradas.find(p => p.id == this.modalPizza.segundoSabor);
            if (segundaPizza) {
                const precoSegundo = this.obterPrecoTamanhoNumerico(segundaPizza, this.modalPizza.tamanho);
                this.modalPizza.precoSegundoSabor = precoSegundo;
                // Pre√ßo da pizza meio a meio √© o valor do sabor mais caro
                this.modalPizza.precoTotal = Math.max(this.modalPizza.preco, precoSegundo);
            }
        },
        
        adicionarPizzaAoCarrinho() {
            if (this.modalPizza.tipo === 'meio_a_meio' && !this.modalPizza.segundoSabor) {
                return;
            }
            
            let nome = `Pizza ${this.modalPizza.pizza.nome}`;
            let ingredientes = this.modalPizza.pizza.ingredientes;
            
            if (this.modalPizza.tipo === 'meio_a_meio') {
                const segundaPizza = this.pizzasFiltradas.find(p => p.id == this.modalPizza.segundoSabor);
                nome = `Pizza Meio a Meio: ${this.modalPizza.pizza.nome} / ${segundaPizza.nome}`;
                ingredientes = `${this.modalPizza.pizza.ingredientes} | ${segundaPizza.ingredientes}`;
            }
            
            const item = {
                id: `pizza-${this.modalPizza.pizza.id}-${this.modalPizza.tamanho}-${this.modalPizza.tipo}-${this.modalPizza.segundoSabor || 'none'}`,
                produto_id: this.modalPizza.pizza.id,
                nome: nome,
                tipo: 'pizza',
                subtipo: this.modalPizza.tipo,
                tamanho: this.modalPizza.tamanho,
                preco: this.modalPizza.precoTotal,
                ingredientes: ingredientes,
                observacoes: this.modalPizza.observacoes,
                segundoSabor: this.modalPizza.segundoSabor,
                quantidade: 1
            };
            
            // Verificar se j√° existe no carrinho (mesmo item)
            const itemExistente = this.carrinho.find(i => i.id === item.id);
            
            if (itemExistente) {
                itemExistente.quantidade++;
            } else {
                this.carrinho.push(item);
            }
            
            this.calcularTotais();
            this.fecharModalPizza();
            
            // Feedback visual
            this.mostrarNotificacao('Pizza adicionada ao carrinho!', 'success');
        },
        
        mostrarNotificacao(mensagem, tipo = 'info') {
            // Implementa√ß√£o simples de notifica√ß√£o
            // Aqui voc√™ pode implementar uma notifica√ß√£o visual mais elaborada
        },
        
        // Valida√ß√£o individual de campos
        validarCampo(campo) {
            this.erros[campo] = '';
            
            switch(campo) {
                case 'nome':
                    if (!this.cliente.nome.trim()) {
                        this.erros.nome = 'Nome √© obrigat√≥rio';
                    } else if (this.cliente.nome.trim().length < 3) {
                        this.erros.nome = 'Nome deve ter pelo menos 3 caracteres';
                    }
                    break;
                    
                case 'telefone':
                    const telefoneNumeros = this.cliente.telefone.replace(/\D/g, '');
                    if (!telefoneNumeros) {
                        this.erros.telefone = 'Telefone √© obrigat√≥rio';
                    } else if (telefoneNumeros.length < 10) {
                        this.erros.telefone = 'Telefone deve ter pelo menos 10 d√≠gitos';
                    }
                    break;
                    
                case 'endereco':
                    if (this.tipoPedido === 'delivery' && !this.endereco.trim()) {
                        this.erros.endereco = 'Endere√ßo √© obrigat√≥rio para delivery';
                    }
                    break;
                    
                case 'numeroMesa':
                    if (this.tipoPedido === 'mesa' && !this.numeroMesa.trim()) {
                        this.erros.numeroMesa = 'N√∫mero da mesa √© obrigat√≥rio';
                    }
                    break;
            }
        },
        
        // Formata√ß√£o de telefone
        formatarTelefone() {
            let value = this.cliente.telefone.replace(/\D/g, '');
            if (value.length > 0) {
                if (value.length <= 10) {
                    value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                } else {
                    value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                }
            }
            this.cliente.telefone = value;
        },
        
        // Gerenciamento do carrinho
        adicionarPizza(pizza) {
            const tamanhoSelecionado = this.pizzaSelecionada[pizza.id];
            if (!tamanhoSelecionado) return;
            
            const tamanho = pizza.tamanhos.find(t => t.size === tamanhoSelecionado);
            const item = {
                id: `pizza-${pizza.id}-${tamanho.size}`, // ID √∫nico para pizza + tamanho
                produto_id: pizza.id,
                nome: `Pizza ${pizza.nome}`,
                tipo: 'pizza',
                tamanho: tamanho.size,
                preco: tamanho.preco,
                ingredientes: pizza.ingredientes,
                quantidade: 1
            };
            
            // Verificar se j√° existe no carrinho (mesma pizza e tamanho)
            const itemExistente = this.carrinho.find(i => i.id === item.id);
            
            if (itemExistente) {
                itemExistente.quantidade++;
            } else {
                this.carrinho.push(item);
            }
            
            // Feedback visual
            this.pizzaAdicionada[pizza.id] = true;
            
            // Limpar sele√ß√£o ap√≥s 2 segundos
            setTimeout(() => {
                this.pizzaSelecionada[pizza.id] = '';
                this.pizzaAdicionada[pizza.id] = false;
            }, 2000);
            
            this.calcularTotais();
        },
        
        // Fun√ß√£o auxiliar para obter pre√ßo do tamanho (string formatada)
        obterPrecoTamanho(pizza, tamanho) {
            if (!tamanho || !pizza.tamanhos) return null;
            const tamanhoObj = pizza.tamanhos.find(t => t.size === tamanho);
            return tamanhoObj ? tamanhoObj.preco.toFixed(2) : null;
        },
        
        // Fun√ß√£o auxiliar para obter pre√ßo do tamanho (num√©rico)
        obterPrecoTamanhoNumerico(pizza, tamanho) {
            if (!tamanho || !pizza.tamanhos) return 0;
            const tamanhoObj = pizza.tamanhos.find(t => t.size === tamanho);
            return tamanhoObj ? tamanhoObj.preco : 0;
        },
        
        adicionarItem(produto, tipo) {
            const item = {
                id: `${tipo}-${produto.id}`, // ID √∫nico para n√£o-pizzas
                produto_id: produto.id,
                nome: produto.nome,
                tipo: tipo,
                preco: produto.preco,
                quantidade: 1
            };
            
            // Verificar se j√° existe no carrinho
            const itemExistente = this.carrinho.find(i => i.id === item.id);
            
            if (itemExistente) {
                itemExistente.quantidade++;
            } else {
                this.carrinho.push(item);
            }
            
            this.calcularTotais();
        },
        
        aumentarQuantidade(index) {
            this.carrinho[index].quantidade++;
            this.calcularTotais();
        },
        
        diminuirQuantidade(index) {
            if (this.carrinho[index].quantidade > 1) {
                this.carrinho[index].quantidade--;
                this.calcularTotais();
            }
        },
        
        removerItem(index) {
            this.carrinho.splice(index, 1);
            this.calcularTotais();
        },
        
        calcularTotais() {
            // For√ßar reatividade
            this.$nextTick(() => {
                // Os computed properties j√° fazem o c√°lculo
            });
        },
        
        // Valida√ß√£o completa do formul√°rio
        validarFormulario() {
            this.errosGlobais = [];
            
            // Validar todos os campos
            this.validarCampo('nome');
            this.validarCampo('telefone');
            
            if (this.tipoPedido === 'delivery') {
                this.validarCampo('endereco');
                if (this.subtotal < this.pedidoMinimo) {
                    this.errosGlobais.push(`Pedido m√≠nimo para delivery: R$ ${this.pedidoMinimo.toFixed(2)}`);
                }
            } else if (this.tipoPedido === 'mesa') {
                this.validarCampo('numeroMesa');
            }
            
            // Verificar carrinho
            if (this.carrinho.length === 0) {
                this.errosGlobais.push('Adicione pelo menos um produto ao carrinho');
            }
            
            // Coletar erros
            Object.values(this.erros).forEach(erro => {
                if (erro) this.errosGlobais.push(erro);
            });
            
            return this.errosGlobais.length === 0;
        },
        
        // Cancelar pedido
        cancelar() {
            if (confirm('Tem certeza que deseja cancelar o pedido?')) {
                window.location.reload();
            }
        },
        
        // Submeter formul√°rio
        submitForm() {
            if (this.validarFormulario()) {
                // Preparar dados para envio
                const dados = {
                    cliente_nome: this.cliente.nome,
                    cliente_telefone: this.cliente.telefone,
                    tipo_pedido: this.tipoPedido,
                    endereco: this.tipoPedido === 'delivery' ? this.endereco : '',
                    numero_mesa: this.tipoPedido === 'mesa' ? this.numeroMesa : '',
                    itens: this.carrinho,
                    subtotal: this.subtotal,
                    taxa_entrega: this.tipoPedido === 'delivery' ? this.taxaEntrega : 0,
                    total: this.total
                };
                
                
                alert(`Pedido confirmado!\nTotal: R$ ${this.total.toFixed(2)}\nItens: ${this.carrinho.length}`);
                
                // Redirecionar para lista de pedidos
                window.location.href = "{% url 'pedido_list' %}";
            } else {
                // Focar no primeiro erro
                const primeiroErro = document.querySelector('.campo-invalido');
                if (primeiroErro) {
                    primeiroErro.focus();
                    primeiroErro.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
    }
}
</script>
{% endblock %}