{% extends 'layouts/dashboard.html' %}
{% load static %}

{% block title %}{% if object %}Editar{% else %}Novo{% endif %} Pedido - Pizzaria{% endblock %}

{% block extra_css %}
<style>
    /* Estilos para campos inv√°lidos */
    .campo-invalido {
        border-color: #DC2626 !important;
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }
    
    /* Estilos para mensagens de erro */
    .mensagem-erro {
        color: #DC2626;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    /* Estilos para campos obrigat√≥rios */
    .campo-obrigatorio::after {
        content: ' *';
        color: #DC2626;
    }
    
    /* Estilos para se√ß√µes */
    .secao-formulario {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        overflow: hidden;
    }
    
    .secao-header {
        padding: 1rem 1.5rem;
        background: #F9FAFB;
        border-bottom: 1px solid #E5E7EB;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .secao-header:hover {
        background: #F3F4F6;
    }
    
    .secao-content {
        padding: 1.5rem;
    }
    
    /* Estilos para abas de produtos */
    .aba-produto {
        @apply px-4 py-2 text-sm font-medium rounded-lg cursor-pointer transition-all;
    }
    
    .aba-produto.active {
        @apply bg-pizza-600 text-white;
    }
    
    .aba-produto:not(.active) {
        @apply bg-gray-100 text-gray-700 hover:bg-gray-200;
    }
    
    /* Cards de produtos */
    .produto-card {
        @apply bg-white border border-gray-200 rounded-lg p-4 transition-all hover:shadow-md;
    }
    
    /* Estilos para forma de pagamento */
    .forma-pagamento {
        @apply flex flex-col items-center justify-center p-4 border-2 border-gray-300 rounded-lg cursor-pointer transition-all hover:border-pizza-400 hover:bg-gray-50;
    }
    
    .forma-pagamento-ativa {
        @apply flex flex-col items-center justify-center p-4 border-2 border-pizza-600 rounded-lg cursor-pointer bg-pizza-50;
    }
    
    .produto-card.pizza {
        @apply relative;
    }
    
    /* Seletor de tamanho para pizzas */
    .tamanho-selector {
        @apply grid grid-cols-2 sm:grid-cols-4 gap-2 mt-3;
    }
    
    .tamanho-option {
        @apply relative;
    }
    
    .tamanho-option input[type="radio"] {
        @apply sr-only peer;
    }
    
    .tamanho-option label {
        @apply block w-full px-3 py-2 text-center text-sm border rounded-md cursor-pointer transition-all;
        @apply peer-checked:bg-pizza-600 peer-checked:text-white peer-checked:border-pizza-600;
        @apply hover:bg-gray-50 peer-checked:hover:bg-pizza-700;
    }
    
    /* Carrinho lateral */
    .carrinho-lateral {
        @apply sticky top-4 bg-white border border-gray-200 rounded-lg shadow-lg h-fit;
    }
    
    .carrinho-item {
        @apply flex justify-between items-start py-3 border-b border-gray-100 last:border-b-0;
    }
    
    .carrinho-item-info {
        @apply flex-1 mr-3;
    }
    
    .carrinho-item-controls {
        @apply flex items-center space-x-2;
    }
    
    .quantidade-control {
        @apply w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center cursor-pointer hover:bg-gray-50 transition-colors;
    }
    
    .quantidade-control:hover {
        @apply border-pizza-500 text-pizza-600;
    }
    
    .quantidade-control.disabled {
        @apply opacity-50 cursor-not-allowed;
    }
    
    /* Bot√£o adicionar produto */
    .btn-adicionar {
        @apply w-full mt-3 px-4 py-2 bg-pizza-600 text-white rounded-lg hover:bg-pizza-700 transition-colors;
        @apply disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-pizza-600;
    }
    
    /* Totais do carrinho */
    .carrinho-totais {
        @apply space-y-2 pt-4 border-t border-gray-200;
    }
    
    .total-linha {
        @apply flex justify-between text-sm;
    }
    
    .total-linha.final {
        @apply text-lg font-bold text-pizza-600 pt-2 border-t border-gray-200;
    }
    
    /* Estilos da Tabela de Pizzas (copiado do card√°pio) */
    .pizza-table {
        font-family: 'Inter', sans-serif;
    }
    
    .pizza-table th {
        background-color: #F8FAFC;
        color: #64748B;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        border-bottom: 2px solid #E2E8F0;
        padding: 1rem;
    }
    
    .pizza-table th:first-child {
        text-align: left;
        padding-left: 1.5rem;
    }
    
    .pizza-row {
        border-bottom: 1px solid #F1F5F9;
        transition: all 0.15s ease-in-out;
    }
    
    .pizza-row:hover {
        background-color: #FEF2F2;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .pizza-name {
        font-weight: 700;
        color: #1E293B;
        font-size: 1rem;
        letter-spacing: -0.025em;
    }
    
    .pizza-ingredients {
        color: #64748B;
        font-size: 0.875rem;
        line-height: 1.4;
        margin-top: 0.25rem;
    }
    
    .price-cell {
        font-weight: 700;
        color: #10B981;
        font-size: 1rem;
        font-variant-numeric: tabular-nums;
    }
    
    .price-cell.promo {
        color: #DC2626;
    }
    
    .original-price {
        text-decoration: line-through;
        color: #94A3B8;
        font-size: 0.75rem;
        font-weight: 400;
    }
    
    .category-header {
        background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
        color: white;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-size: 0.875rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    /* Melhorias visuais para pizzas */
    .search-highlight {
        background-color: #FEF3C7;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
    }
    
    .add-button-hover:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
    }
    
    /* Novo Sistema de Sele√ß√£o Visual - Estados dos Cards */
    .modo-selecao-segundo .pizza-card {
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }
    
    .modo-selecao-segundo .pizza-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(220, 38, 38, 0.2);
        border-color: #DC2626;
    }
    
    .modo-selecao-segundo .pizza-card.disponivel {
        border: 2px solid #10B981;
        background: linear-gradient(135deg, #F0FDF4 0%, #ECFDF5 100%);
    }
    
    .modo-selecao-segundo .pizza-card.selecionado-primeiro {
        border: 2px solid #94A3B8;
        background: #F1F5F9;
        opacity: 0.6;
        cursor: not-allowed;
        position: relative;
    }
    
    .modo-selecao-segundo .pizza-card.selecionado-primeiro::before {
        content: 'üçï 1¬∫ SABOR SELECIONADO';
        position: absolute;
        top: 10px;
        right: 10px;
        background: #64748B;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        z-index: 10;
    }
    
    .selecao-cta {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        pointer-events: none;
    }
    
    .header-selecao-segundo {
        background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2);
    }
    
    .primeiro-sabor-info {
        background: white;
        border: 2px solid #DC2626;
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .acoes-selecao {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
        margin-top: 1rem;
    }
    
    .btn-cancelar {
        background: #6B7280;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
    }
    
    .btn-cancelar:hover {
        background: #4B5563;
        transform: translateY(-1px);
    }
    
    .btn-trocar {
        background: #F59E0B;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
    }
    
    .btn-trocar:hover {
        background: #D97706;
        transform: translateY(-1px);
    }
    
    /* Responsividade */
    @media (max-width: 1024px) {
        .layout-produtos {
            @apply flex-col;
        }
        
        .carrinho-lateral {
            @apply static order-first mb-6;
        }
    }
    
    @media (max-width: 640px) {
        .secao-content {
            padding: 1rem;
        }
        
        .tamanho-selector {
            @apply grid-cols-2;
        }
        
        .carrinho-lateral {
            @apply mx-4;
        }
        
        /* Responsive do novo sistema */
        .header-selecao-segundo {
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
        }
        
        .acoes-selecao {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .btn-cancelar, .btn-trocar {
            width: 100%;
            text-align: center;
        }
        
        .selecao-cta {
            position: static;
            transform: none;
            margin-top: 1rem;
            width: 100%;
            text-align: center;
            padding: 8px 12px;
            font-size: 0.75rem;
        }
        
        .modo-selecao-segundo .pizza-card.selecionado-primeiro::before {
            font-size: 0.6rem;
            padding: 2px 6px;
            top: 5px;
            right: 5px;
        }
        
        .pizza-card {
            border: 1px solid #E5E7EB;
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            background: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: all 0.15s;
        }
        
        .pizza-card:active {
            transform: scale(0.98);
            box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.1);
        }
        
        .price-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        
        .price-item {
            background: #F8FAFC;
            border: 1px solid #E2E8F0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            text-align: center;
            transition: all 0.15s;
        }
        
        .price-item:hover {
            background: #F1F5F9;
            border-color: #CBD5E1;
        }
        
        .price-label {
            font-size: 0.75rem;
            color: #64748B;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        .price-value {
            font-size: 1.125rem;
            font-weight: 700;
            color: #10B981;
            margin-top: 0.125rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div x-data="pedidoForm()" x-init="init()">
    <form method="post" @submit.prevent="finalizarPedido" novalidate>
        {% csrf_token %}
        
        <!-- Cabe√ßalho -->
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-900">
                {% if object %}Editar Pedido #{{ object.numero }}{% else %}Novo Pedido{% endif %}
            </h1>
            <p class="mt-1 text-sm text-gray-600">Preencha os dados do cliente e selecione os produtos desejados</p>
        </div>
        
        <!-- Mensagens de erro global -->
        <div x-show="errosGlobais.length > 0" 
             class="mb-4 p-4 bg-red-50 border border-red-200 rounded-md"
             role="alert"
             aria-live="polite">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">Corrija os seguintes erros:</h3>
                    <ul class="mt-2 text-sm text-red-700 list-disc list-inside">
                        <template x-for="erro in errosGlobais">
                            <li x-text="erro"></li>
                        </template>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Se√ß√£o: Dados do Cliente -->
        <section class="secao-formulario">
            <div class="secao-header" 
                 @click="secaoClienteAberta = !secaoClienteAberta"
                 role="button"
                 :aria-expanded="secaoClienteAberta ? 'true' : 'false'"
                 aria-controls="dados-cliente"
                 tabindex="0"
                 @keydown.enter="secaoClienteAberta = !secaoClienteAberta"
                 @keydown.space.prevent="secaoClienteAberta = !secaoClienteAberta">
                <h2 class="text-lg font-medium text-gray-900">Dados do Cliente</h2>
                <svg class="w-5 h-5 text-gray-500 transition-transform"
                     :class="{ 'transform rotate-180': secaoClienteAberta }"
                     fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            
            <div x-show="secaoClienteAberta" 
                 x-transition
                 id="dados-cliente"
                 class="secao-content">
                
                <!-- Grid responsivo para campos -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- Nome do Cliente -->
                    <div>
                        <label for="cliente-nome" class="block text-sm font-medium text-gray-700 campo-obrigatorio">
                            Nome do Cliente
                        </label>
                        <input type="text"
                               id="cliente-nome"
                               name="cliente_nome"
                               x-model="cliente.nome"
                               @blur="validarCampo('nome')"
                               :class="{ 'campo-invalido': erros.nome }"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pizza-500 focus:ring-pizza-500 sm:text-sm"
                               aria-required="true"
                               aria-invalid="erros.nome ? 'true' : 'false'"
                               aria-describedby="erro-nome"
                               autofocus
                               required>
                        <p x-show="erros.nome" 
                           x-text="erros.nome"
                           id="erro-nome"
                           class="mensagem-erro"
                           role="alert"></p>
                    </div>
                    
                    <!-- Telefone -->
                    <div>
                        <label for="cliente-telefone" class="block text-sm font-medium text-gray-700 campo-obrigatorio">
                            Telefone
                        </label>
                        <input type="tel"
                               id="cliente-telefone"
                               name="cliente_telefone"
                               x-model="cliente.telefone"
                               @blur="validarCampo('telefone')"
                               @input="formatarTelefone"
                               :class="{ 'campo-invalido': erros.telefone }"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pizza-500 focus:ring-pizza-500 sm:text-sm"
                               placeholder="(00) 00000-0000"
                               aria-required="true"
                               aria-invalid="erros.telefone ? 'true' : 'false'"
                               aria-describedby="erro-telefone"
                               required>
                        <p x-show="erros.telefone" 
                           x-text="erros.telefone"
                           id="erro-telefone"
                           class="mensagem-erro"
                           role="alert"></p>
                    </div>
                </div>
                
                <!-- Tipo de Pedido -->
                <div class="mb-4">
                    <fieldset>
                        <legend class="block text-sm font-medium text-gray-700 campo-obrigatorio mb-2">
                            Tipo de Pedido
                        </legend>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <input type="radio"
                                       id="tipo-delivery"
                                       name="tipo_pedido"
                                       value="delivery"
                                       x-model="tipoPedido"
                                       @change="calcularTotais"
                                       class="sr-only peer"
                                       aria-required="true">
                                <label for="tipo-delivery"
                                       class="block w-full px-3 py-2 text-center border rounded-md cursor-pointer peer-checked:bg-pizza-600 peer-checked:text-white peer-checked:border-pizza-600 hover:bg-gray-50"
                                       tabindex="0"
                                       @keydown.enter="tipoPedido = 'delivery'; calcularTotais()"
                                       @keydown.space.prevent="tipoPedido = 'delivery'; calcularTotais()">
                                    üöö Delivery
                                </label>
                            </div>
                            
                            <div>
                                <input type="radio"
                                       id="tipo-balcao"
                                       name="tipo_pedido"
                                       value="balcao"
                                       x-model="tipoPedido"
                                       @change="calcularTotais"
                                       class="sr-only peer"
                                       aria-required="true">
                                <label for="tipo-balcao"
                                       class="block w-full px-3 py-2 text-center border rounded-md cursor-pointer peer-checked:bg-pizza-600 peer-checked:text-white peer-checked:border-pizza-600 hover:bg-gray-50"
                                       tabindex="0"
                                       @keydown.enter="tipoPedido = 'balcao'; calcularTotais()"
                                       @keydown.space.prevent="tipoPedido = 'balcao'; calcularTotais()">
                                    üè™ Balc√£o
                                </label>
                            </div>
                            
                            <div>
                                <input type="radio"
                                       id="tipo-mesa"
                                       name="tipo_pedido"
                                       value="mesa"
                                       x-model="tipoPedido"
                                       @change="calcularTotais"
                                       class="sr-only peer"
                                       aria-required="true">
                                <label for="tipo-mesa"
                                       class="block w-full px-3 py-2 text-center border rounded-md cursor-pointer peer-checked:bg-pizza-600 peer-checked:text-white peer-checked:border-pizza-600 hover:bg-gray-50"
                                       tabindex="0"
                                       @keydown.enter="tipoPedido = 'mesa'; calcularTotais()"
                                       @keydown.space.prevent="tipoPedido = 'mesa'; calcularTotais()">
                                    üçΩÔ∏è Mesa
                                </label>
                            </div>
                        </div>
                    </fieldset>
                </div>
                
                <!-- Endere√ßo (apenas para Delivery) -->
                <div x-show="tipoPedido === 'delivery'" 
                     x-transition
                     class="mb-4">
                    <label for="endereco" class="block text-sm font-medium text-gray-700 campo-obrigatorio">
                        Endere√ßo de Entrega
                    </label>
                    <textarea id="endereco"
                              name="endereco"
                              x-model="endereco"
                              @blur="validarCampo('endereco')"
                              :class="{ 'campo-invalido': erros.endereco }"
                              rows="3"
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pizza-500 focus:ring-pizza-500 sm:text-sm"
                              placeholder="Rua, n√∫mero, bairro, refer√™ncia..."
                              :aria-required="tipoPedido === 'delivery' ? 'true' : 'false'"
                              :aria-invalid="erros.endereco ? 'true' : 'false'"
                              aria-describedby="erro-endereco"
                              :required="tipoPedido === 'delivery'"></textarea>
                    <p x-show="erros.endereco" 
                       x-text="erros.endereco"
                       id="erro-endereco"
                       class="mensagem-erro"
                       role="alert"></p>
                </div>
                
                <!-- N√∫mero da Mesa (apenas para Mesa) -->
                <div x-show="tipoPedido === 'mesa'" 
                     x-transition
                     class="mb-4">
                    <label for="numero-mesa" class="block text-sm font-medium text-gray-700 campo-obrigatorio">
                        N√∫mero da Mesa
                    </label>
                    <input type="text"
                           id="numero-mesa"
                           name="numero_mesa"
                           x-model="numeroMesa"
                           @blur="validarCampo('numeroMesa')"
                           :class="{ 'campo-invalido': erros.numeroMesa }"
                           class="mt-1 block w-32 rounded-md border-gray-300 shadow-sm focus:border-pizza-500 focus:ring-pizza-500 sm:text-sm"
                           placeholder="Ex: 12"
                           :aria-required="tipoPedido === 'mesa' ? 'true' : 'false'"
                           :aria-invalid="erros.numeroMesa ? 'true' : 'false'"
                           aria-describedby="erro-mesa"
                           :required="tipoPedido === 'mesa'">
                    <p x-show="erros.numeroMesa" 
                       x-text="erros.numeroMesa"
                       id="erro-mesa"
                       class="mensagem-erro"
                       role="alert"></p>
                </div>
                
                <!-- Forma de Pagamento -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 campo-obrigatorio mb-3">
                        üí≥ Forma de Pagamento
                    </label>
                    
                    <!-- Grid de bot√µes de pagamento -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <!-- Dinheiro -->
                        <button type="button"
                                @click="selecionarFormaPagamento('dinheiro')"
                                :class="formaPagamento === 'dinheiro' ? 'forma-pagamento-ativa' : 'forma-pagamento'"
                                class="forma-pagamento">
                            <span class="text-2xl mb-1">üí∞</span>
                            <span class="text-sm font-medium">Dinheiro</span>
                        </button>
                        
                        <!-- Cart√£o Cr√©dito -->
                        <button type="button"
                                @click="selecionarFormaPagamento('cartao_credito')"
                                :class="formaPagamento === 'cartao_credito' ? 'forma-pagamento-ativa' : 'forma-pagamento'"
                                class="forma-pagamento">
                            <span class="text-2xl mb-1">üí≥</span>
                            <span class="text-sm font-medium">Cart√£o Cr√©dito</span>
                        </button>
                        
                        <!-- Cart√£o D√©bito -->
                        <button type="button"
                                @click="selecionarFormaPagamento('cartao_debito')"
                                :class="formaPagamento === 'cartao_debito' ? 'forma-pagamento-ativa' : 'forma-pagamento'"
                                class="forma-pagamento">
                            <span class="text-2xl mb-1">üí≥</span>
                            <span class="text-sm font-medium">Cart√£o D√©bito</span>
                        </button>
                        
                        <!-- PIX -->
                        <button type="button"
                                @click="selecionarFormaPagamento('pix')"
                                :class="formaPagamento === 'pix' ? 'forma-pagamento-ativa' : 'forma-pagamento'"
                                class="forma-pagamento">
                            <span class="text-2xl mb-1">üì±</span>
                            <span class="text-sm font-medium">PIX</span>
                        </button>
                    </div>
                    
                    <!-- Erro de valida√ß√£o -->
                    <p x-show="erros.formaPagamento" 
                       x-text="erros.formaPagamento"
                       class="mensagem-erro mt-2"
                       role="alert"></p>
                    
                    <!-- Campo de troco (apenas para dinheiro) -->
                    <div x-show="formaPagamento === 'dinheiro'" 
                         x-transition
                         class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="font-medium text-gray-900 mb-3">üíµ Precisa de Troco?</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label for="troco-para" class="block text-sm font-medium text-gray-700">
                                    Troco para:
                                </label>
                                <div class="mt-1 relative rounded-md shadow-sm">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="text-gray-500 sm:text-sm">R$</span>
                                    </div>
                                    <input type="number"
                                           id="troco-para"
                                           x-model.number="trocoPara"
                                           @input="calcularTroco"
                                           @blur="validarTroco"
                                           :class="{ 'campo-invalido': erros.troco }"
                                           class="pl-12 block w-full rounded-md border-gray-300 focus:ring-pizza-500 focus:border-pizza-500 sm:text-sm"
                                           placeholder="100,00"
                                           step="0.01"
                                           min="0">
                                </div>
                                <p x-show="erros.troco" 
                                   x-text="erros.troco"
                                   class="mensagem-erro mt-1"
                                   role="alert"></p>
                            </div>
                            
                            <div class="text-center">
                                <span class="text-sm text-gray-600">Total do Pedido:</span>
                                <div class="text-xl font-bold text-gray-900">
                                    R$ <span x-text="total.toFixed(2)"></span>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <span class="text-sm text-gray-600">Troco:</span>
                                <div class="text-xl font-bold text-green-600">
                                    R$ <span x-text="trocoCalculado.toFixed(2)"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informa√ß√µes adicionais por forma de pagamento -->
                    <div x-show="formaPagamento === 'pix'" 
                         x-transition
                         class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-center">
                            <svg class="h-5 w-5 text-blue-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                            </svg>
                            <span class="text-sm text-blue-800">
                                A chave PIX ser√° enviada via WhatsApp ap√≥s confirmar o pedido
                            </span>
                        </div>
                    </div>
                    
                    <div x-show="formaPagamento === 'cartao_credito'" 
                         x-transition
                         class="mt-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                        <div class="flex items-center">
                            <svg class="h-5 w-5 text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                            </svg>
                            <span class="text-sm text-yellow-800">
                                Aceitamos parcelamento em at√© 3x sem juros
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Se√ß√£o: Produtos e Carrinho -->
        <section class="secao-formulario">
            <div class="secao-header" 
                 @click="secaoProdutosAberta = !secaoProdutosAberta"
                 role="button"
                 :aria-expanded="secaoProdutosAberta ? 'true' : 'false'"
                 aria-controls="produtos"
                 tabindex="0"
                 @keydown.enter="secaoProdutosAberta = !secaoProdutosAberta"
                 @keydown.space.prevent="secaoProdutosAberta = !secaoProdutosAberta">
                <h2 class="text-lg font-medium text-gray-900">
                    Produtos
                    <span x-show="carrinho.length > 0" 
                          class="ml-2 px-2 py-1 text-xs bg-pizza-600 text-white rounded-full">
                        <span x-text="carrinho.length"></span>
                    </span>
                </h2>
                <svg class="w-5 h-5 text-gray-500 transition-transform"
                     :class="{ 'transform rotate-180': secaoProdutosAberta }"
                     fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            
            <div x-show="secaoProdutosAberta" 
                 x-transition
                 id="produtos"
                 class="secao-content">
                
                <!-- Layout com produtos e carrinho -->
                <div class="layout-produtos flex flex-col lg:flex-row gap-6">
                    
                    <!-- √Årea de Produtos -->
                    <div class="flex-1">
                        <!-- Abas de Categorias -->
                        <div class="flex flex-wrap gap-2 mb-6">
                            <button type="button"
                                    @click="abaAtiva = 'pizzas'"
                                    :class="abaAtiva === 'pizzas' ? 'aba-produto active' : 'aba-produto'"
                                    class="aba-produto">
                                üçï Pizzas
                            </button>
                            <button type="button"
                                    @click="abaAtiva = 'bebidas'"
                                    :class="abaAtiva === 'bebidas' ? 'aba-produto active' : 'aba-produto'"
                                    class="aba-produto">
                                ü•§ Bebidas
                            </button>
                            <button type="button"
                                    @click="abaAtiva = 'bordas'"
                                    :class="abaAtiva === 'bordas' ? 'aba-produto active' : 'aba-produto'"
                                    class="aba-produto">
                                ‚≠ï Bordas
                            </button>
                        </div>
                        
                        <!-- Conte√∫do das Abas -->
                        
                        <!-- Aba Pizzas -->
                        <div x-show="abaAtiva === 'pizzas'" class="space-y-4">

                            <!-- Busca de Pizzas -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                                <div class="relative">
                                    <input type="text" 
                                           x-model="buscaPizza"
                                           @input="filtrarPizzas"
                                           placeholder="üîç Buscar pizza por nome ou ingredientes..."
                                           class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-pizza-500 focus:border-pizza-500 text-lg">
                                    <svg class="absolute left-3 top-3.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                    <div x-show="buscaPizza" 
                                         @click="buscaPizza = ''; filtrarPizzas()"
                                         class="absolute right-3 top-3.5 w-5 h-5 text-gray-400 cursor-pointer hover:text-gray-600">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <!-- NOVA INTERFACE: Header de Sele√ß√£o do Segundo Sabor -->
                            <div x-show="estadoSelecao.modo === 'selecionando_segundo'" class="header-selecao-segundo">
                                <h3 class="text-xl font-bold mb-3">
                                    üçï Selecionando 2¬∫ Sabor para Pizza Meio a Meio
                                </h3>
                                
                                <div class="primeiro-sabor-info">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">üçï</span>
                                        <div class="flex-1">
                                            <div class="font-bold text-gray-900">
                                                1¬∫ SABOR: <span x-text="estadoSelecao.primeiroSabor?.pizza?.nome"></span>
                                            </div>
                                            <div class="text-sm text-gray-600">
                                                Tamanho: <span x-text="estadoSelecao.tamanhoSelecionado"></span> - 
                                                R$ <span x-text="estadoSelecao.primeiroSabor?.preco?.toFixed(2)"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <p class="text-center text-white/90 mb-4">
                                    <strong>SELECIONE O SEGUNDO SABOR:</strong> Clique direto na pizza desejada abaixo
                                </p>
                                
                                <div class="acoes-selecao">
                                    <button type="button" @click="cancelarMeioAMeio()" class="btn-cancelar">
                                        ‚ùå Cancelar Meio a Meio
                                    </button>
                                    <button type="button" @click="trocarPrimeiroSabor()" class="btn-trocar">
                                        üîÑ Trocar 1¬∫ Sabor
                                    </button>
                                </div>
                            </div>

                            <!-- Interface Simples e Robusta de Pizzas -->
                            <div x-show="!carregandoProdutos && !erroProdutos" 
                                 :class="{ 'modo-selecao-segundo': estadoSelecao.modo === 'selecionando_segundo' }"
                                 class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                                <!-- Header condicional -->
                                <div x-show="estadoSelecao.modo === 'normal'" class="px-6 py-3 bg-gradient-to-r from-pizza-600 to-pizza-700 text-white font-bold">
                                    <span class="text-xl">üçï Pizzas Dispon√≠veis</span>
                                    <span x-show="pizzasFiltradas && pizzasFiltradas.length > 0">
                                        (<span x-text="pizzasFiltradas.length"></span>)
                                    </span>
                                </div>
                                
                                <!-- Header para modo sele√ß√£o -->
                                <div x-show="estadoSelecao.modo === 'selecionando_segundo'" class="px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white font-bold">
                                    <span class="text-xl">‚úÖ Escolha o Segundo Sabor</span>
                                    <span x-show="pizzasFiltradas && pizzasFiltradas.length > 0">
                                        (<span x-text="pizzasFiltradas.length"></span> op√ß√µes)
                                    </span>
                                </div>
                                
                                <!-- Conte√∫do das pizzas -->
                                <div class="p-4">
                                    <!-- Se h√° pizzas -->
                                    <div x-show="pizzasFiltradas && pizzasFiltradas.length > 0" class="space-y-4">
                                        <template x-for="pizza in pizzasFiltradas" :key="pizza.id">
                                            <!-- Card Normal ou Modo Sele√ß√£o -->
                                            <div class="pizza-card border border-gray-200 rounded-lg p-4 transition-all"
                                                 :class="{
                                                     'hover:bg-gray-50': estadoSelecao.modo === 'normal',
                                                     'disponivel cursor-pointer': estadoSelecao.modo === 'selecionando_segundo' && pizza.id !== estadoSelecao.primeiroSabor?.pizza?.id,
                                                     'selecionado-primeiro': estadoSelecao.modo === 'selecionando_segundo' && pizza.id === estadoSelecao.primeiroSabor?.pizza?.id
                                                 }"
                                                 @click="estadoSelecao.modo === 'selecionando_segundo' && pizza.id !== estadoSelecao.primeiroSabor?.pizza?.id ? selecionarSegundoSabor(pizza) : null">
                                                
                                                <div class="flex items-start gap-3 mb-3">
                                                    <span class="text-2xl">üçï</span>
                                                    <div class="flex-1">
                                                        <h3 class="font-bold text-gray-900 uppercase" x-text="pizza.nome"></h3>
                                                        <p class="text-sm text-gray-600 mt-1" x-text="pizza.ingredientes"></p>
                                                        
                                                        <!-- Pre√ßo no modo sele√ß√£o -->
                                                        <div x-show="estadoSelecao.modo === 'selecionando_segundo' && pizza.id !== estadoSelecao.primeiroSabor?.pizza?.id" 
                                                             class="mt-2 p-2 bg-green-50 border border-green-200 rounded text-sm">
                                                            <strong>Pre√ßo Final:</strong> R$ 
                                                            <span x-text="Math.max(estadoSelecao.primeiroSabor?.preco || 0, obterPrecoTamanhoNumerico(pizza, estadoSelecao.tamanhoSelecionado) || 0).toFixed(2)"></span>
                                                            <br>
                                                            <span class="text-green-700 text-xs">(valor do sabor mais caro)</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- CTA para sele√ß√£o de segundo sabor -->
                                                <div x-show="estadoSelecao.modo === 'selecionando_segundo' && pizza.id !== estadoSelecao.primeiroSabor?.pizza?.id" 
                                                     class="selecao-cta">
                                                    ‚úÖ CLIQUE PARA COMPLETAR MEIO A MEIO
                                                </div>
                                                
                                                <!-- Grid de Pre√ßos (modo normal) -->
                                                <div x-show="estadoSelecao.modo === 'normal'" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                                    <template x-for="tamanho in ['Pequena', 'M√©dia', 'Grande', 'Fam√≠lia']" :key="tamanho">
                                                        <div x-show="obterPrecoTamanho(pizza, tamanho)" 
                                                             class="text-center p-3 bg-gray-100 rounded-lg">
                                                            <div class="text-xs text-gray-600 font-medium uppercase" x-text="tamanho"></div>
                                                            <div class="text-lg font-bold text-green-600 mt-1">
                                                                R$ <span x-text="obterPrecoTamanho(pizza, tamanho)"></span>
                                                            </div>
                                                            <button type="button"
                                                                    @click="abrirModalPizza(pizza, tamanho)"
                                                                    class="w-full mt-2 px-2 py-1 bg-pizza-600 text-white text-xs rounded hover:bg-pizza-700 transition-colors">
                                                                + Adicionar
                                                            </button>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                    
                                    <!-- Se n√£o h√° pizzas -->
                                    <div x-show="!pizzasFiltradas || pizzasFiltradas.length === 0" class="text-center py-8">
                                        <span class="text-6xl mb-4 block">üçï</span>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2">Aguardando pizzas...</h3>
                                        <p class="text-sm text-gray-600">Os dados est√£o sendo carregados</p>
                                    </div>
                                    
                                </div>
                            </div>

                            <!-- Loading state -->
                            <div x-show="carregandoProdutos" class="text-center py-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pizza-600 mx-auto mb-4"></div>
                                <p class="text-gray-600">Carregando pizzas...</p>
                            </div>
                            
                            <!-- Erro ao carregar -->
                            <div x-show="erroProdutos && !carregandoProdutos" class="bg-red-50 border border-red-200 rounded-md p-4 text-center">
                                <p class="text-red-600" x-text="erroProdutos"></p>
                                <button @click="carregarProdutos()" class="mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                                    Tentar Novamente
                                </button>
                            </div>
                            
                            <!-- Tabela de Pizzas (Desktop) -->
                            <div x-show="!carregandoProdutos && !erroProdutos" class="hidden md:block bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                                <div class="overflow-x-auto">
                                    <table class="w-full pizza-table">
                                        <thead>
                                            <tr>
                                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    üçï Pizza
                                                </th>
                                                <th class="px-4 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Pequena
                                                </th>
                                                <th class="px-4 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    M√©dia
                                                </th>
                                                <th class="px-4 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Grande
                                                </th>
                                                <th class="px-4 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Fam√≠lia
                                                </th>
                                                <th class="px-4 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    A√ß√µes
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <!-- Pizzas por categoria -->
                                            <template x-for="categoria in categoriasOrdenadas" :key="categoria">
                                                <template x-if="obterPizzasPorCategoria(categoria).length > 0">
                                                    <template>
                                                        <!-- Header da Categoria -->
                                                        <tr>
                                                            <td colspan="6" class="px-6 py-3 bg-gradient-to-r from-pizza-600 to-pizza-700 text-white font-bold text-sm uppercase tracking-wider">
                                                                <span x-text="categoria"></span>
                                                            </td>
                                                        </tr>
                                                        
                                                        <!-- Pizzas da Categoria -->
                                                        <template x-for="pizza in obterPizzasPorCategoria(categoria)" :key="pizza.id">
                                                            <tr class="pizza-row hover:bg-red-50 transition-all duration-150">
                                                                <td class="px-6 py-4">
                                                                    <div class="flex items-start gap-3">
                                                                        <span class="text-2xl flex-shrink-0">üçï</span>
                                                                        <div class="flex-1">
                                                                            <div class="pizza-name font-bold text-gray-900 uppercase" x-text="pizza.nome"></div>
                                                                            <div class="pizza-ingredients text-sm text-gray-600 mt-1" x-text="pizza.ingredientes"></div>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                
                                                                <!-- Colunas de Pre√ßos -->
                                                                <template x-for="(tamanho, index) in ['Pequena', 'M√©dia', 'Grande', 'Fam√≠lia']" :key="tamanho">
                                                                    <td class="px-4 py-4 text-center">
                                                                        <template x-if="obterPrecoTamanho(pizza, tamanho)">
                                                                            <div class="space-y-2">
                                                                                <div class="price-cell font-bold text-green-600">
                                                                                    R$ <span x-text="obterPrecoTamanho(pizza, tamanho)"></span>
                                                                                </div>
                                                                                <button type="button"
                                                                                        @click="abrirModalPizza(pizza, tamanho)"
                                                                                        class="px-3 py-1 bg-pizza-600 text-white text-xs rounded-full hover:bg-pizza-700 transition-colors">
                                                                                    + Adicionar
                                                                                </button>
                                                                            </div>
                                                                        </template>
                                                                        <template x-if="!obterPrecoTamanho(pizza, tamanho)">
                                                                            <span class="text-gray-400">-</span>
                                                                        </template>
                                                                    </td>
                                                                </template>
                                                            </tr>
                                                        </template>
                                                    </template>
                                                </template>
                                            </template>
                                            
                                            <!-- Fallback: Mostrar todas as pizzas se categorias n√£o funcionarem -->
                                            <template x-if="categoriasOrdenadas.length === 0 && pizzasFiltradas.length > 0">
                                                <template>
                                                    <!-- Header padr√£o -->
                                                    <tr>
                                                        <td colspan="6" class="px-6 py-3 bg-gradient-to-r from-pizza-600 to-pizza-700 text-white font-bold text-sm uppercase tracking-wider">
                                                            üçï Todas as Pizzas
                                                        </td>
                                                    </tr>
                                                    
                                                    <!-- Todas as pizzas -->
                                                    <template x-for="pizza in pizzasFiltradas" :key="pizza.id">
                                                        <tr class="pizza-row hover:bg-red-50 transition-all duration-150">
                                                            <td class="px-6 py-4">
                                                                <div class="flex items-start gap-3">
                                                                    <span class="text-2xl flex-shrink-0">üçï</span>
                                                                    <div class="flex-1">
                                                                        <div class="pizza-name font-bold text-gray-900 uppercase" x-text="pizza.nome"></div>
                                                                        <div class="pizza-ingredients text-sm text-gray-600 mt-1" x-text="pizza.ingredientes"></div>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            
                                                            <!-- Colunas de Pre√ßos -->
                                                            <template x-for="(tamanho, index) in ['Pequena', 'M√©dia', 'Grande', 'Fam√≠lia']" :key="tamanho">
                                                                <td class="px-4 py-4 text-center">
                                                                    <template x-if="obterPrecoTamanho(pizza, tamanho)">
                                                                        <div class="space-y-2">
                                                                            <div class="price-cell font-bold text-green-600">
                                                                                R$ <span x-text="obterPrecoTamanho(pizza, tamanho)"></span>
                                                                            </div>
                                                                            <button type="button"
                                                                                    @click="abrirModalPizza(pizza, tamanho)"
                                                                                    class="px-3 py-1 bg-pizza-600 text-white text-xs rounded-full hover:bg-pizza-700 transition-colors add-button-hover">
                                                                                + Adicionar
                                                                            </button>
                                                                        </div>
                                                                    </template>
                                                                    <template x-if="!obterPrecoTamanho(pizza, tamanho)">
                                                                        <span class="text-gray-400">-</span>
                                                                    </template>
                                                                </td>
                                                            </template>
                                                        </tr>
                                                    </template>
                                                </template>
                                            </template>
                                            
                                            <!-- Nenhuma pizza encontrada -->
                                            <template x-if="pizzasFiltradas.length === 0 && !carregandoProdutos">
                                                <tr>
                                                    <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                                        <div class="flex flex-col items-center">
                                                            <span class="text-6xl mb-4">üçï</span>
                                                            <p class="text-lg">Nenhuma pizza encontrada</p>
                                                            <p class="text-sm mt-2">Tente buscar por outro nome ou ingrediente</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Cards Mobile -->
                            <div x-show="!carregandoProdutos && !erroProdutos" class="md:hidden space-y-4">
                                <template x-for="categoria in categoriasOrdenadas" :key="categoria">
                                    <template x-if="obterPizzasPorCategoria(categoria).length > 0">
                                        <div>
                                            <!-- Header da Categoria -->
                                            <div class="bg-pizza-600 text-white px-4 py-2 rounded-lg font-bold text-sm uppercase tracking-wider mb-3">
                                                <span x-text="categoria"></span>
                                            </div>
                                            
                                            <!-- Pizzas da Categoria -->
                                            <template x-for="pizza in obterPizzasPorCategoria(categoria)" :key="pizza.id">
                                                <div class="pizza-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                                                    <div class="flex items-start gap-3 mb-4">
                                                        <span class="text-2xl">üçï</span>
                                                        <div class="flex-1">
                                                            <h3 class="font-bold text-gray-900 uppercase" x-text="pizza.nome"></h3>
                                                            <p class="text-sm text-gray-600 mt-1" x-text="pizza.ingredientes"></p>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Grid de Pre√ßos -->
                                                    <div class="grid grid-cols-2 gap-3">
                                                        <template x-for="tamanho in ['Pequena', 'M√©dia', 'Grande', 'Fam√≠lia']" :key="tamanho">
                                                            <template x-if="obterPrecoTamanho(pizza, tamanho)">
                                                                <div class="price-item bg-gray-50 border border-gray-200 rounded-lg p-3 text-center transition-all hover:bg-gray-100">
                                                                    <div class="text-xs text-gray-600 font-medium uppercase" x-text="tamanho"></div>
                                                                    <div class="text-lg font-bold text-green-600 mt-1">
                                                                        R$ <span x-text="obterPrecoTamanho(pizza, tamanho)"></span>
                                                                    </div>
                                                                    <button type="button"
                                                                            @click="abrirModalPizza(pizza, tamanho)"
                                                                            class="w-full mt-2 px-2 py-1 bg-pizza-600 text-white text-xs rounded hover:bg-pizza-700 transition-colors">
                                                                        + Adicionar
                                                                    </button>
                                                                </div>
                                                            </template>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </template>
                                
                                <!-- Fallback: Mostrar todas as pizzas se categorias n√£o funcionarem (Mobile) -->
                                <template x-if="categoriasOrdenadas.length === 0 && pizzasFiltradas.length > 0">
                                    <div>
                                        <!-- Header padr√£o -->
                                        <div class="bg-pizza-600 text-white px-4 py-2 rounded-lg font-bold text-sm uppercase tracking-wider mb-3">
                                            üçï Todas as Pizzas
                                        </div>
                                        
                                        <!-- Todas as pizzas -->
                                        <template x-for="pizza in pizzasFiltradas" :key="pizza.id">
                                            <div class="pizza-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm mb-4">
                                                <div class="flex items-start gap-3 mb-4">
                                                    <span class="text-2xl">üçï</span>
                                                    <div class="flex-1">
                                                        <h3 class="font-bold text-gray-900 uppercase" x-text="pizza.nome"></h3>
                                                        <p class="text-sm text-gray-600 mt-1" x-text="pizza.ingredientes"></p>
                                                    </div>
                                                </div>
                                                
                                                <!-- Grid de Pre√ßos -->
                                                <div class="grid grid-cols-2 gap-3">
                                                    <template x-for="tamanho in ['Pequena', 'M√©dia', 'Grande', 'Fam√≠lia']" :key="tamanho">
                                                        <template x-if="obterPrecoTamanho(pizza, tamanho)">
                                                            <div class="price-item bg-gray-50 border border-gray-200 rounded-lg p-3 text-center transition-all hover:bg-gray-100">
                                                                <div class="text-xs text-gray-600 font-medium uppercase" x-text="tamanho"></div>
                                                                <div class="text-lg font-bold text-green-600 mt-1">
                                                                    R$ <span x-text="obterPrecoTamanho(pizza, tamanho)"></span>
                                                                </div>
                                                                <button type="button"
                                                                        @click="abrirModalPizza(pizza, tamanho)"
                                                                        class="w-full mt-2 px-2 py-1 bg-pizza-600 text-white text-xs rounded hover:bg-pizza-700 transition-colors">
                                                                    + Adicionar
                                                                </button>
                                                            </div>
                                                        </template>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                                
                                <!-- Nenhuma pizza encontrada -->
                                <template x-if="pizzasFiltradas.length === 0 && !carregandoProdutos">
                                    <div class="text-center py-12">
                                        <span class="text-6xl">üçï</span>
                                        <p class="text-gray-500 mt-4">Nenhuma pizza encontrada</p>
                                        <p class="text-sm text-gray-400 mt-2">Tente buscar por outro nome ou ingrediente</p>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Aba Bebidas -->
                        <div x-show="abaAtiva === 'bebidas'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <template x-for="bebida in produtos.bebidas" :key="bebida.id">
                                <div class="produto-card">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-xl mr-3">
                                            ü•§
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold text-gray-900" x-text="bebida.nome"></h3>
                                            <p class="text-pizza-600 font-medium" x-text="`R$ ${bebida.preco.toFixed(2)}`"></p>
                                        </div>
                                        <button type="button"
                                                @click="adicionarItem(bebida, 'bebida')"
                                                class="w-8 h-8 bg-pizza-600 text-white rounded-full hover:bg-pizza-700 transition-colors">
                                            +
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Aba Bordas -->
                        <div x-show="abaAtiva === 'bordas'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <template x-for="borda in produtos.bordas" :key="borda.id">
                                <div class="produto-card">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center text-xl mr-3">
                                            ‚≠ï
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold text-gray-900" x-text="borda.nome"></h3>
                                            <p class="text-xs text-gray-500 mb-1" x-text="borda.descricao"></p>
                                            <p class="text-pizza-600 font-medium" x-text="`R$ ${borda.preco.toFixed(2)}`"></p>
                                        </div>
                                        <button type="button"
                                                @click="adicionarItem(borda, 'borda')"
                                                class="w-8 h-8 bg-pizza-600 text-white rounded-full hover:bg-pizza-700 transition-colors">
                                            +
                                        </button>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Mensagem quando n√£o h√° bordas -->
                            <div x-show="produtos.bordas.length === 0" class="col-span-full text-center py-8 text-gray-500">
                                <div class="text-4xl mb-2">‚≠ï</div>
                                <p>Nenhuma borda dispon√≠vel</p>
                                <p class="text-sm">Bordas recheadas em breve!</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Carrinho Lateral -->
                    <div class="w-full lg:w-80">
                        <div class="carrinho-lateral">
                            <div class="p-4 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                    üõí Carrinho
                                    <span x-show="carrinho.length > 0" 
                                          class="ml-2 px-2 py-1 text-xs bg-pizza-600 text-white rounded-full">
                                        <span x-text="carrinho.length"></span>
                                    </span>
                                </h3>
                            </div>
                            
                            <div class="p-4">
                                <!-- Itens do Carrinho -->
                                <div x-show="carrinho.length > 0" class="space-y-3 mb-4">
                                    <template x-for="(item, index) in carrinho" :key="index">
                                        <div class="carrinho-item">
                                            <div class="carrinho-item-info">
                                                <h4 class="font-medium text-gray-900" x-text="item.nome"></h4>
                                                <p x-show="item.tamanho" class="text-xs text-gray-500">
                                                    Tamanho: <span x-text="item.tamanho"></span>
                                                </p>
                                                <p class="text-sm text-pizza-600 font-medium">
                                                    R$ <span x-text="(item.preco * item.quantidade).toFixed(2)"></span>
                                                </p>
                                            </div>
                                            <div class="carrinho-item-controls">
                                                <!-- Controles de Quantidade -->
                                                <div class="flex items-center bg-gray-50 rounded-lg">
                                                    <button type="button"
                                                            @click="diminuirQuantidade(index)"
                                                            :disabled="item.quantidade <= 1"
                                                            :class="{ 'opacity-50 cursor-not-allowed': item.quantidade <= 1 }"
                                                            class="w-8 h-8 flex items-center justify-center text-pizza-600 hover:bg-pizza-100 rounded-l-lg transition-colors"
                                                            title="Diminuir quantidade">
                                                        ‚àí
                                                    </button>
                                                    <span class="w-10 h-8 flex items-center justify-center text-sm font-semibold bg-white border-t border-b border-gray-200" 
                                                          x-text="item.quantidade"></span>
                                                    <button type="button"
                                                            @click="aumentarQuantidade(index)"
                                                            class="w-8 h-8 flex items-center justify-center text-pizza-600 hover:bg-pizza-100 rounded-r-lg transition-colors"
                                                            title="Aumentar quantidade">
                                                        +
                                                    </button>
                                                </div>
                                                
                                                <!-- Bot√£o Remover -->
                                                <button type="button"
                                                        @click="removerItem(index)"
                                                        class="w-8 h-8 flex items-center justify-center text-red-500 hover:text-white hover:bg-red-500 rounded-lg transition-colors ml-2"
                                                        title="Remover item do carrinho">
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Carrinho Vazio -->
                                <div x-show="carrinho.length === 0" class="text-center py-8 text-gray-500">
                                    <div class="text-4xl mb-2">üõí</div>
                                    <p>Carrinho vazio</p>
                                    <p class="text-sm">Adicione produtos para continuar</p>
                                </div>
                                
                                <!-- Totais -->
                                <div x-show="carrinho.length > 0" class="carrinho-totais">
                                    <div class="total-linha">
                                        <span>Subtotal:</span>
                                        <span>R$ <span x-text="subtotal.toFixed(2)"></span></span>
                                    </div>
                                    <div x-show="tipoPedido === 'delivery'" class="total-linha">
                                        <span>Taxa de Entrega:</span>
                                        <div class="flex items-center space-x-2">
                                            <span>R$ <span x-text="taxaEntrega.toFixed(2)"></span></span>
                                            <button type="button" 
                                                    @click="abrirEdicaoTaxa()"
                                                    class="text-xs text-pizza-600 hover:text-pizza-700 transition-colors"
                                                    title="Editar taxa">
                                                ‚úèÔ∏è
                                            </button>
                                        </div>
                                    </div>
                                    <div x-show="subtotal < pedidoMinimo && tipoPedido === 'delivery'" class="total-linha text-amber-600">
                                        <span class="text-xs">Pedido m√≠nimo: R$ <span x-text="pedidoMinimo.toFixed(2)"></span></span>
                                    </div>
                                    <div class="total-linha final">
                                        <span>Total:</span>
                                        <span>R$ <span x-text="total.toFixed(2)"></span></span>
                                    </div>
                                    
                                    <!-- Forma de Pagamento no Carrinho -->
                                    <div x-show="formaPagamento" class="mt-3 p-3 bg-gray-50 rounded-lg">
                                        <div class="text-sm text-gray-600 mb-1">Forma de Pagamento:</div>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <span x-show="formaPagamento === 'dinheiro'" class="text-lg mr-2">üí∞</span>
                                                <span x-show="formaPagamento === 'cartao_credito'" class="text-lg mr-2">üí≥</span>
                                                <span x-show="formaPagamento === 'cartao_debito'" class="text-lg mr-2">üí≥</span>
                                                <span x-show="formaPagamento === 'pix'" class="text-lg mr-2">üì±</span>
                                                <span class="font-medium text-gray-900" x-text="
                                                    formaPagamento === 'dinheiro' ? 'Dinheiro' :
                                                    formaPagamento === 'cartao_credito' ? 'Cart√£o Cr√©dito' :
                                                    formaPagamento === 'cartao_debito' ? 'Cart√£o D√©bito' :
                                                    formaPagamento === 'pix' ? 'PIX' : ''
                                                "></span>
                                            </div>
                                            <button type="button" 
                                                    @click="formaPagamento = ''"
                                                    class="text-xs text-gray-500 hover:text-gray-700"
                                                    title="Alterar forma de pagamento">
                                                alterar
                                            </button>
                                        </div>
                                        <div x-show="formaPagamento === 'dinheiro' && trocoPara > 0" class="mt-2 text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Troco para:</span>
                                                <span class="font-medium">R$ <span x-text="trocoPara.toFixed(2)"></span></span>
                                            </div>
                                            <div class="flex justify-between text-green-600">
                                                <span>Troco:</span>
                                                <span class="font-medium">R$ <span x-text="trocoCalculado.toFixed(2)"></span></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Bot√µes de A√ß√£o do Carrinho -->
                                    <div class="mt-4 space-y-2">
                                        <!-- Bot√£o Imprimir Comanda -->
                                        <button type="button"
                                                @click="imprimirComanda()"
                                                :disabled="carrinho.filter(item => item.tipo === 'pizza').length === 0"
                                                :class="{ 'opacity-50 cursor-not-allowed': carrinho.filter(item => item.tipo === 'pizza').length === 0 }"
                                                class="w-full px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 transition-colors disabled:hover:bg-green-600 flex items-center justify-center">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                                            </svg>
                                            üñ®Ô∏è Imprimir Comanda
                                        </button>
                                        
                                        <!-- Bot√£o Finalizar Pedido (movido para dentro do carrinho) -->
                                        <button type="button"
                                                @click="finalizarPedido()"
                                                :disabled="!formularioValido"
                                                :class="{ 'opacity-50 cursor-not-allowed': !formularioValido }"
                                                class="w-full px-4 py-2 bg-pizza-600 text-white text-sm font-medium rounded-md hover:bg-pizza-700 transition-colors disabled:hover:bg-pizza-600 flex items-center justify-center">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            üìã Finalizar Pedido
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Modal de Edi√ß√£o da Taxa de Entrega -->
        <div x-show="editandoTaxa" 
             x-transition:enter="transition ease-out duration-200" 
             x-transition:enter-start="opacity-0" 
             x-transition:enter-end="opacity-100" 
             x-transition:leave="transition ease-in duration-150" 
             x-transition:leave-start="opacity-100" 
             x-transition:leave-end="opacity-0" 
             class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            
            <div x-show="editandoTaxa" 
                 x-transition:enter="transition ease-out duration-300" 
                 x-transition:enter-start="opacity-0 scale-95" 
                 x-transition:enter-end="opacity-100 scale-100" 
                 x-transition:leave="transition ease-in duration-200" 
                 x-transition:leave-start="opacity-100 scale-100" 
                 x-transition:leave-end="opacity-0 scale-95"
                 @click.away="fecharEdicaoTaxa()"
                 class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-96 overflow-y-auto">
                
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Taxa de Entrega</h3>
                        <button type="button" @click="fecharEdicaoTaxa()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Op√ß√µes Pr√©-definidas -->
                    <div class="space-y-2 mb-4">
                        <template x-for="taxa in taxasPreDefinidas" :key="taxa.valor">
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors"
                                   :class="{ 'border-pizza-500 bg-pizza-50': taxaEntrega === taxa.valor && !taxaPersonalizada }">
                                <input type="radio" 
                                       :value="taxa.valor" 
                                       :checked="taxaEntrega === taxa.valor && !taxaPersonalizada"
                                       @change="selecionarTaxaPreDefinida(taxa)"
                                       class="text-pizza-600 focus:ring-pizza-500">
                                <div class="ml-3 flex-1">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium text-gray-900" x-text="taxa.nome"></span>
                                        <span class="text-sm font-semibold text-pizza-600" x-text="`R$ ${taxa.valor.toFixed(2)}`"></span>
                                    </div>
                                </div>
                            </label>
                        </template>
                        
                        <!-- Op√ß√£o Personalizada -->
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors"
                               :class="{ 'border-pizza-500 bg-pizza-50': taxaPersonalizada }">
                            <input type="radio" 
                                   :checked="taxaPersonalizada"
                                   @change="habilitarTaxaPersonalizada()"
                                   class="text-pizza-600 focus:ring-pizza-500">
                            <div class="ml-3 flex-1">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-900">Personalizado</span>
                                    <div x-show="taxaPersonalizada" class="flex items-center space-x-2">
                                        <span class="text-sm text-gray-500">R$</span>
                                        <input type="number" 
                                               x-model="taxaCustomizada"
                                               step="0.01" 
                                               min="0"
                                               class="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-pizza-500 focus:border-pizza-500">
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>
                    
                    <!-- Bot√µes de A√ß√£o -->
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" 
                                @click="fecharEdicaoTaxa()"
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors">
                            Cancelar
                        </button>
                        <button type="button" 
                                x-show="taxaPersonalizada"
                                @click="aplicarTaxaPersonalizada()"
                                class="px-4 py-2 text-sm font-medium text-white bg-pizza-600 rounded-md hover:bg-pizza-700 transition-colors">
                            Aplicar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bot√£o de A√ß√£o -->
        <div class="flex justify-end mt-6">
            <button type="button"
                    @click="finalizarPedido()"
                    :disabled="!formularioValido"
                    :class="{ 'opacity-50 cursor-not-allowed': !formularioValido }"
                    class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-pizza-600 hover:bg-pizza-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pizza-500 disabled:hover:bg-pizza-600"
                    aria-label="Confirmar pedido. Certifique-se de preencher todos os campos obrigat√≥rios.">
                <span x-show="!formularioValido">Preencha os dados</span>
                <span x-show="formularioValido">Confirmar Pedido - R$ <span x-text="total.toFixed(2)"></span></span>
            </button>
        </div>
    </form>

    <!-- Modal de Sele√ß√£o de Pizza -->
    <div x-show="modalPizza.aberto" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto"
         @click="fecharModalPizza"
         role="dialog"
         aria-modal="true"
         aria-labelledby="modal-title">
        
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            
            <!-- Conte√∫do do Modal -->
            <div @click.stop 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-pizza-100 sm:mx-0 sm:h-10 sm:w-10">
                        <span class="text-2xl">üçï</span>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left flex-1">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Adicionar <span x-text="modalPizza.pizza?.nome"></span>
                        </h3>
                        <div class="mt-1">
                            <p class="text-sm text-gray-500">
                                Tamanho: <span x-text="modalPizza.tamanho"></span> - 
                                R$ <span x-text="modalPizza.preco?.toFixed(2)"></span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-5">
                    <!-- NOVO MODAL SIMPLES: Pizza Inteira vs Meio a Meio -->
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-4">Como voc√™ quer sua pizza?</p>
                        
                        <div class="space-y-3">
                            <!-- Pizza Inteira -->
                            <button type="button"
                                    @click="selecionarPizzaInteira()"
                                    class="w-full p-4 border-2 border-gray-300 rounded-lg hover:border-pizza-500 hover:bg-pizza-50 transition-all text-left group">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-semibold text-gray-900 group-hover:text-pizza-700">
                                            ‚óã Pizza Inteira
                                        </div>
                                        <div class="text-sm text-gray-600">
                                            Apenas o sabor <span class="font-medium" x-text="modalPizza.pizza?.nome"></span>
                                        </div>
                                    </div>
                                    <div class="text-lg font-bold text-green-600">
                                        R$ <span x-text="modalPizza.preco?.toFixed(2)"></span>
                                    </div>
                                </div>
                            </button>
                            
                            <!-- Meio a Meio -->
                            <button type="button"
                                    @click="iniciarSelecaoMeioAMeio()"
                                    class="w-full p-4 border-2 border-gray-300 rounded-lg hover:border-pizza-500 hover:bg-pizza-50 transition-all text-left group">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-semibold text-gray-900 group-hover:text-pizza-700">
                                            ‚óè Meio a Meio
                                        </div>
                                        <div class="text-sm text-gray-600">
                                            <span class="font-medium" x-text="modalPizza.pizza?.nome"></span> + outro sabor √† sua escolha
                                        </div>
                                    </div>
                                    <div class="text-lg font-bold text-green-600">
                                        R$ <span x-text="modalPizza.preco?.toFixed(2)"></span> + outro
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Observa√ß√µes -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes (opcional)</label>
                        <textarea x-model="modalPizza.observacoes"
                                  rows="2"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pizza-500 focus:ring-pizza-500 sm:text-sm"
                                  placeholder="Ex: sem cebola, borda recheada..."></textarea>
                    </div>
                </div>
                
                <!-- Footer Simples -->
                <div class="mt-4 flex justify-end">
                    <button type="button"
                            @click="fecharModalPizza"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        ‚ùå Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function pedidoForm() {
    console.log('üéõÔ∏è Iniciando pedidoForm...');
    return {
        // Estado do formul√°rio
        secaoClienteAberta: true,
        secaoProdutosAberta: true,
        abaAtiva: 'pizzas',
        
        // Dados do formul√°rio
        cliente: {
            nome: '',
            telefone: ''
        },
        tipoPedido: 'delivery',
        endereco: '',
        numeroMesa: '',
        
        // Forma de pagamento
        formaPagamento: '',
        trocoPara: 0,
        trocoCalculado: 0,
        
        // Carrinho e produtos
        carrinho: [],
        pizzaSelecionada: {},
        pizzaAdicionada: {},
        pedidoMinimo: 25.00,
        taxaEntrega: 5.00,
        taxasPreDefinidas: [
            {nome: 'Retirada', valor: 0.00},
            {nome: 'Pr√≥ximo (at√© 2km)', valor: 3.00},
            {nome: 'Padr√£o (2-5km)', valor: 5.00},
            {nome: 'Distante (5-8km)', valor: 8.00},
            {nome: 'Muito Distante (8km+)', valor: 12.00}
        ],
        editandoTaxa: false,
        taxaPersonalizada: false,
        taxaCustomizada: 0.00,
        
        // Valida√ß√£o
        erros: {},
        errosGlobais: [],
        
        // Produtos carregados da API
        produtos: {
            pizzas: [],
            bebidas: [],
            bordas: []
        },
        produtosCarregados: false,
        carregandoProdutos: false,
        erroProdutos: '',
        
        // Busca e filtros de pizzas
        buscaPizza: '',
        pizzasFiltradas: [],
        
        // Modal de sele√ß√£o de pizza
        modalPizza: {
            aberto: false,
            pizza: null,
            tamanho: '',
            preco: 0,
            tipo: 'inteira',
            segundoSabor: '',
            precoSegundoSabor: 0,
            precoTotal: 0,
            observacoes: ''
        },
        
        // Estados do novo sistema de sele√ß√£o visual
        estadoSelecao: {
            modo: 'normal', // 'normal' ou 'selecionando_segundo'
            primeiroSabor: null,
            tamanhoSelecionado: null,
            precoFinal: 0,
            observacoes: ''
        },
        
        // Carregar produtos da API
        async carregarProdutos() {
            console.log('üì¶ carregarProdutos() chamado');
            if (this.produtosCarregados || this.carregandoProdutos) {
                console.log('‚è≠Ô∏è Produtos j√° carregados ou carregando...');
                return;
            }
            
            this.carregandoProdutos = true;
            this.erroProdutos = '';
            
            try {
                console.log('üîÑ Carregando produtos da API...');
                
                const response = await fetch('/api/produtos/produtos/para_pedido/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Produtos carregados:', data);
                
                // Atualizar dados
                this.produtos = data;
                this.produtosCarregados = true;
                
                // Inicializar pizzas filtradas
                this.pizzasFiltradas = data.pizzas || [];
                
                
            } catch (error) {
                this.erroProdutos = `Erro ao carregar produtos: ${error.message}`;
                
                // Fallback com dados vazios em caso de erro
                this.produtos = {
                    pizzas: [],
                    bebidas: [],
                    bordas: []
                };
            } finally {
                this.carregandoProdutos = false;
            }
        },
        
        // Computed properties
        get subtotal() {
            return this.carrinho.reduce((total, item) => total + (item.preco * item.quantidade), 0);
        },
        
        get total() {
            let total = this.subtotal;
            if (this.tipoPedido === 'delivery') {
                total += this.taxaEntrega;
            }
            return total;
        },
        
        get formularioValido() {
            const nomeValido = this.cliente.nome.trim().length >= 3;
            const telefoneValido = this.cliente.telefone.replace(/\D/g, '').length >= 10;
            const carrinhoValido = this.carrinho.length > 0;
            const pagamentoValido = this.formaPagamento !== '';
            
            let tipoValido = true;
            if (this.tipoPedido === 'delivery') {
                tipoValido = this.endereco.trim().length > 0;
                // Verificar pedido m√≠nimo para delivery
                if (this.subtotal < this.pedidoMinimo) {
                    tipoValido = false;
                }
            } else if (this.tipoPedido === 'mesa') {
                tipoValido = this.numeroMesa.trim().length > 0;
            }
            
            // Validar troco se pagamento for em dinheiro
            let trocoValido = true;
            if (this.formaPagamento === 'dinheiro' && this.trocoPara > 0) {
                trocoValido = this.trocoPara >= this.total;
            }
            
            return nomeValido && telefoneValido && tipoValido && carrinhoValido && pagamentoValido && trocoValido;
        },
        
        // Computed properties para organiza√ß√£o de pizzas
        get categoriasOrdenadas() {
            // Como a API j√° organiza por tipo, criar categorias baseadas no tipo de pizza
            if (!this.pizzasFiltradas || this.pizzasFiltradas.length === 0) {
                return [];
            }
            
            // Identificar categorias dinamicamente baseado nos nomes das pizzas
            const categorias = new Set();
            this.pizzasFiltradas.forEach(pizza => {
                const categoria = this.identificarCategoriaPizza(pizza);
                categorias.add(categoria);
            });
            
            const lista = Array.from(categorias);
            return lista.sort((a, b) => {
                const ordem = ['Especiais', 'Tradicionais', 'Vegetarianas', 'Doces'];
                const indexA = ordem.indexOf(a);
                const indexB = ordem.indexOf(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
        },
        
        // M√©todo para identificar categoria da pizza baseado no nome/ingredientes
        identificarCategoriaPizza(pizza) {
            const nome = pizza.nome.toLowerCase();
            const ingredientes = (pizza.ingredientes || '').toLowerCase();
            
            // Pizzas especiais/gourmet
            if (nome.includes('chef') || nome.includes('premium') || nome.includes('camar√£o') || 
                ingredientes.includes('trufado') || ingredientes.includes('b√∫fala') || 
                ingredientes.includes('salm√£o') || nome.includes('especial')) {
                return 'Especiais';
            }
            
            // Pizzas doces
            if (nome.includes('chocolate') || nome.includes('doce') || nome.includes('nutella') ||
                ingredientes.includes('chocolate') || ingredientes.includes('doce')) {
                return 'Doces';
            }
            
            // Pizzas vegetarianas
            if (nome.includes('margherita') || nome.includes('vegetariana') || nome.includes('r√∫cula') ||
                ingredientes.includes('r√∫cula') || ingredientes.includes('vegetais')) {
                return 'Vegetarianas';
            }
            
            // Pizzas tradicionais (padr√£o)
            return 'Tradicionais';
        },
        
        async init() {
            console.log('üöÄ Init executado!');
            try {
                this.$nextTick(() => {
                    document.getElementById('cliente-nome')?.focus();
                });
                
                // Carregar produtos da API
                console.log('üì¶ Carregando produtos...');
                await this.carregarProdutos();
                console.log('‚úÖ Produtos carregados!');
            } catch (error) {
                console.error('‚ùå Erro no init:', error);
            }
        },
        
        // M√©todos para busca e filtros
        filtrarPizzas() {
            if (!this.buscaPizza.trim()) {
                this.pizzasFiltradas = this.produtos.pizzas || [];
                return;
            }
            
            const termo = this.buscaPizza.toLowerCase().trim();
            this.pizzasFiltradas = (this.produtos.pizzas || []).filter(pizza => {
                return pizza.nome.toLowerCase().includes(termo) ||
                       (pizza.ingredientes && pizza.ingredientes.toLowerCase().includes(termo));
            });
        },
        
        // M√©todos auxiliares para organiza√ß√£o
        obterPizzasPorCategoria(categoria) {
            return this.pizzasFiltradas.filter(pizza => {
                return this.identificarCategoriaPizza(pizza) === categoria;
            });
        },
        
        // M√©todos do modal de pizza (NOVO SISTEMA VISUAL)
        abrirModalPizza(pizza, tamanho) {
            const preco = this.obterPrecoTamanhoNumerico(pizza, tamanho);
            if (!preco) return;
            
            // Modal simples: Pizza Inteira vs Meio a Meio
            this.modalPizza = {
                aberto: true,
                pizza: pizza,
                tamanho: tamanho,
                preco: preco,
                tipo: 'inteira', // padr√£o
                segundoSabor: '',
                precoSegundoSabor: 0,
                precoTotal: preco,
                observacoes: ''
            };
        },
        
        // NOVO: Selecionar pizza inteira direto
        selecionarPizzaInteira() {
            this.adicionarPizzaAoCarrinho();
            this.fecharModalPizza();
        },
        
        // NOVO: Iniciar sele√ß√£o do meio a meio
        iniciarSelecaoMeioAMeio() {
            this.estadoSelecao = {
                modo: 'selecionando_segundo',
                primeiroSabor: {
                    pizza: this.modalPizza.pizza,
                    tamanho: this.modalPizza.tamanho,
                    preco: this.modalPizza.preco
                },
                tamanhoSelecionado: this.modalPizza.tamanho,
                precoFinal: this.modalPizza.preco,
                observacoes: this.modalPizza.observacoes
            };
            
            this.fecharModalPizza();
        },
        
        // NOVO: Selecionar segundo sabor
        selecionarSegundoSabor(pizza) {
            if (this.estadoSelecao.modo !== 'selecionando_segundo') return;
            
            const precoSegundo = this.obterPrecoTamanhoNumerico(pizza, this.estadoSelecao.tamanhoSelecionado);
            if (!precoSegundo) return;
            
            // Pizza meio a meio tem pre√ßo do sabor mais caro
            const precoFinal = Math.max(this.estadoSelecao.primeiroSabor.preco, precoSegundo);
            
            // Adicionar ao carrinho
            const itemCarrinho = {
                id: `pizza-meio-${this.estadoSelecao.primeiroSabor.pizza.id}-${pizza.id}-${this.estadoSelecao.tamanhoSelecionado}`,
                nome: `Pizza Meio a Meio: ${this.estadoSelecao.primeiroSabor.pizza.nome} / ${pizza.nome}`,
                tipo: 'pizza',
                subtipo: 'meio_a_meio',
                tamanho: this.estadoSelecao.tamanhoSelecionado,
                preco: precoFinal,
                quantidade: 1,
                observacoes: this.estadoSelecao.observacoes,
                primeiroSabor: this.estadoSelecao.primeiroSabor.pizza,
                segundoSabor: pizza
            };
            
            this.carrinho.push(itemCarrinho);
            this.voltarInterfaceNormal();
        },
        
        // NOVO: Cancelar meio a meio
        cancelarMeioAMeio() {
            this.voltarInterfaceNormal();
        },
        
        // NOVO: Trocar primeiro sabor
        trocarPrimeiroSabor() {
            // Volta ao modo normal para selecionar outro primeiro sabor
            this.voltarInterfaceNormal();
        },
        
        // NOVO: Voltar √† interface normal
        voltarInterfaceNormal() {
            this.estadoSelecao = {
                modo: 'normal',
                primeiroSabor: null,
                tamanhoSelecionado: null,
                precoFinal: 0,
                observacoes: ''
            };
        },
        
        fecharModalPizza() {
            this.modalPizza = {
                aberto: false,
                pizza: null,
                tamanho: '',
                preco: 0,
                tipo: 'inteira',
                segundoSabor: '',
                precoSegundoSabor: 0,
                precoTotal: 0,
                observacoes: ''
            };
        },
        
        calcularPrecoMeioAMeio() {
            if (!this.modalPizza.segundoSabor || !this.modalPizza.pizza) {
                this.modalPizza.precoSegundoSabor = 0;
                this.modalPizza.precoTotal = this.modalPizza.preco;
                return;
            }
            
            const segundaPizza = this.pizzasFiltradas.find(p => p.id == this.modalPizza.segundoSabor);
            if (segundaPizza) {
                const precoSegundo = this.obterPrecoTamanhoNumerico(segundaPizza, this.modalPizza.tamanho);
                this.modalPizza.precoSegundoSabor = precoSegundo;
                // Pre√ßo da pizza meio a meio √© o valor do sabor mais caro
                this.modalPizza.precoTotal = Math.max(this.modalPizza.preco, precoSegundo);
            }
        },
        
        adicionarPizzaAoCarrinho() {
            if (this.modalPizza.tipo === 'meio_a_meio' && !this.modalPizza.segundoSabor) {
                return;
            }
            
            let nome = `Pizza ${this.modalPizza.pizza.nome}`;
            let ingredientes = this.modalPizza.pizza.ingredientes;
            
            if (this.modalPizza.tipo === 'meio_a_meio') {
                const segundaPizza = this.pizzasFiltradas.find(p => p.id == this.modalPizza.segundoSabor);
                nome = `Pizza Meio a Meio: ${this.modalPizza.pizza.nome} / ${segundaPizza.nome}`;
                ingredientes = `${this.modalPizza.pizza.ingredientes} | ${segundaPizza.ingredientes}`;
            }
            
            const item = {
                id: `pizza-${this.modalPizza.pizza.id}-${this.modalPizza.tamanho}-${this.modalPizza.tipo}-${this.modalPizza.segundoSabor || 'none'}`,
                produto_id: this.modalPizza.pizza.id,
                nome: nome,
                tipo: 'pizza',
                subtipo: this.modalPizza.tipo,
                tamanho: this.modalPizza.tamanho,
                preco: this.modalPizza.precoTotal,
                ingredientes: ingredientes,
                observacoes: this.modalPizza.observacoes,
                segundoSabor: this.modalPizza.segundoSabor,
                quantidade: 1
            };
            
            // Verificar se j√° existe no carrinho (mesmo item)
            const itemExistente = this.carrinho.find(i => i.id === item.id);
            
            if (itemExistente) {
                itemExistente.quantidade++;
            } else {
                this.carrinho.push(item);
            }
            
            this.calcularTotais();
            this.fecharModalPizza();
            
            // Feedback visual
            this.mostrarNotificacao('Pizza adicionada ao carrinho!', 'success');
        },
        
        mostrarNotificacao(mensagem, tipo = 'info') {
            // Implementa√ß√£o simples de notifica√ß√£o
            // Aqui voc√™ pode implementar uma notifica√ß√£o visual mais elaborada
        },
        
        // Valida√ß√£o individual de campos
        validarCampo(campo) {
            this.erros[campo] = '';
            
            switch(campo) {
                case 'nome':
                    if (!this.cliente.nome.trim()) {
                        this.erros.nome = 'Nome √© obrigat√≥rio';
                    } else if (this.cliente.nome.trim().length < 3) {
                        this.erros.nome = 'Nome deve ter pelo menos 3 caracteres';
                    }
                    break;
                    
                case 'telefone':
                    const telefoneNumeros = this.cliente.telefone.replace(/\D/g, '');
                    if (!telefoneNumeros) {
                        this.erros.telefone = 'Telefone √© obrigat√≥rio';
                    } else if (telefoneNumeros.length < 10) {
                        this.erros.telefone = 'Telefone deve ter pelo menos 10 d√≠gitos';
                    }
                    break;
                    
                case 'endereco':
                    if (this.tipoPedido === 'delivery' && !this.endereco.trim()) {
                        this.erros.endereco = 'Endere√ßo √© obrigat√≥rio para delivery';
                    }
                    break;
                    
                case 'numeroMesa':
                    if (this.tipoPedido === 'mesa' && !this.numeroMesa.trim()) {
                        this.erros.numeroMesa = 'N√∫mero da mesa √© obrigat√≥rio';
                    }
                    break;
            }
        },
        
        // Formata√ß√£o de telefone
        formatarTelefone() {
            let value = this.cliente.telefone.replace(/\D/g, '');
            if (value.length > 0) {
                if (value.length <= 10) {
                    value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                } else {
                    value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                }
            }
            this.cliente.telefone = value;
        },
        
        // Gerenciamento de forma de pagamento
        selecionarFormaPagamento(forma) {
            this.formaPagamento = forma;
            // Limpar erro de valida√ß√£o
            if (this.erros.formaPagamento) {
                delete this.erros.formaPagamento;
            }
            // Reset troco se n√£o for dinheiro
            if (forma !== 'dinheiro') {
                this.trocoPara = 0;
                this.trocoCalculado = 0;
                if (this.erros.troco) {
                    delete this.erros.troco;
                }
            }
        },
        
        // C√°lculo de troco
        calcularTroco() {
            if (this.formaPagamento === 'dinheiro' && this.trocoPara > 0) {
                this.trocoCalculado = Math.max(0, this.trocoPara - this.total);
            } else {
                this.trocoCalculado = 0;
            }
        },
        
        // Valida√ß√£o do troco
        validarTroco() {
            if (this.formaPagamento === 'dinheiro' && this.trocoPara > 0) {
                if (this.trocoPara < this.total) {
                    this.erros.troco = `Valor insuficiente. Total do pedido: R$ ${this.total.toFixed(2)}`;
                    return false;
                } else {
                    delete this.erros.troco;
                }
            }
            return true;
        },
        
        // Gerenciamento da taxa de entrega
        abrirEdicaoTaxa() {
            this.editandoTaxa = true;
        },
        
        fecharEdicaoTaxa() {
            this.editandoTaxa = false;
            this.taxaPersonalizada = false;
        },
        
        selecionarTaxaPreDefinida(taxa) {
            this.taxaEntrega = taxa.valor;
            this.taxaPersonalizada = false;
            this.taxaCustomizada = 0.00;
            this.fecharEdicaoTaxa();
        },
        
        habilitarTaxaPersonalizada() {
            this.taxaPersonalizada = true;
            this.taxaCustomizada = this.taxaEntrega;
        },
        
        aplicarTaxaPersonalizada() {
            if (this.taxaCustomizada >= 0) {
                this.taxaEntrega = parseFloat(this.taxaCustomizada);
                this.fecharEdicaoTaxa();
            }
        },
        
        // Gerenciamento do carrinho
        adicionarPizza(pizza) {
            const tamanhoSelecionado = this.pizzaSelecionada[pizza.id];
            if (!tamanhoSelecionado) return;
            
            const tamanho = pizza.tamanhos.find(t => t.size === tamanhoSelecionado);
            const item = {
                id: `pizza-${pizza.id}-${tamanho.size}`, // ID √∫nico para pizza + tamanho
                produto_id: pizza.id,
                nome: `Pizza ${pizza.nome}`,
                tipo: 'pizza',
                tamanho: tamanho.size,
                preco: tamanho.preco,
                ingredientes: pizza.ingredientes,
                quantidade: 1
            };
            
            // Verificar se j√° existe no carrinho (mesma pizza e tamanho)
            const itemExistente = this.carrinho.find(i => i.id === item.id);
            
            if (itemExistente) {
                itemExistente.quantidade++;
            } else {
                this.carrinho.push(item);
            }
            
            // Feedback visual
            this.pizzaAdicionada[pizza.id] = true;
            
            // Limpar sele√ß√£o ap√≥s 2 segundos
            setTimeout(() => {
                this.pizzaSelecionada[pizza.id] = '';
                this.pizzaAdicionada[pizza.id] = false;
            }, 2000);
            
            this.calcularTotais();
        },
        
        // Fun√ß√£o auxiliar para obter pre√ßo do tamanho (string formatada)
        obterPrecoTamanho(pizza, tamanho) {
            if (!tamanho || !pizza.tamanhos) return null;
            const tamanhoObj = pizza.tamanhos.find(t => t.size === tamanho);
            return tamanhoObj ? tamanhoObj.preco.toFixed(2) : null;
        },
        
        // Fun√ß√£o auxiliar para obter pre√ßo do tamanho (num√©rico)
        obterPrecoTamanhoNumerico(pizza, tamanho) {
            if (!tamanho || !pizza.tamanhos) return 0;
            const tamanhoObj = pizza.tamanhos.find(t => t.size === tamanho);
            return tamanhoObj ? tamanhoObj.preco : 0;
        },
        
        adicionarItem(produto, tipo) {
            const item = {
                id: `${tipo}-${produto.id}`, // ID √∫nico para n√£o-pizzas
                produto_id: produto.id,
                nome: produto.nome,
                tipo: tipo,
                preco: produto.preco,
                quantidade: 1
            };
            
            // Verificar se j√° existe no carrinho
            const itemExistente = this.carrinho.find(i => i.id === item.id);
            
            if (itemExistente) {
                itemExistente.quantidade++;
            } else {
                this.carrinho.push(item);
            }
            
            this.calcularTotais();
        },
        
        aumentarQuantidade(index) {
            this.carrinho[index].quantidade++;
            this.calcularTotais();
        },
        
        diminuirQuantidade(index) {
            if (this.carrinho[index].quantidade > 1) {
                this.carrinho[index].quantidade--;
                this.calcularTotais();
            }
        },
        
        removerItem(index) {
            this.carrinho.splice(index, 1);
            this.calcularTotais();
        },
        
        calcularTotais() {
            // For√ßar reatividade
            this.$nextTick(() => {
                // Os computed properties j√° fazem o c√°lculo
            });
        },
        
        // Valida√ß√£o completa do formul√°rio
        validarFormulario() {
            this.errosGlobais = [];
            
            // Validar todos os campos
            this.validarCampo('nome');
            this.validarCampo('telefone');
            
            if (this.tipoPedido === 'delivery') {
                this.validarCampo('endereco');
                if (this.subtotal < this.pedidoMinimo) {
                    this.errosGlobais.push(`Pedido m√≠nimo para delivery: R$ ${this.pedidoMinimo.toFixed(2)}`);
                }
            } else if (this.tipoPedido === 'mesa') {
                this.validarCampo('numeroMesa');
            }
            
            // Verificar carrinho
            if (this.carrinho.length === 0) {
                this.errosGlobais.push('Adicione pelo menos um produto ao carrinho');
            }
            
            // Validar forma de pagamento
            if (!this.formaPagamento) {
                this.erros.formaPagamento = 'Selecione uma forma de pagamento';
            }
            
            // Validar troco se forma de pagamento for dinheiro
            if (this.formaPagamento === 'dinheiro' && this.trocoPara > 0) {
                this.validarTroco();
            }
            
            // Coletar erros
            Object.values(this.erros).forEach(erro => {
                if (erro) this.errosGlobais.push(erro);
            });
            
            return this.errosGlobais.length === 0;
        },
        
        
        // Imprimir comanda para cozinha
        imprimirComanda() {
            // Filtrar apenas pizzas para impress√£o
            const pizzasParaImprimir = this.carrinho.filter(item => item.tipo === 'pizza');
            
            if (pizzasParaImprimir.length === 0) {
                alert('Nenhuma pizza no carrinho para imprimir comanda.');
                return;
            }
            
            // Preparar dados da comanda
            const dadosComanda = {
                numero: `COMANDA-${Date.now()}`,
                horario: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                cliente: this.cliente.nome || 'Cliente n√£o informado',
                tipoPedido: this.tipoPedido,
                mesa: this.numeroMesa,
                endereco: this.endereco,
                pizzas: pizzasParaImprimir
            };
            
            // Abrir nova janela para impress√£o
            const janelaImpressao = window.open('', '_blank', 'width=800,height=600');
            janelaImpressao.document.write(this.gerarHTMLComanda(dadosComanda));
            janelaImpressao.document.close();
            
            // Aguardar carregamento e imprimir
            janelaImpressao.onload = function() {
                janelaImpressao.print();
            };
        },
        
        // Mapear tamanhos para abrevia√ß√µes padr√£o da ind√∫stria
        getTamanhoAbrev(tamanho) {
            const mapeamento = {
                'pequena': 'P',
                'broto': 'B', 
                'm√©dia': 'M',
                'media': 'M',
                'grande': 'G',
                'fam√≠lia': 'F',
                'familia': 'F'
            };
            return mapeamento[tamanho.toLowerCase()] || tamanho.charAt(0).toUpperCase();
        },
        
        // Obter ingredientes principais da pizza (mockup - em produ√ß√£o viria do banco)
        getIngredientesPizza(nomePizza) {
            const ingredientes = {
                'camar√£o premium': 'Molho branco, mussarela, camar√µes grandes, alho',
                'calabresa': 'Molho, mussarela, calabresa',
                'margherita': 'Molho, mussarela, tomate, manjeric√£o',
                'portuguesa': 'Molho, mussarela, presunto, ovos, cebola, azeitona',
                'bacon': 'Molho, mussarela, bacon',
                'frango': 'Molho, mussarela, frango desfiado',
                'quatro queijos': 'Molho branco, mussarela, gorgonzola, parmes√£o, provolone'
            };
            
            const nome = nomePizza.toLowerCase()
                .replace('pizza ', '')
                .replace(/\s+/g, ' ')
                .trim();
            
            return ingredientes[nome] || '';
        },
        
        // Quebrar texto em linhas para impressora t√©rmica
        quebrarTexto(texto, larguraMaxima = 32) {
            if (!texto || texto.length <= larguraMaxima) return texto;
            
            const palavras = texto.split(' ');
            const linhas = [];
            let linhaAtual = '';
            
            palavras.forEach(palavra => {
                if ((linhaAtual + palavra).length <= larguraMaxima) {
                    linhaAtual += (linhaAtual ? ' ' : '') + palavra;
                } else {
                    if (linhaAtual) linhas.push(linhaAtual);
                    linhaAtual = palavra;
                }
            });
            
            if (linhaAtual) linhas.push(linhaAtual);
            return linhas.join('\n');
        },
        
        // Gerar HTML da comanda para impress√£o (formato otimizado para pizzaiolo)
        gerarHTMLComanda(dados) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Comanda - ${dados.numero}</title>
                    <style>
                        body { 
                            font-family: 'Courier New', monospace; 
                            margin: 10px; 
                            background: white; 
                            font-size: 12px;
                            line-height: 1.3;
                        }
                        .header { 
                            text-align: center; 
                            border-bottom: 1px solid #000; 
                            padding-bottom: 8px; 
                            margin-bottom: 12px; 
                        }
                        .separador {
                            border-top: 1px solid #000;
                            margin: 8px 0;
                            line-height: 1px;
                        }
                        .separador-duplo {
                            border-top: 2px solid #000;
                            margin: 10px 0;
                            line-height: 1px;
                        }
                        .info { margin-bottom: 12px; }
                        .pizzas { margin-bottom: 12px; }
                        .pizza-item { 
                            margin-bottom: 8px; 
                            padding: 4px 0; 
                            border-left: 2px solid #DC2626; 
                            padding-left: 6px;
                        }
                        .pizza-nome { 
                            font-weight: bold; 
                            font-size: 13px; 
                            margin-bottom: 2px;
                        }
                        .pizza-ingredientes { 
                            font-size: 10px; 
                            color: #333; 
                            white-space: pre-line;
                            margin-bottom: 2px;
                        }
                        .pizza-obs { 
                            font-size: 10px; 
                            font-style: italic; 
                            color: #666;
                        }
                        .footer { 
                            text-align: center; 
                            border-top: 2px solid #000; 
                            padding-top: 8px; 
                            margin-top: 15px; 
                            font-weight: bold;
                        }
                        @media print { 
                            body { margin: 0; font-size: 11px; } 
                            .header h2 { font-size: 14px; margin: 5px 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>üçï COMANDA COZINHA</h2>
                        <div>${dados.numero}</div>
                        <div>${dados.horario}</div>
                    </div>
                    <div class="separador-duplo"></div>
                    
                    <div class="info">
                        <div><strong>Cliente:</strong> ${dados.cliente}</div>
                        <div><strong>Tipo:</strong> ${dados.tipoPedido === 'delivery' ? 'Entrega' : dados.tipoPedido === 'mesa' ? 'Mesa ' + dados.mesa : 'Retirada'}</div>
                        ${dados.tipoPedido === 'delivery' && dados.endereco ? '<div><strong>Endere√ßo:</strong> ' + this.quebrarTexto(dados.endereco, 25) + '</div>' : ''}
                    </div>
                    
                    <div class="pizzas">
                        <h3>üçï PIZZAS (${dados.pizzas.length}):</h3>
                        <div class="separador"></div>
                        ${dados.pizzas.map(pizza => {
                            const tamanhoAbrev = this.getTamanhoAbrev(pizza.tamanho || '');
                            const nomeFormatado = pizza.nome.toUpperCase()
                                .replace('PIZZA ', '')
                                .substring(0, 25); // Limitar nome para impressora
                            const ingredientes = this.getIngredientesPizza(pizza.nome);
                            const ingredientesQuebrados = ingredientes ? this.quebrarTexto(ingredientes, 30) : '';
                            
                            return `
                            <div class="pizza-item">
                                <div class="pizza-nome">${tamanhoAbrev} ${nomeFormatado}</div>
                                ${ingredientesQuebrados ? '<div class="pizza-ingredientes">' + ingredientesQuebrados + '</div>' : ''}
                                ${pizza.observacoes ? '<div class="pizza-obs">OBS: ' + this.quebrarTexto(pizza.observacoes, 28) + '</div>' : ''}
                            </div>
                        `;
                        }).join('')}
                    </div>
                    <div class="separador-duplo"></div>
                    
                    <div class="footer">
                        <div>‚ö†Ô∏è TOTAL: ${dados.pizzas.length} PIZZA${dados.pizzas.length > 1 ? 'S' : ''}</div>
                        <div>Hor√°rio: ${dados.horario}</div>
                    </div>
                </body>
                </html>
            `;
        },
        
        
        // Finalizar pedido
        finalizarPedido() {
            console.log('üöÄ finalizarPedido() chamado');
            console.log('üìã Estado atual:', {
                cliente: this.cliente,
                tipoPedido: this.tipoPedido,
                carrinho: this.carrinho,
                formularioValido: this.formularioValido
            });
            
            if (this.validarFormulario()) {
                console.log('‚úÖ Formul√°rio v√°lido, prosseguindo...');
                
                // Verificar se carrinho n√£o est√° vazio
                if (!this.carrinho || this.carrinho.length === 0) {
                    alert('‚ùå Carrinho est√° vazio! Adicione pelo menos um produto.');
                    return;
                }
                
                console.log('üõí Carrinho atual:', this.carrinho);
                
                // Preparar dados para envio
                let dados;
                try {
                    dados = {
                    cliente: {
                        nome: this.cliente.nome,
                        telefone: this.cliente.telefone.replace(/\D/g, '')  // Remove caracteres n√£o-num√©ricos
                    },
                    tipo: this.tipoPedido,
                    endereco: this.tipoPedido === 'delivery' ? this.endereco : '',
                    numero_mesa: this.tipoPedido === 'mesa' ? this.numeroMesa : '',
                    forma_pagamento: this.formaPagamento,
                    precisa_troco: this.formaPagamento === 'dinheiro' && this.trocoPara > 0,
                    troco_para: this.formaPagamento === 'dinheiro' ? this.trocoPara : null,
                    itens: this.carrinho.map(item => {
                        console.log('üîç Processando item do carrinho:', item);
                        
                        // Verificar se item tem estrutura v√°lida
                        if (!item) {
                            console.error('‚ùå Item do carrinho √© null/undefined:', item);
                            throw new Error('Item do carrinho inv√°lido');
                        }
                        
                        // Extrair ID do produto com fallbacks (ordem corrigida)
                        let produtoId = null;
                        if (item.produto_id) {
                            produtoId = item.produto_id;
                        } else if (item.produto && item.produto.id) {
                            produtoId = item.produto.id;
                        } else if (item.id) {
                            produtoId = item.id;
                        }
                        
                        console.log('üîç Tentativas de extra√ß√£o:', {
                            'item.produto_id': item.produto_id,
                            'item.produto?.id': item.produto?.id,
                            'item.id': item.id,
                            'produtoId final': produtoId
                        });
                        
                        if (!produtoId || produtoId === null || produtoId === undefined) {
                            console.error('‚ùå N√£o foi poss√≠vel encontrar ID do produto:', item);
                            throw new Error(`ID do produto n√£o encontrado para item: ${item.nome || 'sem nome'}`);
                        }
                        
                        // Garantir que seja um n√∫mero v√°lido
                        const produtoIdNum = parseInt(produtoId);
                        if (isNaN(produtoIdNum) || produtoIdNum <= 0) {
                            console.error('‚ùå ID do produto inv√°lido:', produtoId);
                            throw new Error(`ID do produto inv√°lido: ${produtoId}`);
                        }
                        
                        const itemPedido = {
                            produto_id: produtoIdNum,
                            quantidade: parseInt(item.quantidade || 1),
                            preco_unitario: parseFloat(item.preco_unitario || item.preco || 0),
                            observacoes: String(item.observacoes || '')
                        };
                        
                        console.log('‚úÖ Item processado:', itemPedido);
                        return itemPedido;
                    }),
                    subtotal: parseFloat(this.subtotal || 0),
                    taxa_entrega: this.tipoPedido === 'delivery' ? parseFloat(this.taxaEntrega || 0) : 0,
                    total: parseFloat(this.total || 0),
                    forma_pagamento: 'dinheiro'  // Valor padr√£o por enquanto
                    };
                    
                    // Verifica√ß√£o final dos dados
                    console.log('üîç Verifica√ß√£o final dos itens:');
                    dados.itens.forEach((item, index) => {
                        console.log(`Item ${index + 1}:`, item);
                        if (!item.produto_id || item.produto_id === null) {
                            throw new Error(`Item ${index + 1} sem produto_id v√°lido`);
                        }
                    });
                    
                } catch (error) {
                    console.error('‚ùå Erro ao preparar dados do pedido:', error);
                    alert(`‚ùå Erro ao processar dados do carrinho: ${error.message}`);
                    return;
                }
                
                // Mostrar loading
                console.log('Iniciando cria√ß√£o do pedido...', dados);
                console.log('üì¶ Dados JSON que ser√£o enviados:', JSON.stringify(dados, null, 2));
                
                // Enviar para API
                fetch('/api/pedidos/pedidos/criar_pedido_seguro/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(dados)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Resposta da API:', data);
                    if (data.status === 'success') {
                        alert(`‚úÖ Pedido #${data.pedido.numero} criado com sucesso!\nTotal: R$ ${data.pedido.total.toFixed(2)}`);
                        
                        // Aguardar um pouco antes de redirecionar
                        setTimeout(() => {
                            window.location.href = "{% url 'pedidos:pedido_list' %}";
                        }, 1500);
                    } else {
                        console.error('Erro ao criar pedido:', data);
                        console.log('üìã Dados enviados que causaram erro:', dados);
                        
                        // Mostrar erros espec√≠ficos
                        if (data.erros && data.erros.length > 0) {
                            console.error('‚ùå Erros de valida√ß√£o:', data.erros);
                            const errosTexto = data.erros.join('\n');
                            alert('‚ùå Erros de valida√ß√£o encontrados:\n\n' + errosTexto);
                        } else {
                            alert(data.message || 'Erro ao criar pedido. Tente novamente.');
                        }
                    }
                })
                .catch(error => {
                    console.error('Erro na requisi√ß√£o:', error);
                    alert('Erro de conex√£o. Verifique sua internet e tente novamente.');
                });
            } else {
                console.log('‚ùå Formul√°rio inv√°lido!');
                console.log('Erros encontrados:');
                
                // Verificar campos vazios
                if (!this.cliente.nome) console.log('- Nome do cliente vazio');
                if (!this.cliente.telefone) console.log('- Telefone do cliente vazio');
                if (this.carrinho.length === 0) console.log('- Carrinho vazio');
                if (this.tipoPedido === 'delivery' && !this.endereco) console.log('- Endere√ßo de entrega vazio');
                if (this.tipoPedido === 'mesa' && !this.numeroMesa) console.log('- N√∫mero da mesa vazio');
                
                // Focar no primeiro erro
                const primeiroErro = document.querySelector('.campo-invalido');
                if (primeiroErro) {
                    primeiroErro.focus();
                    primeiroErro.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    alert('Por favor, preencha todos os campos obrigat√≥rios antes de finalizar o pedido.');
                }
            }
        }
    }
}
</script>
{% endblock %}